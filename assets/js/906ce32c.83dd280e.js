"use strict";(self.webpackChunkq_01_docs=self.webpackChunkq_01_docs||[]).push([[6432],{7632:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>c});var t=s(7624),r=s(2172);const i={title:"Outbox Pattern",sidebar_label:"10. Outbox Pattern",sidebar_position:11,description:"Write-ahead log pattern ensuring at-least-once delivery and eventual consistency across distributed systems"},l="Outbox Pattern",a={id:"products/map.q01.io/core-api-platform-v4/core-concepts/outbox-pattern",title:"Outbox Pattern",description:"Write-ahead log pattern ensuring at-least-once delivery and eventual consistency across distributed systems",source:"@site/docs/products/map.q01.io/core-api-platform-v4/01-core-concepts/outbox-pattern.md",sourceDirName:"products/map.q01.io/core-api-platform-v4/01-core-concepts",slug:"/products/map.q01.io/core-api-platform-v4/core-concepts/outbox-pattern",permalink:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/outbox-pattern",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:11,frontMatter:{title:"Outbox Pattern",sidebar_label:"10. Outbox Pattern",sidebar_position:11,description:"Write-ahead log pattern ensuring at-least-once delivery and eventual consistency across distributed systems"},sidebar:"mapSidebar",previous:{title:"9. Cascade Operations",permalink:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/cascades"},next:{title:"11. Pre-Insert Functions",permalink:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/pre-insert-functions"}},o={},c=[{value:"What is the Outbox Pattern?",id:"what-is-the-outbox-pattern",level:2},{value:"Why the Outbox Pattern Matters",id:"why-the-outbox-pattern-matters",level:2},{value:"The Dual-Write Problem",id:"the-dual-write-problem",level:3},{value:"Outbox Pattern Solution",id:"outbox-pattern-solution",level:3},{value:"TB_ANAG_OUTBOX00 Structure",id:"tb_anag_outbox00-structure",level:2},{value:"Table Schema",id:"table-schema",level:3},{value:"Key Fields Explained",id:"key-fields-explained",level:3},{value:"Event ID Generation",id:"event-id-generation",level:2},{value:"Outbox Write Operations",id:"outbox-write-operations",level:2},{value:"CREATE Operation",id:"create-operation",level:3},{value:"UPDATE Operation",id:"update-operation",level:3},{value:"DELETE Operation (Soft Delete)",id:"delete-operation-soft-delete",level:3},{value:"RabbitMQ Fanout Exchange",id:"rabbitmq-fanout-exchange",level:2},{value:"Exchange Naming Convention",id:"exchange-naming-convention",level:3},{value:"Publishing to Exchange",id:"publishing-to-exchange",level:3},{value:"Fanout Exchange Behavior",id:"fanout-exchange-behavior",level:3},{value:"At-Least-Once Delivery",id:"at-least-once-delivery",level:2},{value:"Guarantee Mechanism",id:"guarantee-mechanism",level:3},{value:"Retry Logic",id:"retry-logic",level:3},{value:"Idempotency and Deduplication",id:"idempotency-and-deduplication",level:2},{value:"Consumer Responsibility",id:"consumer-responsibility",level:3},{value:"Multi-Tenant Isolation",id:"multi-tenant-isolation",level:2},{value:"Outbox Cleanup",id:"outbox-cleanup",level:2},{value:"Enabling/Disabling Outbox",id:"enablingdisabling-outbox",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"\u2705 DO: Let CoreWrite Manage Outbox",id:"-do-let-corewrite-manage-outbox",level:3},{value:"\u2705 DO: Implement Idempotent Consumers",id:"-do-implement-idempotent-consumers",level:3},{value:"\u2705 DO: Use Event Sourcing for Replay",id:"-do-use-event-sourcing-for-replay",level:3},{value:"\u2705 DO: Monitor Outbox Lag",id:"-do-monitor-outbox-lag",level:3},{value:"\u274c DON&#39;T: Bypass Outbox Pattern",id:"-dont-bypass-outbox-pattern",level:3},{value:"\u274c DON&#39;T: Assume Exactly-Once Delivery",id:"-dont-assume-exactly-once-delivery",level:3},{value:"\u274c DON&#39;T: Purge Outbox Too Aggressively",id:"-dont-purge-outbox-too-aggressively",level:3},{value:"Common Pitfalls",id:"common-pitfalls",level:2},{value:"Pitfall 1: Not Handling Duplicate Events",id:"pitfall-1-not-handling-duplicate-events",level:3},{value:"Pitfall 2: Ignoring Retry Count",id:"pitfall-2-ignoring-retry-count",level:3},{value:"Pitfall 3: Relying on Event Order",id:"pitfall-3-relying-on-event-order",level:3},{value:"Summary",id:"summary",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.M)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"outbox-pattern",children:"Outbox Pattern"}),"\n",(0,t.jsx)(n.h2,{id:"what-is-the-outbox-pattern",children:"What is the Outbox Pattern?"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.strong,{children:"Outbox Pattern"})," is a write-ahead log mechanism that guarantees ",(0,t.jsx)(n.strong,{children:"at-least-once delivery"})," of data change events to distributed systems, even if message brokers fail during transactions."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Key Insight:"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["Every write operation (create, update, delete) in CoreWrite first writes to ",(0,t.jsx)(n.strong,{children:"TB_ANAG_OUTBOX00"})," in the same ACID transaction as the data change. A separate relay process publishes outbox entries to RabbitMQ fanout exchanges."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["This ensures ",(0,t.jsx)(n.strong,{children:"no event is lost"})," and ",(0,t.jsx)(n.strong,{children:"eventual consistency"})," across microservices."]}),"\n",(0,t.jsx)(n.h2,{id:"why-the-outbox-pattern-matters",children:"Why the Outbox Pattern Matters"}),"\n",(0,t.jsx)(n.h3,{id:"the-dual-write-problem",children:"The Dual-Write Problem"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Naive approach (fails):"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"// Step 1: Write to database\nINSERT INTO TB_ANAG_PRD00 (...) VALUES (...);\n\n// Step 2: Publish to RabbitMQ\n$channel->basic_publish($msg, 'product.exchange');\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Problem:"})," If RabbitMQ is down or network fails after Step 1, event is ",(0,t.jsx)(n.strong,{children:"lost"})," - no retry, no recovery."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Consequences:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u274c Search service never indexes new product"}),"\n",(0,t.jsx)(n.li,{children:"\u274c Analytics never receive event"}),"\n",(0,t.jsx)(n.li,{children:"\u274c Cache never invalidates"}),"\n",(0,t.jsx)(n.li,{children:"\u274c Data inconsistency across microservices"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"outbox-pattern-solution",children:"Outbox Pattern Solution"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Reliable approach (Q01 Core APIs):"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"$this->db_data->beginTransaction();\n\n// Step 1: Write to database\nINSERT INTO TB_ANAG_PRD00 (...) VALUES (...);\n\n// Step 2: Write to outbox (SAME transaction)\nINSERT INTO TB_ANAG_OUTBOX00 (\n  XOUTBOX04,  -- Dimension (PRD)\n  XOUTBOX05,  -- Operation (create)\n  XOUTBOX06   -- Data (JSON)\n) VALUES ('PRD', 'create', '{\"PRD_ID\": \"123\", ...}');\n\n$this->db_data->commit();\n\n// Step 3: Separate relay process publishes from outbox\n// If RabbitMQ is down, outbox entry remains until published\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Guarantees:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Atomic write"})," - Data + outbox entry in single transaction"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"At-least-once delivery"})," - Relay retries until acknowledged"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"No event loss"})," - Outbox persists until successfully published"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Eventual consistency"})," - All subscribers eventually receive event"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"tb_anag_outbox00-structure",children:"TB_ANAG_OUTBOX00 Structure"}),"\n",(0,t.jsx)(n.h3,{id:"table-schema",children:"Table Schema"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE TB_ANAG_OUTBOX00 (\n  OUTBOX_ID INT PRIMARY KEY AUTO_INCREMENT,\n\n  -- Standard audit fields\n  OWNER VARCHAR(50),\n  CDATA VARCHAR(14),\n  LOWNER VARCHAR(50),\n  LDATA VARCHAR(14),\n  TIMESTAMP BIGINT,\n  TREC CHAR(1) DEFAULT 'N',\n\n  -- Outbox payload fields\n  XOUTBOX01 VARCHAR(255),   -- Ambiente (tenant isolation)\n  XOUTBOX02 VARCHAR(255),   -- Ambiente riferimento\n  XOUTBOX03 VARCHAR(64),    -- Event ID (SHA1 hash)\n  XOUTBOX04 VARCHAR(50),    -- Aggregate (dimension code: PRD, ORD, etc.)\n  XOUTBOX05 VARCHAR(50),    -- Operation (create, update, delete, logicalDelete)\n  XOUTBOX06 TEXT,           -- Data (JSON payload)\n  XOUTBOX07 TEXT,           -- Reserved\n  XOUTBOX08 INT DEFAULT 0,  -- Retry count\n  XOUTBOX09 VARCHAR(255),   -- Tenant ID\n  XOUTBOX10 INT DEFAULT 0,  -- Published flag (0=pending, 1=published)\n  XOUTBOX11 VARCHAR(100),   -- Microservice\n  XOUTBOX12 VARCHAR(255),   -- Tenant ID (duplicate for indexing)\n  XOUTBOX13 VARCHAR(255)    -- Resource\n);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"key-fields-explained",children:"Key Fields Explained"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Field"}),(0,t.jsx)(n.th,{children:"Purpose"}),(0,t.jsx)(n.th,{children:"Example"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"XOUTBOX03"})}),(0,t.jsx)(n.td,{children:"Unique event ID (SHA1)"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:'"a7f3c2b1..."'})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"XOUTBOX04"})}),(0,t.jsx)(n.td,{children:"Dimension (aggregate root)"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:'"PRD"'}),", ",(0,t.jsx)(n.code,{children:'"ORD"'}),", ",(0,t.jsx)(n.code,{children:'"CLI"'})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"XOUTBOX05"})}),(0,t.jsx)(n.td,{children:"Operation type"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:'"create"'}),", ",(0,t.jsx)(n.code,{children:'"update"'}),", ",(0,t.jsx)(n.code,{children:'"delete"'}),", ",(0,t.jsx)(n.code,{children:'"logicalDelete"'})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"XOUTBOX06"})}),(0,t.jsx)(n.td,{children:"Event data (JSON)"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:'{"PRD_ID": "123", "XPRD01": "Widget"}'})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"XOUTBOX08"})}),(0,t.jsx)(n.td,{children:"Retry counter"}),(0,t.jsx)(n.td,{children:"Incremented on publish failure"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"XOUTBOX10"})}),(0,t.jsx)(n.td,{children:"Published flag"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"0"})," = pending, ",(0,t.jsx)(n.code,{children:"1"})," = published"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"XOUTBOX09"})}),(0,t.jsx)(n.td,{children:"Tenant ID"}),(0,t.jsx)(n.td,{children:"For multi-tenant isolation"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"XOUTBOX11"})}),(0,t.jsx)(n.td,{children:"Microservice"}),(0,t.jsx)(n.td,{children:"Source microservice identifier"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"event-id-generation",children:"Event ID Generation"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Unique Event ID (XOUTBOX03):"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:'$nowSha = sha1(str_replace(".", "", microtime(true)));\n$tenantSha = sha1($this->session["tenantId"]);\n$msSha = sha1($this->session->get("current_microservice"));\n$ID = sha1($tenantSha . "." . $msSha . "." . $nowSha);\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Components:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Tenant ID hash"}),"\n",(0,t.jsx)(n.li,{children:"Microservice hash"}),"\n",(0,t.jsx)(n.li,{children:"Microsecond timestamp hash"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Result:"})," Globally unique event ID preventing duplicates."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Code Reference:"})," ",(0,t.jsx)(n.code,{children:"DataStore.php:3046-3049"})]}),"\n",(0,t.jsx)(n.h2,{id:"outbox-write-operations",children:"Outbox Write Operations"}),"\n",(0,t.jsx)(n.h3,{id:"create-operation",children:"CREATE Operation"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Request:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-http",children:'POST /api/v4/core/PRD\n{\n  "XPRD01": "Premium Widget",\n  "XPRD02": 49.99,\n  "source": "productCreate"\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Transaction:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"BEGIN;\n\n-- 1. Insert product\nINSERT INTO TB_ANAG_PRD00 (XPRD01, XPRD02, OWNER, CDATA, LOWNER, LDATA, TREC)\nVALUES ('Premium Widget', 49.99, 'user_5', '20250119120000', 'user_5', '20250119120000', 'N');\n\n-- Returns PRD_ID = 123\n\n-- 2. Insert outbox entry (SAME transaction)\nINSERT INTO TB_ANAG_OUTBOX00 (\n  OWNER, CDATA, LOWNER, LDATA, TIMESTAMP, TREC,\n  XOUTBOX01, XOUTBOX02, XOUTBOX03, XOUTBOX04, XOUTBOX05,\n  XOUTBOX06, XOUTBOX07, XOUTBOX08, XOUTBOX09, XOUTBOX10,\n  XOUTBOX11, XOUTBOX12, XOUTBOX13\n) VALUES (\n  'user_5', '20250119120000', 'user_5', '20250119120000', '1737283200000000', 'N',\n  'tenant_123', 'tenant_123_ref', 'a7f3c2b1...', 'PRD', 'create',\n  '{\"PRD_ID\":\"123\",\"XPRD01\":\"Premium Widget\",\"XPRD02\":49.99}', '', 0, 'tenant_123', 0,\n  'corewrite', 'tenant_123', 'production'\n);\n\nCOMMIT;\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Result:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Product created with PRD_ID=123"}),"\n",(0,t.jsx)(n.li,{children:"Outbox entry created with XOUTBOX10=0 (pending publish)"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Code Reference:"})," ",(0,t.jsx)(n.code,{children:"DataStore.php:1403"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"list($outboxArr, $outboxID, $commitTransactionOutbox, $writeQueue) =\n    $this->setOutBoxData($param, $param['dim_cod'], 'create', $data_form_outbox);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"update-operation",children:"UPDATE Operation"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Request:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-http",children:'PUT /api/v4/core/PRD/123\n{\n  "XPRD02": 59.99,\n  "source": "productEdit"\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Transaction:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"BEGIN;\n\n-- 1. Update product\nUPDATE TB_ANAG_PRD00 SET\n  XPRD02 = 59.99,\n  LOWNER = 'user_12',\n  LDATA = '20250119130000',\n  TREC = 'M'\nWHERE PRD_ID = 123;\n\n-- 2. Insert outbox entry\nINSERT INTO TB_ANAG_OUTBOX00 (...)\nVALUES (\n  ..., 'PRD', 'update',\n  '{\"PRD_ID\":\"123\",\"XPRD02\":59.99}', ...\n);\n\nCOMMIT;\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Code Reference:"})," ",(0,t.jsx)(n.code,{children:"DataStore.php:2123-2124"})]}),"\n",(0,t.jsx)(n.h3,{id:"delete-operation-soft-delete",children:"DELETE Operation (Soft Delete)"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Request:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-http",children:"DELETE /api/v4/core/PRD/123\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Transaction:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"BEGIN;\n\n-- 1. Soft delete (TREC='C')\nUPDATE TB_ANAG_PRD00 SET\n  TREC = 'C',\n  LOWNER = 'user_12',\n  LDATA = '20250119140000'\nWHERE PRD_ID = 123;\n\n-- 2. Insert outbox entry\nINSERT INTO TB_ANAG_OUTBOX00 (...)\nVALUES (\n  ..., 'PRD', 'logicalDelete',\n  '{\"PRD_ID\":\"123\"}', ...\n);\n\nCOMMIT;\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Operation Type:"})," ",(0,t.jsx)(n.code,{children:'"logicalDelete"'})," (not ",(0,t.jsx)(n.code,{children:'"delete"'})," - indicates soft delete)"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Code Reference:"})," ",(0,t.jsx)(n.code,{children:"DataStore.php:2427-2433"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"list($outboxArr, $outboxID, $commitTransaction, $writeQueue) =\n    $this->setOutBoxData($param, $dim, 'logicalDelete', $data_form_outbox);\n"})}),"\n",(0,t.jsx)(n.h2,{id:"rabbitmq-fanout-exchange",children:"RabbitMQ Fanout Exchange"}),"\n",(0,t.jsx)(n.h3,{id:"exchange-naming-convention",children:"Exchange Naming Convention"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Format:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"{tenant_hash}.{tenant_ref_hash}.sync.exchange\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:'$tenantHash = hash(\'crc32b\', $outboxObj[0]["XOUTBOX15"]);  // Tenant ID\n$tenantRefHash = hash(\'crc32b\', $outboxObj[0]["XOUTBOX09"]);  // Tenant reference\n$exchange = "{$tenantHash}.{$tenantRefHash}.sync.exchange";\n// Result: "a3f2c1b4.d5e6f7g8.sync.exchange"\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Purpose:"})," Unique exchange per tenant for isolation."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Code Reference:"})," ",(0,t.jsx)(n.code,{children:"DataStore.php:2978"})]}),"\n",(0,t.jsx)(n.h3,{id:"publishing-to-exchange",children:"Publishing to Exchange"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Relay Process:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:'// 1. Fetch pending outbox entries\nSELECT * FROM TB_ANAG_OUTBOX00\nWHERE XOUTBOX10 = 0  -- Not yet published\nORDER BY OUTBOX_ID ASC\nLIMIT 100;\n\n// 2. For each entry, publish to RabbitMQ\nforeach ($outboxEntries as $entry) {\n    $exchange = hash(\'crc32b\', $entry[\'XOUTBOX15\']) . "." .\n                hash(\'crc32b\', $entry[\'XOUTBOX09\']) . ".sync.exchange";\n\n    $connection = new AMQPStreamConnection(\n        $_ENV["hostMQ"],\n        $_ENV["portMQ"],\n        $_ENV["userMQ"],\n        $_ENV["passwdMQ"],\n        $environment\n    );\n\n    $channel = $connection->channel();\n    $channel->exchange_declare($exchange, \'fanout\', true, false, false);\n\n    $msg = new AMQPMessage(json_encode($entry));\n    $channel->basic_publish($msg, $exchange);\n\n    $channel->close();\n    $connection->close();\n\n    // 3. Mark as published\n    UPDATE TB_ANAG_OUTBOX00 SET XOUTBOX10 = 1 WHERE OUTBOX_ID = ?;\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Code Reference:"})," ",(0,t.jsx)(n.code,{children:"DataStore.php:2980-2993"})]}),"\n",(0,t.jsx)(n.h3,{id:"fanout-exchange-behavior",children:"Fanout Exchange Behavior"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Fanout"})," = Broadcast to all bound queues:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"                   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                   \u2502  Fanout Exchange \u2502\n                   \u2502 tenant_X.sync    \u2502\n                   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                            \u2502\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502                  \u2502                  \u2502\n         v                  v                  v\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502 Queue 1 \u2502      \u2502 Queue 2  \u2502      \u2502 Queue 3 \u2502\n    \u2502 Search  \u2502      \u2502Analytics \u2502      \u2502  Cache  \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Every consumer receives every event."})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Why Fanout?"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Simple pub/sub pattern"}),"\n",(0,t.jsx)(n.li,{children:"No routing logic required"}),"\n",(0,t.jsx)(n.li,{children:"Every microservice gets all dimension changes"}),"\n",(0,t.jsx)(n.li,{children:"Consumers filter events they care about"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"at-least-once-delivery",children:"At-Least-Once Delivery"}),"\n",(0,t.jsx)(n.h3,{id:"guarantee-mechanism",children:"Guarantee Mechanism"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Outbox Pattern ensures:"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Event persisted in database"})," (ACID transaction)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Relay reads pending events"})," (XOUTBOX10=0)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Publishes to RabbitMQ"})," (retries on failure)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Marks published"})," (XOUTBOX10=1) only after success"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"If RabbitMQ is down:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Events remain in outbox (XOUTBOX10=0)"}),"\n",(0,t.jsx)(n.li,{children:"Relay retries every N seconds"}),"\n",(0,t.jsx)(n.li,{children:"No event loss"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"If database commits but relay crashes:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Events still in outbox (XOUTBOX10=0)"}),"\n",(0,t.jsx)(n.li,{children:"Relay restarts and publishes"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Result:"})," At-least-once delivery guaranteed."]}),"\n",(0,t.jsx)(n.h3,{id:"retry-logic",children:"Retry Logic"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Retry Counter (XOUTBOX08):"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"// On publish failure\nUPDATE TB_ANAG_OUTBOX00 SET\n  XOUTBOX08 = XOUTBOX08 + 1\nWHERE OUTBOX_ID = ?;\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Exponential backoff (typical pattern):"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Retry 1: Wait 1 second"}),"\n",(0,t.jsx)(n.li,{children:"Retry 2: Wait 2 seconds"}),"\n",(0,t.jsx)(n.li,{children:"Retry 3: Wait 4 seconds"}),"\n",(0,t.jsx)(n.li,{children:"Retry N: Wait min(2^N, max_delay) seconds"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Dead Letter Queue (DLQ):"}),"\nAfter N retries (e.g., 10), move to DLQ for manual intervention."]}),"\n",(0,t.jsx)(n.h2,{id:"idempotency-and-deduplication",children:"Idempotency and Deduplication"}),"\n",(0,t.jsx)(n.h3,{id:"consumer-responsibility",children:"Consumer Responsibility"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Consumers MUST handle duplicate events:"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example: Search Indexer"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:'// Event received\n{\n  "XOUTBOX03": "a7f3c2b1...",\n  "XOUTBOX04": "PRD",\n  "XOUTBOX05": "create",\n  "XOUTBOX06": {"PRD_ID": "123", "XPRD01": "Widget"}\n}\n\n// Check if already processed\nconst processed = await redis.get(`event:a7f3c2b1...`);\nif (processed) {\n  console.log("Duplicate event, skipping");\n  return;  // Idempotent - safe to skip\n}\n\n// Index product\nawait elasticsearch.index({\n  index: \'products\',\n  id: \'123\',\n  body: { name: \'Widget\' }\n});\n\n// Mark as processed\nawait redis.set(`event:a7f3c2b1...`, \'1\', \'EX\', 86400);  // 24h TTL\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Key Insight:"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"XOUTBOX03"})," (Event ID) enables deduplication. Consumers should track processed event IDs to achieve exactly-once semantics on their end."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"multi-tenant-isolation",children:"Multi-Tenant Isolation"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Outbox per Tenant:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- Tenant A's exchange\nSELECT * FROM TB_ANAG_OUTBOX00\nWHERE XOUTBOX09 = 'tenant_a';\n-- Publishes to: {hash_a}.{hash_a_ref}.sync.exchange\n\n-- Tenant B's exchange\nSELECT * FROM TB_ANAG_OUTBOX00\nWHERE XOUTBOX09 = 'tenant_b';\n-- Publishes to: {hash_b}.{hash_b_ref}.sync.exchange\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Result:"})," Each tenant has isolated RabbitMQ exchange - no cross-tenant event leakage."]}),"\n",(0,t.jsx)(n.h2,{id:"outbox-cleanup",children:"Outbox Cleanup"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Published Events:"})}),"\n",(0,t.jsx)(n.p,{children:"After successful publish (XOUTBOX10=1), events can be archived or purged:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Option 1: Archive to cold storage"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- Move to archive table\nINSERT INTO TB_ANAG_OUTBOX_ARCHIVE00\nSELECT * FROM TB_ANAG_OUTBOX00\nWHERE XOUTBOX10 = 1\n  AND LDATA < DATE_SUB(NOW(), INTERVAL 30 DAY);\n\n-- Delete from active outbox\nDELETE FROM TB_ANAG_OUTBOX00\nWHERE XOUTBOX10 = 1\n  AND LDATA < DATE_SUB(NOW(), INTERVAL 30 DAY);\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Option 2: Purge after retention period"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- Delete events older than 7 days\nDELETE FROM TB_ANAG_OUTBOX00\nWHERE XOUTBOX10 = 1\n  AND LDATA < DATE_SUB(NOW(), INTERVAL 7 DAY);\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Best Practice:"})," Keep recent published events for debugging, archive older ones."]}),"\n",(0,t.jsx)(n.h2,{id:"enablingdisabling-outbox",children:"Enabling/Disabling Outbox"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Environment Variable:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"ENABLE_OUTBOX=true   # Enable outbox pattern\nENABLE_OUTBOX=false  # Disable (for testing or slave writes)\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Code Reference:"})," ",(0,t.jsx)(n.code,{children:"DataStore.php:3042-3043"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"$_ENV['ENABLE_OUTBOX'] = filter_var($_ENV['ENABLE_OUTBOX'], FILTER_VALIDATE_BOOLEAN);\nif (isset($_ENV['ENABLE_OUTBOX']) && $_ENV['ENABLE_OUTBOX'] == true) {\n    // Write to outbox\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Slave Writes (Outbox Disabled):"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-http",children:'POST /api/v4/core/PRD\n{\n  "XPRD01": "Widget",\n  "outbox": "false"  // Skip outbox write\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Use Case:"})," Replaying events from master to slave - slave shouldn't republish."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Code Reference:"})," ",(0,t.jsx)(n.code,{children:"DataStore.php:1263-1265"})]}),"\n",(0,t.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,t.jsx)(n.h3,{id:"-do-let-corewrite-manage-outbox",children:"\u2705 DO: Let CoreWrite Manage Outbox"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"No manual outbox writes needed:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-http",children:'POST /api/v4/core/PRD\n{\n  "XPRD01": "Widget",\n  "XPRD02": 49.99\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"CoreWrite automatically:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Inserts into TB_ANAG_PRD00"}),"\n",(0,t.jsx)(n.li,{children:"Inserts into TB_ANAG_OUTBOX00"}),"\n",(0,t.jsx)(n.li,{children:"Commits transaction"}),"\n",(0,t.jsx)(n.li,{children:"Relay publishes to RabbitMQ"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"-do-implement-idempotent-consumers",children:"\u2705 DO: Implement Idempotent Consumers"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Track processed event IDs:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"const eventId = event.XOUTBOX03;\nif (await isProcessed(eventId)) {\n  return;  // Already handled\n}\n\nawait processEvent(event);\nawait markProcessed(eventId);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"-do-use-event-sourcing-for-replay",children:"\u2705 DO: Use Event Sourcing for Replay"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Query outbox for event history:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"SELECT XOUTBOX04, XOUTBOX05, XOUTBOX06, LDATA\nFROM TB_ANAG_OUTBOX00\nWHERE XOUTBOX04 = 'PRD'\n  AND XOUTBOX05 IN ('create', 'update')\n  AND LDATA > '20250101000000'\nORDER BY OUTBOX_ID ASC;\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Rebuild read models"})," from outbox events."]}),"\n",(0,t.jsx)(n.h3,{id:"-do-monitor-outbox-lag",children:"\u2705 DO: Monitor Outbox Lag"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Alert on high pending count:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"SELECT COUNT(*) as pending_events\nFROM TB_ANAG_OUTBOX00\nWHERE XOUTBOX10 = 0;\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"If pending_events > threshold:"})," RabbitMQ may be down or relay not running."]}),"\n",(0,t.jsx)(n.h3,{id:"-dont-bypass-outbox-pattern",children:"\u274c DON'T: Bypass Outbox Pattern"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Wrong:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"// Skip outbox and publish directly\nINSERT INTO TB_ANAG_PRD00 (...) VALUES (...);\n$channel->basic_publish($msg, 'product.exchange');  // No ACID guarantee!\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Why:"})," Loses at-least-once delivery guarantee."]}),"\n",(0,t.jsx)(n.h3,{id:"-dont-assume-exactly-once-delivery",children:"\u274c DON'T: Assume Exactly-Once Delivery"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Misconception:"})," Outbox pattern = exactly-once delivery."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Reality:"})," Outbox pattern = ",(0,t.jsx)(n.strong,{children:"at-least-once"})," delivery."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Solution:"})," Consumers must implement deduplication using XOUTBOX03."]}),"\n",(0,t.jsx)(n.h3,{id:"-dont-purge-outbox-too-aggressively",children:"\u274c DON'T: Purge Outbox Too Aggressively"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Wrong:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- Delete immediately after publish\nDELETE FROM TB_ANAG_OUTBOX00 WHERE XOUTBOX10 = 1;\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Why:"})," Loses audit trail and replay capability."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Right:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- Keep for 7-30 days\nDELETE FROM TB_ANAG_OUTBOX00\nWHERE XOUTBOX10 = 1 AND LDATA < DATE_SUB(NOW(), INTERVAL 7 DAY);\n"})}),"\n",(0,t.jsx)(n.h2,{id:"common-pitfalls",children:"Common Pitfalls"}),"\n",(0,t.jsx)(n.h3,{id:"pitfall-1-not-handling-duplicate-events",children:"Pitfall 1: Not Handling Duplicate Events"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Problem:"})," Consumer processes same event twice, creates duplicate records."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"// Wrong - not idempotent\nasync function onProductCreated(event) {\n  await db.insert('products', event.XOUTBOX06);  // Duplicate insert on retry!\n}\n\n// Right - idempotent\nasync function onProductCreated(event) {\n  const productId = event.XOUTBOX06.PRD_ID;\n  await db.upsert('products', { id: productId }, event.XOUTBOX06);\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"pitfall-2-ignoring-retry-count",children:"Pitfall 2: Ignoring Retry Count"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Problem:"})," Infinite retries on permanent failures."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Solution:"})," Check XOUTBOX08 and move to DLQ after threshold:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- Move events with >10 retries to dead letter queue\nINSERT INTO TB_ANAG_OUTBOX_DLQ00\nSELECT * FROM TB_ANAG_OUTBOX00\nWHERE XOUTBOX08 > 10 AND XOUTBOX10 = 0;\n\nDELETE FROM TB_ANAG_OUTBOX00\nWHERE XOUTBOX08 > 10 AND XOUTBOX10 = 0;\n"})}),"\n",(0,t.jsx)(n.h3,{id:"pitfall-3-relying-on-event-order",children:"Pitfall 3: Relying on Event Order"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Problem:"})," Expecting events in exact order."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Reality:"})," Fanout exchanges don't guarantee order across consumers."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Solution:"})," Use versioning or timestamps:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:'// Check event timestamp vs current state\nif (event.LDATA <= currentProduct.LDATA) {\n  console.log("Stale event, ignoring");\n  return;\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Outbox Pattern"})," provides:"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"ACID guarantees"})," - Data + event write in single transaction"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"At-least-once delivery"})," - No event loss, even if RabbitMQ fails"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Eventual consistency"})," - All microservices eventually synchronized"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Audit trail"})," - Full event history in TB_ANAG_OUTBOX00"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Replay capability"})," - Rebuild systems from outbox events"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Multi-tenant isolation"})," - Separate exchanges per tenant"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Key Insight:"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["The Outbox Pattern is the ",(0,t.jsx)(n.strong,{children:"consistency guarantee"})," for distributed Q01 systems. Every write operation publishes an event - no exceptions, no bypasses. Consumers achieve exactly-once semantics through idempotency and deduplication."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Next Concept:"})}),"\n",(0,t.jsxs)(n.p,{children:["Continue to ",(0,t.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/pre-insert-functions",children:"Pre-Insert Functions"})," to understand how fields are auto-populated during record creation."]})]})}function h(e={}){const{wrapper:n}={...(0,r.M)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},2172:(e,n,s)=>{s.d(n,{I:()=>a,M:()=>l});var t=s(1504);const r={},i=t.createContext(r);function l(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);