"use strict";(self.webpackChunkq_01_docs=self.webpackChunkq_01_docs||[]).push([[1968],{7524:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>d,toc:()=>o});var s=i(7624),r=i(2172);const t={title:"Context Chain",sidebar_label:"3. Context Chain",sidebar_position:4,description:"Understanding how request context controls field visibility, permissions, and data access"},l="Context Chain: The Request Fingerprint",d={id:"products/map.q01.io/core-api-platform-v4/core-concepts/context-chain",title:"Context Chain",description:"Understanding how request context controls field visibility, permissions, and data access",source:"@site/docs/products/map.q01.io/core-api-platform-v4/01-core-concepts/context-chain.md",sourceDirName:"products/map.q01.io/core-api-platform-v4/01-core-concepts",slug:"/products/map.q01.io/core-api-platform-v4/core-concepts/context-chain",permalink:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/context-chain",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:4,frontMatter:{title:"Context Chain",sidebar_label:"3. Context Chain",sidebar_position:4,description:"Understanding how request context controls field visibility, permissions, and data access"},sidebar:"mapSidebar",previous:{title:"2. MAP Framework",permalink:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/map-framework"},next:{title:"4. Field Visibility (COD_ON_OFF)",permalink:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/field-visibility"}},c={},o=[{value:"What is the Context Chain?",id:"what-is-the-context-chain",level:2},{value:"The 6 Context Parameters",id:"the-6-context-parameters",level:2},{value:"1. source (Security Area)",id:"1-source-security-area",level:2},{value:"Permission Validation",id:"permission-validation",level:3},{value:"Grant Checking",id:"grant-checking",level:3},{value:"2. modulo (Module Context)",id:"2-modulo-module-context",level:2},{value:"Dimension Filtering",id:"dimension-filtering",level:3},{value:"Menu Filtering",id:"menu-filtering",level:3},{value:"3. microservice (Service Identifier)",id:"3-microservice-service-identifier",level:2},{value:"Outbox Tagging",id:"outbox-tagging",level:3},{value:"Session Context",id:"session-context",level:3},{value:"Logging",id:"logging",level:3},{value:"4. center_dett (UI State / Field Visibility)",id:"4-center_dett-ui-state--field-visibility",level:2},{value:"Field Filtering by center_dett",id:"field-filtering-by-center_dett",level:3},{value:"List View (visualizza)",id:"list-view-visualizza",level:3},{value:"Detail View (dettaglio)",id:"detail-view-dettaglio",level:3},{value:"Create Form (nuovo)",id:"create-form-nuovo",level:3},{value:"5. peso (User Permission Weight)",id:"5-peso-user-permission-weight",level:2},{value:"Field Filtering by peso",id:"field-filtering-by-peso",level:3},{value:"6. ambiente (Environment Filter)",id:"6-ambiente-environment-filter",level:2},{value:"Automatic WHERE Clause Injection",id:"automatic-where-clause-injection",level:3},{value:"Context Chain in Action",id:"context-chain-in-action",level:2},{value:"Read Operation Example",id:"read-operation-example",level:3},{value:"Write Operation Example",id:"write-operation-example",level:3},{value:"Context Chain Best Practices",id:"context-chain-best-practices",level:2},{value:"\u2705 DO:",id:"-do",level:3},{value:"\u274c DON&#39;T:",id:"-dont",level:3},{value:"Summary",id:"summary",level:2}];function a(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.M)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"context-chain-the-request-fingerprint",children:"Context Chain: The Request Fingerprint"}),"\n",(0,s.jsx)(n.h2,{id:"what-is-the-context-chain",children:"What is the Context Chain?"}),"\n",(0,s.jsxs)(n.p,{children:["Every request to Q01 Core APIs carries a ",(0,s.jsx)(n.strong,{children:"context chain"})," - a set of parameters that determine:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Which fields are visible (COD_ON_OFF filtering)"}),"\n",(0,s.jsx)(n.li,{children:"Which data rows are accessible (ambiente filtering)"}),"\n",(0,s.jsx)(n.li,{children:"What operations are permitted (permission validation)"}),"\n",(0,s.jsx)(n.li,{children:"How data is formatted (language, labels)"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Context is not optional"})," - it travels with EVERY request and actively shapes the response."]}),"\n",(0,s.jsx)(n.h2,{id:"the-6-context-parameters",children:"The 6 Context Parameters"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502        CONTEXT CHAIN                 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 1. source        (COD_MENU)          \u2502  \u2190 Security area\n\u2502 2. modulo        (module)            \u2502  \u2190 Application context\n\u2502 3. microservice  (service)           \u2502  \u2190 Service identifier\n\u2502 4. center_dett   (UI state)          \u2502  \u2190 Field visibility filter\n\u2502 5. peso          (user weight)       \u2502  \u2190 Permission level\n\u2502 6. ambiente      (environment)       \u2502  \u2190 Tenant isolation\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,s.jsx)(n.p,{children:"Let's explore each parameter in detail."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"1-source-security-area",children:"1. source (Security Area)"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"What it is:"})," The menu/security area code from TB_MENU (COD_MENU)."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Purpose:"})," Defines the permission context for the operation."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Examples:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"source=productManagement"})," - Product management security area"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"source=salesDashboard"})," - Sales dashboard area"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"source=adminPanel"})," - Administrator panel"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"How it's used:"})}),"\n",(0,s.jsx)(n.h3,{id:"permission-validation",children:"Permission Validation"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- CoreWrite validates user has access to this source\nSELECT LIVELLO_GRANT\nFROM TB_MENU\nWHERE COD_MENU = :source;  -- e.g., 'productManagement'\n\n-- LIVELLO_GRANT:\n-- 2 = Modify permission (PUT/PATCH allowed)\n-- 4 = Create permission (POST allowed)\n"})}),"\n",(0,s.jsx)(n.h3,{id:"grant-checking",children:"Grant Checking"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// In RequestValidatorSubscriber\n$grantSession = $this->session->get($source, 0, 'grant_session');\nif (!$grantUtils->checkGrant($grantSession, $requiredLevel)) {\n    throw new Exception(\"Insufficient permissions for source: $source\");\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Required:"})," YES (for all write operations, most read operations)"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:'POST /api/v4/core/PRD\n{\n  "source": "productManagement",\n  "XPRD01": "Widget Pro"\n}\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"2-modulo-module-context",children:"2. modulo (Module Context)"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"What it is:"})," The application module or context the request originates from."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Purpose:"})," Enables module-specific behavior and metadata filtering."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Examples:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"modulo=Default"})," - Standard application"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"modulo=POS"})," - Point of Sale application"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"modulo=B2B"})," - B2B portal"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"modulo=Mobile"})," - Mobile app"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"How it's used:"})}),"\n",(0,s.jsx)(n.h3,{id:"dimension-filtering",children:"Dimension Filtering"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Load dimensions for specific module\nSELECT *\nFROM TB_DIM\nWHERE MODULO = :modulo OR MODULO = 'Default';\n"})}),"\n",(0,s.jsx)(n.h3,{id:"menu-filtering",children:"Menu Filtering"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Load menus for specific module\nSELECT *\nFROM TB_MENU\nWHERE MODULO = :modulo;\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Multi-Module Support:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Different modules can have different menu structures"}),"\n",(0,s.jsx)(n.li,{children:"Same dimension can behave differently per module"}),"\n",(0,s.jsx)(n.li,{children:"Enables white-labeling and tenant-specific UIs"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Default:"})," ",(0,s.jsx)(n.code,{children:"Default"})," (if not specified)"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"3-microservice-service-identifier",children:"3. microservice (Service Identifier)"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"What it is:"})," Identifier of the microservice making the request."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Purpose:"})," Tags operations for logging, outbox events, and service-specific configuration."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Examples:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"microservice=mscoreservice"})," - Core API service"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"microservice=orderservice"})," - Order management service"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"microservice=pos-frontend"})," - POS frontend"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"How it's used:"})}),"\n",(0,s.jsx)(n.h3,{id:"outbox-tagging",children:"Outbox Tagging"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// Outbox records tagged with microservice\n$outbox['XOUTBOX11'] = $microservice;  // \"mscoreservice\"\n"})}),"\n",(0,s.jsx)(n.h3,{id:"session-context",children:"Session Context"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// Microservice-specific session namespace\n$this->session->set('ambiente', $value, $microservice);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"logging",children:"Logging"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"[2025-12-19 15:30:42] [mscoreservice] POST /api/v4/core/PRD - user123\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Required:"})," NO (default from environment/config)"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"4-center_dett-ui-state--field-visibility",children:"4. center_dett (UI State / Field Visibility)"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"What it is:"})," The current UI state or operation context - ",(0,s.jsx)(n.strong,{children:"THE MOST CRITICAL CONTEXT PARAMETER"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Purpose:"})," Filters which fields are visible based on COD_ON_OFF bitmask matching."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Standard Values:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"center_dett"}),(0,s.jsx)(n.th,{children:"Meaning"}),(0,s.jsx)(n.th,{children:"COD_ON_OFF Flag"}),(0,s.jsx)(n.th,{children:"Use Case"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"visualizza"})}),(0,s.jsx)(n.td,{children:"List view"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"L"})}),(0,s.jsx)(n.td,{children:"Grid/table display"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"dettaglio"})}),(0,s.jsx)(n.td,{children:"Detail view"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"D"})}),(0,s.jsx)(n.td,{children:"Single record display"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"nuovo"})}),(0,s.jsx)(n.td,{children:"New/Create form"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"N"})}),(0,s.jsx)(n.td,{children:"Create operation"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.strong,{children:"edit"})," / ",(0,s.jsx)(n.strong,{children:"modifica"})]}),(0,s.jsx)(n.td,{children:"Edit/Update form"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"M"})}),(0,s.jsx)(n.td,{children:"Update operation"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"ricerca"})}),(0,s.jsx)(n.td,{children:"Search form"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"R"})}),(0,s.jsx)(n.td,{children:"Search/filter form"})]})]})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"How it works:"})}),"\n",(0,s.jsx)(n.h3,{id:"field-filtering-by-center_dett",children:"Field Filtering by center_dett"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- When center_dett = 'visualizza' (list view)\nSELECT *\nFROM TB_COST\nWHERE DIM_COD = 'PRD'\n  AND FIND_IN_SET('L', COD_ON_OFF)  -- Only fields with 'L' flag\nORDER BY COD_SEQUENZA;\n\n-- When center_dett = 'dettaglio' (detail view)\nSELECT *\nFROM TB_COST\nWHERE DIM_COD = 'PRD'\n  AND (FIND_IN_SET('D', COD_ON_OFF) OR FIND_IN_SET('L', COD_ON_OFF))\nORDER BY COD_SEQUENZA;\n\n-- When center_dett = 'nuovo' (create form)\nSELECT *\nFROM TB_COST\nWHERE DIM_COD = 'PRD'\n  AND FIND_IN_SET('N', COD_ON_OFF)\nORDER BY COD_SEQUENZA;\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Examples:"})}),"\n",(0,s.jsx)(n.h3,{id:"list-view-visualizza",children:"List View (visualizza)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:'GET /api/v4/core/PRD?source=productList&center_dett=visualizza\n\n-- Returns only fields with COD_ON_OFF containing \'L\':\n{\n  "data": [\n    {\n      "PRD_ID": 1,\n      "XPRD01": "Widget Pro",    // COD_ON_OFF=\'LDNMR\' (has L)\n      "XPRD02": 49.99            // COD_ON_OFF=\'LDNMR\' (has L)\n      // XPRD04 not included (COD_ON_OFF=\'D\', no L)\n    }\n  ]\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"detail-view-dettaglio",children:"Detail View (dettaglio)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:'GET /api/v4/core/PRD/1?source=productDetail&center_dett=dettaglio\n\n-- Returns fields with \'D\' OR \'L\':\n{\n  "data": {\n    "PRD_ID": 1,\n    "XPRD01": "Widget Pro",           // COD_ON_OFF=\'LDNMR\'\n    "XPRD02": 49.99,                  // COD_ON_OFF=\'LDNMR\'\n    "XPRD04": "Full description"      // COD_ON_OFF=\'D\' (detail only)\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"create-form-nuovo",children:"Create Form (nuovo)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:'GET /api/v4/core/PRD/fields?source=productForm&center_dett=nuovo\n\n-- Returns only fields writable on create (COD_ON_OFF contains \'N\'):\n{\n  "data": [\n    {"COD_COST": "XPRD01", "DESC_COST": "Product Name", "CHECK_CAMPO": "not null"},\n    {"COD_COST": "XPRD02", "DESC_COST": "Price", "CHECK_CAMPO": "not null"}\n    // Fields with COD_ON_OFF=\'D\' (detail-only) NOT included\n  ]\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Required:"})," YES (for most operations)"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Common Mistake:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:"\u274c Wrong:\nGET /api/v4/core/PRD?source=productList\n// Missing center_dett - fields may not filter correctly\n\n\u2705 Correct:\nGET /api/v4/core/PRD?source=productList&center_dett=visualizza\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"5-peso-user-permission-weight",children:"5. peso (User Permission Weight)"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"What it is:"})," Numeric permission level from JWT token claims."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Purpose:"})," Field-level access control - users only see fields their peso allows."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Range:"})," 0-100 or * (higher = more permissions)"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Examples:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"peso=10"})," - Basic user"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"peso=50"})," - Manager"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"peso=90"})," - Administrator"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"peso=100"})," or ",(0,s.jsx)(n.code,{children:"peso=*"})," - Super admin"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"How it's used:"})}),"\n",(0,s.jsx)(n.h3,{id:"field-filtering-by-peso",children:"Field Filtering by peso"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- User with peso=30 queries products\nSELECT *\nFROM TB_COST\nWHERE DIM_COD = 'PRD'\n  AND (COD_UTENTE = '*' OR CAST(COD_UTENTE AS UNSIGNED) <= 30)\nORDER BY COD_SEQUENZA;\n\n-- Fields with COD_UTENTE='*' \u2192 visible to everyone\n-- Fields with COD_UTENTE='10' \u2192 visible to peso >= 10\n-- Fields with COD_UTENTE='50' \u2192 visible only to peso >= 50 (HIDDEN for peso=30)\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example TB_COST Configuration:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"COD_COST"}),(0,s.jsx)(n.th,{children:"DESC_COST"}),(0,s.jsx)(n.th,{children:"COD_UTENTE"}),(0,s.jsx)(n.th,{children:"Visible To"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"XPRD01"}),(0,s.jsx)(n.td,{children:"Product Name"}),(0,s.jsx)(n.td,{children:"*"}),(0,s.jsx)(n.td,{children:"Everyone"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"XPRD02"}),(0,s.jsx)(n.td,{children:"Sale Price"}),(0,s.jsx)(n.td,{children:"*"}),(0,s.jsx)(n.td,{children:"Everyone"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"XPRD_COST"}),(0,s.jsx)(n.td,{children:"Cost Price"}),(0,s.jsx)(n.td,{children:"50"}),(0,s.jsx)(n.td,{children:"peso >= 50 only"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"XPRD_MARGIN"}),(0,s.jsx)(n.td,{children:"Profit Margin"}),(0,s.jsx)(n.td,{children:"90"}),(0,s.jsx)(n.td,{children:"peso >= 90 only"})]})]})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"User with peso=30 sees:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "PRD_ID": 1,\n  "XPRD01": "Widget Pro",\n  "XPRD02": 49.99\n  // XPRD_COST and XPRD_MARGIN hidden\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"User with peso=90 sees:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "PRD_ID": 1,\n  "XPRD01": "Widget Pro",\n  "XPRD02": 49.99,\n  "XPRD_COST": 30.00,      // Now visible\n  "XPRD_MARGIN": 19.99     // Now visible\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Source:"})," JWT token claim ",(0,s.jsx)(n.code,{children:"peso"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Required:"})," YES (from token, automatic)"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"6-ambiente-environment-filter",children:"6. ambiente (Environment Filter)"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"What it is:"})," Comma-separated list of environment IDs the user can access."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Purpose:"})," ",(0,s.jsx)(n.strong,{children:"Multi-tenant data isolation"})," - ensures users only see data from their environments."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Examples:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ambiente=1"})," - Production environment only"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ambiente=1,2"})," - Production and staging"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ambiente=1,2,3"})," - All environments"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"How it's used:"})}),"\n",(0,s.jsx)(n.h3,{id:"automatic-where-clause-injection",children:"Automatic WHERE Clause Injection"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- CoreQuery automatically adds ambiente filter\nSELECT *\nFROM TB_ANAG_PRD00\nWHERE FIND_IN_SET(:ambiente, XPRD01_AMBIENTE)\n\n-- If ambiente='1,2':\nWHERE FIND_IN_SET('1', XPRD01_AMBIENTE) OR FIND_IN_SET('2', XPRD01_AMBIENTE)\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Data Storage:"})}),"\n",(0,s.jsxs)(n.p,{children:["Every record stores ambiente in ",(0,s.jsx)(n.code,{children:"X{DIM}01"})," field:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"INSERT INTO TB_ANAG_PRD00 (\n  XPRD01, XPRD02,\n  XPRD01_AMBIENTE  -- Auto-populated from session\n) VALUES (\n  'Widget Pro', 49.99,\n  '1,2'  -- Accessible in environments 1 and 2\n);\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Environment Isolation:"})}),"\n",(0,s.jsx)(n.p,{children:"User A (ambiente='1'):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Can see records with XPRD01_AMBIENTE containing '1'\nSELECT * FROM TB_ANAG_PRD00 WHERE FIND_IN_SET('1', XPRD01_AMBIENTE);\n-- Results: Records with ambiente='1' or '1,2' or '1,3', etc.\n"})}),"\n",(0,s.jsx)(n.p,{children:"User B (ambiente='2'):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Can see records with XPRD01_AMBIENTE containing '2'\nSELECT * FROM TB_ANAG_PRD00 WHERE FIND_IN_SET('2', XPRD01_AMBIENTE);\n-- Results: Records with ambiente='2' or '1,2' or '2,3', etc.\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Field-Level Ambiente Filtering:"})}),"\n",(0,s.jsx)(n.p,{children:"TB_COST can also filter fields by environment:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT *\nFROM TB_COST\nWHERE DIM_COD = 'PRD'\n  AND (COD_AMBIENTE IS NULL OR FIND_IN_SET(:ambiente, COD_AMBIENTE))\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Source:"})," JWT token claim ",(0,s.jsx)(n.code,{children:"ambiente"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Required:"})," YES (from token, automatic)"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"context-chain-in-action",children:"Context Chain in Action"}),"\n",(0,s.jsx)(n.h3,{id:"read-operation-example",children:"Read Operation Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:"GET /api/v4/core/PRD?source=productList&center_dett=visualizza&$filter=XPRD02>50\n\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"JWT Token Claims:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "userId": "user123",\n  "peso": 50,\n  "ambiente": "1,2",\n  "grants": {...}\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"CoreQuery Processing:"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Extract context from request:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["source = ",(0,s.jsx)(n.code,{children:"productList"})]}),"\n",(0,s.jsxs)(n.li,{children:["center_dett = ",(0,s.jsx)(n.code,{children:"visualizza"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Extract context from JWT:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["peso = ",(0,s.jsx)(n.code,{children:"50"})]}),"\n",(0,s.jsxs)(n.li,{children:["ambiente = ",(0,s.jsx)(n.code,{children:"1,2"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Load visible fields:"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT *\nFROM TB_COST\nWHERE DIM_COD = 'PRD'\n  AND FIND_IN_SET('L', COD_ON_OFF)  -- center_dett='visualizza' \u2192 L flag\n  AND (COD_UTENTE = '*' OR CAST(COD_UTENTE AS UNSIGNED) <= 50)  -- peso filtering\n  AND (COD_AMBIENTE IS NULL OR FIND_IN_SET('1', COD_AMBIENTE) OR FIND_IN_SET('2', COD_AMBIENTE))\nORDER BY COD_SEQUENZA;\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"4",children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Build query:"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT PRD_ID, XPRD01, XPRD02  -- Only visible fields\nFROM TB_ANAG_PRD00\nWHERE XPRD02 > 50  -- $filter\n  AND (FIND_IN_SET('1', XPRD01_AMBIENTE) OR FIND_IN_SET('2', XPRD01_AMBIENTE))  -- ambiente\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"5",children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Return filtered response:"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "data": [\n    {\n      "PRD_ID": 2,\n      "XPRD01": "Gadget Plus",\n      "XPRD02": 79.99\n      // Only fields with COD_ON_OFF=\'L\' and COD_UTENTE <= 50\n    }\n  ]\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Context shaped EVERYTHING:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Which fields returned (center_dett + peso)"}),"\n",(0,s.jsx)(n.li,{children:"Which data rows returned (ambiente)"}),"\n",(0,s.jsx)(n.li,{children:"Permission validation (source)"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"write-operation-example",children:"Write Operation Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:'POST /api/v4/core/PRD\n{\n  "source": "productManagement",\n  "XPRD01": "New Widget",\n  "XPRD02": 59.99\n}\n\nAuthorization: Bearer eyJ...\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"CoreWrite Processing:"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Validate source permission:"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT LIVELLO_GRANT FROM TB_MENU WHERE COD_MENU = 'productManagement';\n-- Result: 4 (create permission required)\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Check user grant:"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"$grantSession = $session->get('productManagement', 0, 'grant_session');\nif ($grantSession < 4) {\n    throw new Exception(\"Grant level 4 required for create\");\n}\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Load writable fields (center_dett='nuovo'):"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT *\nFROM TB_COST\nWHERE DIM_COD = 'PRD'\n  AND FIND_IN_SET('N', COD_ON_OFF)  -- Writable on create\n  AND (COD_UTENTE = '*' OR CAST(COD_UTENTE AS UNSIGNED) <= :peso)\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"4",children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Validate required fields:"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Check XPRD01 and XPRD02 are present and valid\n-- CHECK_CAMPO='not null' fields must be provided\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"5",children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Insert with context:"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"INSERT INTO TB_ANAG_PRD00 (\n  XPRD01, XPRD02,\n  OWNER, CDATA, TREC,\n  XPRD01_AMBIENTE  -- Auto-populated from JWT ambiente\n) VALUES (\n  'New Widget', 59.99,\n  'user123', '20251219153042', 'N',\n  '1,2'  -- From JWT: ambiente='1,2'\n);\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Context ensured:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"User had permission (source + grant validation)"}),"\n",(0,s.jsx)(n.li,{children:"Only writable fields accepted (center_dett='nuovo')"}),"\n",(0,s.jsx)(n.li,{children:"Data tagged with user's ambiente (tenant isolation)"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"context-chain-best-practices",children:"Context Chain Best Practices"}),"\n",(0,s.jsx)(n.h3,{id:"-do",children:"\u2705 DO:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Always provide source"})," for permission validation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Always provide center_dett"})," for correct field visibility"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Trust JWT claims"})," (peso, ambiente) - don't override"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Use standard center_dett values"})," (visualizza, dettaglio, nuovo, edit, ricerca)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Document context requirements"})," in API consumers"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"-dont",children:"\u274c DON'T:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Skip source parameter (permission validation will fail)"}),"\n",(0,s.jsx)(n.li,{children:"Skip center_dett parameter (field visibility unpredictable)"}),"\n",(0,s.jsx)(n.li,{children:"Try to override JWT claims (server-side validation will reject)"}),"\n",(0,s.jsx)(n.li,{children:"Invent custom center_dett values without metadata support"}),"\n",(0,s.jsx)(n.li,{children:"Assume context is optional"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Context Chain"})," is the fingerprint of every request:"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Parameter"}),(0,s.jsx)(n.th,{children:"Source"}),(0,s.jsx)(n.th,{children:"Purpose"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"source"})}),(0,s.jsx)(n.td,{children:"Request"}),(0,s.jsx)(n.td,{children:"Security area, permission validation"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"modulo"})}),(0,s.jsx)(n.td,{children:"Request/Config"}),(0,s.jsx)(n.td,{children:"Module context"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"microservice"})}),(0,s.jsx)(n.td,{children:"Config"}),(0,s.jsx)(n.td,{children:"Service identifier"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"center_dett"})}),(0,s.jsx)(n.td,{children:"Request"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.strong,{children:"Field visibility filter"})," (CRITICAL)"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"peso"})}),(0,s.jsx)(n.td,{children:"JWT"}),(0,s.jsx)(n.td,{children:"Field-level access control"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"ambiente"})}),(0,s.jsx)(n.td,{children:"JWT"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.strong,{children:"Tenant data isolation"})," (CRITICAL)"]})]})]})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key Insight:"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["Context doesn't just describe the request - it ",(0,s.jsx)(n.strong,{children:"actively shapes"})," what you see, what you can do, and what data is accessible."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Next Concept:"})}),"\n",(0,s.jsxs)(n.p,{children:["\u2192 Continue to ",(0,s.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/field-visibility",children:"Field Visibility - COD_ON_OFF"})," to understand the bitmask that works with center_dett."]})]})}function h(e={}){const{wrapper:n}={...(0,r.M)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},2172:(e,n,i)=>{i.d(n,{I:()=>d,M:()=>l});var s=i(1504);const r={},t=s.createContext(r);function l(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);