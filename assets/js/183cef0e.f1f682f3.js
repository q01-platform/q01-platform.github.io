"use strict";(self.webpackChunkq_01_docs=self.webpackChunkq_01_docs||[]).push([[428],{5440:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>i,metadata:()=>l,toc:()=>a});var s=r(7624),t=r(2172);const i={title:"Counter Management",sidebar_label:"Counter Management",sidebar_position:10,description:"Sequential identifiers with TB_COUNTER and format masks"},d="Counter Management",l={id:"products/map.q01.io/core-api-platform-v4/write-patterns/counter-management",title:"Counter Management",description:"Sequential identifiers with TB_COUNTER and format masks",source:"@site/docs/products/map.q01.io/core-api-platform-v4/04-write-patterns/counter-management.md",sourceDirName:"products/map.q01.io/core-api-platform-v4/04-write-patterns",slug:"/products/map.q01.io/core-api-platform-v4/write-patterns/counter-management",permalink:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/counter-management",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:10,frontMatter:{title:"Counter Management",sidebar_label:"Counter Management",sidebar_position:10,description:"Sequential identifiers with TB_COUNTER and format masks"},sidebar:"mapSidebar",previous:{title:"Outbox Pattern",permalink:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/outbox-pattern"},next:{title:"Error Handling",permalink:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/error-handling"}},c={},a=[{value:"Overview",id:"overview",level:2},{value:"TB_COUNTER Table",id:"tb_counter-table",level:2},{value:"Schema",id:"schema",level:3},{value:"Configuration Example",id:"configuration-example",level:3},{value:"Format Masks",id:"format-masks",level:2},{value:"Available Tokens",id:"available-tokens",level:3},{value:"Format Examples",id:"format-examples",level:3},{value:"Counter Generation",id:"counter-generation",level:2},{value:"Automatic Generation on POST",id:"automatic-generation-on-post",level:3},{value:"Reset Periods",id:"reset-periods",level:2},{value:"RESET_PERIOD Values",id:"reset_period-values",level:3},{value:"Concurrent Safety",id:"concurrent-safety",level:2},{value:"Row-Level Locking",id:"row-level-locking",level:3},{value:"Multiple Counters Per Dimension",id:"multiple-counters-per-dimension",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"\u2705 DO:",id:"-do",level:3},{value:"\u274c DON&#39;T:",id:"-dont",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Duplicate Counter Values",id:"duplicate-counter-values",level:3},{value:"Counter Not Resetting",id:"counter-not-resetting",level:3},{value:"Counter Value Too High",id:"counter-value-too-high",level:3},{value:"Summary",id:"summary",level:2},{value:"Related Concepts",id:"related-concepts",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.M)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"counter-management",children:"Counter Management"}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Counters"})," generate sequential, formatted identifiers like ",(0,s.jsx)(n.code,{children:"PRD-2025-001"}),", ",(0,s.jsx)(n.code,{children:"ORD-2025-12-19-0001"}),". CoreWrite automatically manages counters via ",(0,s.jsx)(n.strong,{children:"TB_COUNTER"})," metadata table, eliminating manual sequence management."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Benefits:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u2705 Human-readable identifiers"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Sequential numbering per dimension"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Flexible format masks (year, month, day, sequence)"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Concurrent-safe (database-level locking)"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Automatic reset (yearly, monthly, daily)"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 No manual management needed"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"tb_counter-table",children:"TB_COUNTER Table"}),"\n",(0,s.jsx)(n.h3,{id:"schema",children:"Schema"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE TB_COUNTER (\n    COUNTER_ID INT PRIMARY KEY AUTO_INCREMENT,\n    COD_DIM VARCHAR(10) NOT NULL,      -- Dimension (PRD, ORD, etc.)\n    COD_VAR VARCHAR(50) NOT NULL,      -- Field (XPRD03, XORD01, etc.)\n    COUNTER_VALUE INT NOT NULL DEFAULT 0,  -- Current value\n    FORMAT_MASK VARCHAR(100),          -- Format: PRD-{YYYY}-{NNN}\n    RESET_PERIOD VARCHAR(10),          -- YEARLY, MONTHLY, DAILY, NEVER\n    LAST_RESET_DATE VARCHAR(8),        -- YYYYMMDD\n    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n    UNIQUE KEY (COD_DIM, COD_VAR)\n);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"configuration-example",children:"Configuration Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Product code counter: PRD-2025-001, PRD-2025-002, ...\nINSERT INTO TB_COUNTER (\n    COD_DIM,\n    COD_VAR,\n    COUNTER_VALUE,\n    FORMAT_MASK,\n    RESET_PERIOD,\n    LAST_RESET_DATE\n) VALUES (\n    'PRD',                    -- Product dimension\n    'XPRD03',                 -- Counter field\n    0,                        -- Start at 0\n    'PRD-{YYYY}-{NNN}',       -- Format mask\n    'YEARLY',                 -- Reset each year\n    '20250101'                -- Last reset date\n);\n\n-- Order number counter: ORD-2025-12-19-0001, ORD-2025-12-19-0002, ...\nINSERT INTO TB_COUNTER (\n    COD_DIM,\n    COD_VAR,\n    COUNTER_VALUE,\n    FORMAT_MASK,\n    RESET_PERIOD\n) VALUES (\n    'ORD',\n    'XORD01',\n    0,\n    'ORD-{YYYY}-{MM}-{DD}-{NNNN}',\n    'DAILY'\n);\n"})}),"\n",(0,s.jsx)(n.h2,{id:"format-masks",children:"Format Masks"}),"\n",(0,s.jsx)(n.h3,{id:"available-tokens",children:"Available Tokens"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Token"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Example"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"{YYYY}"})}),(0,s.jsx)(n.td,{children:"4-digit year"}),(0,s.jsx)(n.td,{children:"2025"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"{YY}"})}),(0,s.jsx)(n.td,{children:"2-digit year"}),(0,s.jsx)(n.td,{children:"25"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"{MM}"})}),(0,s.jsx)(n.td,{children:"2-digit month"}),(0,s.jsx)(n.td,{children:"12"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"{M}"})}),(0,s.jsx)(n.td,{children:"Month no padding"}),(0,s.jsx)(n.td,{children:"1, 12"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"{DD}"})}),(0,s.jsx)(n.td,{children:"2-digit day"}),(0,s.jsx)(n.td,{children:"19"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"{D}"})}),(0,s.jsx)(n.td,{children:"Day no padding"}),(0,s.jsx)(n.td,{children:"1, 19"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"{NNN}"})}),(0,s.jsx)(n.td,{children:"Sequential number (3 digits)"}),(0,s.jsx)(n.td,{children:"001, 042, 999"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"{NNNN}"})}),(0,s.jsx)(n.td,{children:"Sequential number (4 digits)"}),(0,s.jsx)(n.td,{children:"0001, 0042, 9999"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"{N}"})}),(0,s.jsx)(n.td,{children:"Sequential number (no padding)"}),(0,s.jsx)(n.td,{children:"1, 42, 999"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"format-examples",children:"Format Examples"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Simple counter:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Format: PRD-{YYYY}-{NNN}\nResult: PRD-2025-001, PRD-2025-002, ...\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Daily counter:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Format: ORD-{YYYY}{MM}{DD}-{NNNN}\nResult: ORD-20251219-0001, ORD-20251219-0002, ...\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Fiscal year counter:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Format: INV-FY{YY}-{NNNN}\nResult: INV-FY25-0001, INV-FY25-0002, ...\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Short format:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Format: {YY}{MM}-{NNN}\nResult: 2512-001, 2512-002, ...\n"})}),"\n",(0,s.jsx)(n.h2,{id:"counter-generation",children:"Counter Generation"}),"\n",(0,s.jsx)(n.h3,{id:"automatic-generation-on-post",children:"Automatic Generation on POST"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"TB_COST.VALUE_TEMP triggers counter generation:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Configure field for counter generation\nINSERT INTO TB_COST (\n    COD_DIM,\n    NUM_COST,\n    COD_VAR,\n    VALUE_TEMP,\n    COD_ON_OFF,\n    DESCRIZIONE_COST\n) VALUES (\n    'PRD',\n    3,\n    'XPRD03',\n    '{counter:PRD-{YYYY}-{NNN}}',  -- References counter config\n    'LDR',                          -- Read-only (no N or M flag)\n    'Product code'\n);\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Request:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'POST /api/v4/core/PRD\n{\n  "data": {\n    "XPRD01": "Widget Pro",\n    "XPRD02": 99.99\n    // XPRD03 auto-generated\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"CoreWrite Logic:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// CoreWrite pre-insert processing\npublic function processPreInsertFunctions(string $dimension, array &$data): void {\n    // Get field configurations\n    $costs = $this->getFieldConfigurations($dimension);\n\n    foreach ($costs as $cost) {\n        if (strpos($cost['VALUE_TEMP'], '{counter:') === 0) {\n            // Extract format mask from VALUE_TEMP\n            $formatMask = $this->extractFormatMask($cost['VALUE_TEMP']);\n\n            // Generate counter value\n            $counterValue = $this->generateCounter($dimension, $cost['COD_VAR'], $formatMask);\n\n            // Set field value\n            $data[$cost['COD_VAR']] = $counterValue;\n        }\n    }\n}\n\npublic function generateCounter(string $dimension, string $field, string $formatMask): string {\n    // 1. Lock counter row for update (prevents race conditions)\n    $counter = $this->pdo->query(\n        \"SELECT * FROM TB_COUNTER\n         WHERE COD_DIM = :dim AND COD_VAR = :field\n         FOR UPDATE\",\n        ['dim' => $dimension, 'field' => $field]\n    )->fetch();\n\n    // 2. Check if reset needed\n    $currentDate = date('Ymd');\n    if ($this->needsReset($counter, $currentDate)) {\n        $counter['COUNTER_VALUE'] = 0;\n        $counter['LAST_RESET_DATE'] = $currentDate;\n    }\n\n    // 3. Increment counter\n    $counter['COUNTER_VALUE']++;\n\n    // 4. Format with mask\n    $formattedValue = $this->applyFormatMask($formatMask, $counter['COUNTER_VALUE']);\n\n    // 5. Update counter in database\n    $this->pdo->execute(\n        \"UPDATE TB_COUNTER\n         SET COUNTER_VALUE = :value,\n             LAST_RESET_DATE = :reset_date,\n             UPDATED_AT = NOW()\n         WHERE COD_DIM = :dim AND COD_VAR = :field\",\n        [\n            'value' => $counter['COUNTER_VALUE'],\n            'reset_date' => $counter['LAST_RESET_DATE'],\n            'dim' => $dimension,\n            'field' => $field\n        ]\n    );\n\n    return $formattedValue;\n}\n\nprivate function applyFormatMask(string $mask, int $counterValue): string {\n    $replacements = [\n        '{YYYY}' => date('Y'),\n        '{YY}' => date('y'),\n        '{MM}' => date('m'),\n        '{M}' => date('n'),\n        '{DD}' => date('d'),\n        '{D}' => date('j')\n    ];\n\n    // Replace date tokens\n    $formatted = str_replace(array_keys($replacements), array_values($replacements), $mask);\n\n    // Replace counter tokens\n    if (preg_match('/{N+}/', $formatted, $matches)) {\n        $padding = strlen($matches[0]) - 2;  // {NNN} = 3 padding\n        $formatted = preg_replace('/{N+}/', str_pad($counterValue, $padding, '0', STR_PAD_LEFT), $formatted);\n    }\n\n    return $formatted;\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Response:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "status": "success",\n  "data": {\n    "PRD_ID": "uuid-...",\n    "XPRD01": "Widget Pro",\n    "XPRD02": 99.99,\n    "XPRD03": "PRD-2025-001",  // Auto-generated\n    "TREC": "N"\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"reset-periods",children:"Reset Periods"}),"\n",(0,s.jsx)(n.h3,{id:"reset_period-values",children:"RESET_PERIOD Values"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"YEARLY:"})," Resets on January 1st"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"INSERT INTO TB_COUNTER (COD_DIM, COD_VAR, FORMAT_MASK, RESET_PERIOD)\nVALUES ('PRD', 'XPRD03', 'PRD-{YYYY}-{NNN}', 'YEARLY');\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"2024-12-31: PRD-2024-999\n2025-01-01: PRD-2025-001  \u2190 Reset to 1\n2025-01-02: PRD-2025-002\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"MONTHLY:"})," Resets on 1st of each month"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"INSERT INTO TB_COUNTER (COD_DIM, COD_VAR, FORMAT_MASK, RESET_PERIOD)\nVALUES ('INV', 'XINV01', 'INV-{YYYY}{MM}-{NNN}', 'MONTHLY');\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"2025-11-30: INV-202511-999\n2025-12-01: INV-202512-001  \u2190 Reset to 1\n2025-12-02: INV-202512-002\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"DAILY:"})," Resets every day"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"INSERT INTO TB_COUNTER (COD_DIM, COD_VAR, FORMAT_MASK, RESET_PERIOD)\nVALUES ('ORD', 'XORD01', 'ORD-{YYYY}{MM}{DD}-{NNNN}', 'DAILY');\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"2025-12-18: ORD-20251218-9999\n2025-12-19: ORD-20251219-0001  \u2190 Reset to 1\n2025-12-19: ORD-20251219-0002\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"NEVER:"})," Never resets (continuous sequence)"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"INSERT INTO TB_COUNTER (COD_DIM, COD_VAR, FORMAT_MASK, RESET_PERIOD)\nVALUES ('USR', 'XUSR03', 'USR-{NNNNNN}', 'NEVER');\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"USR-000001, USR-000002, ..., USR-999999, USR-1000000\n"})}),"\n",(0,s.jsx)(n.h2,{id:"concurrent-safety",children:"Concurrent Safety"}),"\n",(0,s.jsx)(n.h3,{id:"row-level-locking",children:"Row-Level Locking"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"SELECT FOR UPDATE prevents race conditions:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Transaction A              Transaction B\n    |                          |\nBEGIN                      BEGIN\n    |                          |\nSELECT ... FOR UPDATE          |\n(locks counter row)            |\n    |                          |\n    |                     SELECT ... FOR UPDATE\n    |                     [BLOCKED - waiting for A]\n    |                          |\nCOUNTER_VALUE++                |\n    |                          |\nUPDATE TB_COUNTER              |\n    |                          |\nCOMMIT                         |\n(releases lock)                |\n    |                          |\n    |                     [UNBLOCKED]\n    |                     COUNTER_VALUE++\n    |                     UPDATE TB_COUNTER\n    |                     COMMIT\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Result:"})," No duplicate counter values, even under high concurrency."]}),"\n",(0,s.jsx)(n.h2,{id:"multiple-counters-per-dimension",children:"Multiple Counters Per Dimension"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Different counters for different purposes:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Product code counter (SKU)\nINSERT INTO TB_COUNTER (COD_DIM, COD_VAR, FORMAT_MASK, RESET_PERIOD)\nVALUES ('PRD', 'XPRD03', 'PRD-{YYYY}-{NNN}', 'YEARLY');\n\n-- Product barcode counter (EAN)\nINSERT INTO TB_COUNTER (COD_DIM, COD_VAR, FORMAT_MASK, RESET_PERIOD)\nVALUES ('PRD', 'XPRD_BARCODE', '{NNNNNNNNNNNN}', 'NEVER');\n"})}),"\n",(0,s.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsx)(n.h3,{id:"-do",children:"\u2705 DO:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Use counters for user-facing codes:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- \u2705 Good - readable codes\nFORMAT_MASK = 'PRD-{YYYY}-{NNN}'\nResult: PRD-2025-001\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Include year in format for yearly reset:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- \u2705 Good - year visible\nFORMAT_MASK = 'INV-{YYYY}-{NNNN}'\nResult: INV-2025-0001\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Use appropriate padding:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- \u2705 Good - 4 digits for ~10k/year\nFORMAT_MASK = 'ORD-{YYYY}-{NNNN}'\nResult: ORD-2025-0001 to ORD-2025-9999\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Let CoreWrite manage counters:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// \u2705 Good - automatic\n{\n  "data": {\n    "XPRD01": "Product Name"\n    // XPRD03 auto-generated\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"-dont",children:"\u274c DON'T:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Don't try to set counter value manually:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// \u274c Bad - will be rejected (COD_ON_OFF=\'LDR\')\n{\n  "data": {\n    "XPRD01": "Product",\n    "XPRD03": "PRD-2025-999"  // Read-only!\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Don't use short padding for high volume:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- \u274c Bad - only 999 per year\nFORMAT_MASK = 'PRD-{YYYY}-{NN}'\nResult: PRD-2025-99 (max!)\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Don't forget year for yearly reset:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- \u274c Bad - ambiguous dates\nFORMAT_MASK = 'INV-{NNN}'\nResult: INV-001 (which year?)\n\n-- \u2705 Good\nFORMAT_MASK = 'INV-{YYYY}-{NNN}'\nResult: INV-2025-001\n"})}),"\n",(0,s.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,s.jsx)(n.h3,{id:"duplicate-counter-values",children:"Duplicate Counter Values"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Symptom:"})," Duplicate codes generated"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cause:"})," Missing ",(0,s.jsx)(n.code,{children:"FOR UPDATE"})," lock"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Solution:"})," Ensure CoreWrite uses row locking:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// \u2705 Correct - with lock\nSELECT * FROM TB_COUNTER WHERE ... FOR UPDATE\n\n// \u274c Wrong - no lock\nSELECT * FROM TB_COUNTER WHERE ...\n"})}),"\n",(0,s.jsx)(n.h3,{id:"counter-not-resetting",children:"Counter Not Resetting"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Symptom:"})," Counter continues incrementing past reset date"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cause:"})," ",(0,s.jsx)(n.code,{children:"LAST_RESET_DATE"})," not updated"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Fix:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Manual reset\nUPDATE TB_COUNTER\nSET COUNTER_VALUE = 0,\n    LAST_RESET_DATE = CURDATE()\nWHERE COD_DIM = 'PRD' AND COD_VAR = 'XPRD03';\n"})}),"\n",(0,s.jsx)(n.h3,{id:"counter-value-too-high",children:"Counter Value Too High"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Symptom:"})," PRD-2025-10000 (expected max 9999)"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cause:"})," Insufficient padding in format mask"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Fix:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Increase padding\nUPDATE TB_COUNTER\nSET FORMAT_MASK = 'PRD-{YYYY}-{NNNNN}'  -- 5 digits instead of 4\nWHERE COD_DIM = 'PRD' AND COD_VAR = 'XPRD03';\n"})}),"\n",(0,s.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u2705 TB_COUNTER manages sequential identifiers"}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 Format masks: ",(0,s.jsx)(n.code,{children:"{YYYY}"}),", ",(0,s.jsx)(n.code,{children:"{MM}"}),", ",(0,s.jsx)(n.code,{children:"{DD}"}),", ",(0,s.jsx)(n.code,{children:"{NNN}"})]}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Reset periods: YEARLY, MONTHLY, DAILY, NEVER"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Row-level locking prevents duplicates"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Automatic generation via TB_COST.VALUE_TEMP"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Read-only fields (COD_ON_OFF without N/M flags)"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key Takeaways:"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Counters generate human-readable codes automatically"}),"\n",(0,s.jsxs)(n.li,{children:["Format mask defines structure: ",(0,s.jsx)(n.code,{children:"PRD-{YYYY}-{NNN}"})]}),"\n",(0,s.jsx)(n.li,{children:"Reset period controls when counter resets"}),"\n",(0,s.jsx)(n.li,{children:"SELECT FOR UPDATE ensures concurrent safety"}),"\n",(0,s.jsx)(n.li,{children:"COD_ON_OFF='LDR' makes counter read-only"}),"\n",(0,s.jsx)(n.li,{children:"No manual management needed"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Counter Configuration:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Component"}),(0,s.jsx)(n.th,{children:"Purpose"}),(0,s.jsx)(n.th,{children:"Example"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"COD_DIM"}),(0,s.jsx)(n.td,{children:"Dimension"}),(0,s.jsx)(n.td,{children:"PRD"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"COD_VAR"}),(0,s.jsx)(n.td,{children:"Field"}),(0,s.jsx)(n.td,{children:"XPRD03"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"FORMAT_MASK"}),(0,s.jsx)(n.td,{children:"Format"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PRD-{YYYY}-{NNN}"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"RESET_PERIOD"}),(0,s.jsx)(n.td,{children:"When to reset"}),(0,s.jsx)(n.td,{children:"YEARLY"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"COUNTER_VALUE"}),(0,s.jsx)(n.td,{children:"Current value"}),(0,s.jsx)(n.td,{children:"42"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Generated:"})," PRD-2025-042"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Next:"})," ",(0,s.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/error-handling",children:"Error Handling \u2192"})]}),"\n",(0,s.jsx)(n.h2,{id:"related-concepts",children:"Related Concepts"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/create-operations",children:"Create Operations"})," - Counter generation on POST"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/field-visibility",children:"Field Visibility"})," - COD_ON_OFF read-only"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/map-framework",children:"MAP Framework"})," - TB_COUNTER metadata"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.M)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},2172:(e,n,r)=>{r.d(n,{I:()=>l,M:()=>d});var s=r(1504);const t={},i=s.createContext(t);function d(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:d(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);