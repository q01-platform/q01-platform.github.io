"use strict";(self.webpackChunkq_01_docs=self.webpackChunkq_01_docs||[]).push([[6260],{6488:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>t,metadata:()=>l,toc:()=>d});var r=i(7624),s=i(2172);const t={title:"CQRS Pattern in Q01",sidebar_label:"CQRS Pattern",sidebar_position:5,description:"Understanding Command Query Responsibility Segregation in Q01 Core APIs"},c="CQRS Pattern in Q01 Core APIs",l={id:"products/map.q01.io/core-api-platform-v4/introduction/cqrs-pattern",title:"CQRS Pattern in Q01",description:"Understanding Command Query Responsibility Segregation in Q01 Core APIs",source:"@site/docs/products/map.q01.io/core-api-platform-v4/00-introduction/cqrs-pattern.md",sourceDirName:"products/map.q01.io/core-api-platform-v4/00-introduction",slug:"/products/map.q01.io/core-api-platform-v4/introduction/cqrs-pattern",permalink:"/docs/products/map.q01.io/core-api-platform-v4/introduction/cqrs-pattern",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:5,frontMatter:{title:"CQRS Pattern in Q01",sidebar_label:"CQRS Pattern",sidebar_position:5,description:"Understanding Command Query Responsibility Segregation in Q01 Core APIs"},sidebar:"mapSidebar",previous:{title:"Architecture Overview",permalink:"/docs/products/map.q01.io/core-api-platform-v4/introduction/architecture-overview"},next:{title:"Quick Start",permalink:"/docs/products/map.q01.io/core-api-platform-v4/introduction/quick-start"}},a={},d=[{value:"What is CQRS?",id:"what-is-cqrs",level:2},{value:"Why CQRS in Q01?",id:"why-cqrs-in-q01",level:2},{value:"Problem: Different Optimization Needs",id:"problem-different-optimization-needs",level:3},{value:"Solution: Separate Read and Write Services",id:"solution-separate-read-and-write-services",level:3},{value:"Q01&#39;s CQRS Implementation",id:"q01s-cqrs-implementation",level:2},{value:"CoreService: Unified API Surface",id:"coreservice-unified-api-surface",level:3},{value:"Routing Logic",id:"routing-logic",level:3},{value:"CoreQuery: Read-Optimized Service",id:"corequery-read-optimized-service",level:2},{value:"Responsibilities",id:"responsibilities",level:3},{value:"Optimizations",id:"optimizations",level:3},{value:"Trade-Offs",id:"trade-offs",level:3},{value:"CoreWrite: Write-Optimized Service",id:"corewrite-write-optimized-service",level:2},{value:"Responsibilities",id:"responsibilities-1",level:3},{value:"Optimizations",id:"optimizations-1",level:3},{value:"Trade-Offs",id:"trade-offs-1",level:3},{value:"Consistency Model",id:"consistency-model",level:2},{value:"Immediate Consistency (Within CoreWrite)",id:"immediate-consistency-within-corewrite",level:3},{value:"Eventual Consistency (Across Services)",id:"eventual-consistency-across-services",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Benefits in Practice",id:"benefits-in-practice",level:2},{value:"Real-World Scenario",id:"real-world-scenario",level:3},{value:"Summary",id:"summary",level:2},{value:"Next Steps",id:"next-steps",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.M)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"cqrs-pattern-in-q01-core-apis",children:"CQRS Pattern in Q01 Core APIs"}),"\n",(0,r.jsx)(n.h2,{id:"what-is-cqrs",children:"What is CQRS?"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"CQRS (Command Query Responsibility Segregation)"})," is an architectural pattern that separates read operations (queries) from write operations (commands) using different models and often different infrastructure."]}),"\n",(0,r.jsx)(n.p,{children:"Traditional approach:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   API    \u2502\n\u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502\n     v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Database \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(n.p,{children:"CQRS approach:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Query API\u2502        \u2502Command API\u2502\n\u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518        \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502                   \u2502\n     v                   v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Read DB  \u2502  sync  \u2502 Write DB \u2502\n\u2502(optimized)\u2502<\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502(normalized)\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(n.h2,{id:"why-cqrs-in-q01",children:"Why CQRS in Q01?"}),"\n",(0,r.jsx)(n.h3,{id:"problem-different-optimization-needs",children:"Problem: Different Optimization Needs"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Reads"})," and ",(0,r.jsx)(n.strong,{children:"writes"})," have fundamentally different requirements:"]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Aspect"}),(0,r.jsx)(n.th,{children:"Reads"}),(0,r.jsx)(n.th,{children:"Writes"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Frequency"})}),(0,r.jsx)(n.td,{children:"80-90% of requests"}),(0,r.jsx)(n.td,{children:"10-20% of requests"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Latency"})}),(0,r.jsx)(n.td,{children:"Must be fast"}),(0,r.jsx)(n.td,{children:"Can be slightly slower"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Consistency"})}),(0,r.jsx)(n.td,{children:"Eventually consistent OK"}),(0,r.jsx)(n.td,{children:"Must be immediately consistent"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Caching"})}),(0,r.jsx)(n.td,{children:"Highly cacheable"}),(0,r.jsx)(n.td,{children:"Cannot cache"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Joins"})}),(0,r.jsx)(n.td,{children:"Many joins for rich data"}),(0,r.jsx)(n.td,{children:"Minimal joins for validation"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Scaling"})}),(0,r.jsx)(n.td,{children:"Read replicas, caching"}),(0,r.jsx)(n.td,{children:"Transaction logs, write-ahead logs"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Optimization"})}),(0,r.jsx)(n.td,{children:"Denormalized views"}),(0,r.jsx)(n.td,{children:"Normalized schema"})]})]})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"One model cannot optimize for both."})}),"\n",(0,r.jsx)(n.h3,{id:"solution-separate-read-and-write-services",children:"Solution: Separate Read and Write Services"}),"\n",(0,r.jsx)(n.p,{children:"Q01 implements CQRS at the service level:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502 CoreService  \u2502  \u2190 Single API surface\n          \u2502 (API Gateway)\u2502\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                 \u2502\n       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n       \u2502                   \u2502\n       v                   v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 CoreQuery   \u2502     \u2502 CoreWrite   \u2502\n\u2502 (PHP/Symfony)\u2502     \u2502 (PHP/Symfony)\u2502\n\u2502             \u2502     \u2502             \u2502\n\u2502 Read-optimized\u2502     \u2502Write-optimized\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502                   \u2502\n       v                   v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502Read Database\u2502  sync\u2502Write Database\u2502\n\u2502 (can be     \u2502<\u2500\u2500\u2500\u2500\u2500\u2502 (normalized, \u2502\n\u2502  denormalized,\u2502     \u2502  transactional)\u2502\n\u2502  cached)    \u2502     \u2502             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(n.h2,{id:"q01s-cqrs-implementation",children:"Q01's CQRS Implementation"}),"\n",(0,r.jsx)(n.h3,{id:"coreservice-unified-api-surface",children:"CoreService: Unified API Surface"}),"\n",(0,r.jsxs)(n.p,{children:["Despite internal separation, ",(0,r.jsx)(n.strong,{children:"clients see a single unified API"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-http",children:"# Read operation\nGET /api/v4/core/PRD?source=productList\n\n# Write operation\nPOST /api/v4/core/PRD\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"CoreService routes transparently"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"HTTP method determines routing"}),"\n",(0,r.jsx)(n.li,{children:"Clients don't know (or care) about internal backends"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"routing-logic",children:"Routing Logic"}),"\n",(0,r.jsx)(n.p,{children:"The gateway uses a simple rule-based routing mechanism:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   Incoming Request Analysis         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u2502\n               v\n       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n       \u2502 HTTP Method?  \u2502\n       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u2502\n       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n       \u2502                \u2502\n       v                v\n  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n  \u2502  GET   \u2502      \u2502POST/PUT/ \u2502\n  \u2502        \u2502      \u2502PATCH/DEL \u2502\n  \u2514\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518\n      \u2502                \u2502\n      v                v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 CoreQuery   \u2502  \u2502 CoreWrite   \u2502\n\u2502 (Read API)  \u2502  \u2502 (Write API) \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nRoute Examples:\n\u2022 GET    /api/v4/core/PRD           \u2192 CoreQuery\n\u2022 GET    /api/v4/core/PRD/123       \u2192 CoreQuery\n\u2022 GET    /api/v4/core/PRD/fields    \u2192 CoreQuery\n\u2022 POST   /api/v4/core/PRD           \u2192 CoreWrite\n\u2022 PUT    /api/v4/core/PRD/123       \u2192 CoreWrite\n\u2022 PATCH  /api/v4/core/PRD/123       \u2192 CoreWrite\n\u2022 DELETE /api/v4/core/PRD/123       \u2192 CoreWrite\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Benefits"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u2705 Clients use standard REST verbs"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 No special headers or parameters needed"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Backend changes transparent to clients"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Can evolve read/write infrastructure independently"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"corequery-read-optimized-service",children:"CoreQuery: Read-Optimized Service"}),"\n",(0,r.jsx)(n.h3,{id:"responsibilities",children:"Responsibilities"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Metadata-driven query construction"})," from TB_COST, TB_OBJECT"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Field visibility filtering"})," by COD_ON_OFF and center_dett"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Permission enforcement"})," via peso and source"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Dynamic SQL generation"})," with optimal joins"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Result formatting"})," and projection"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"optimizations",children:"Optimizations"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"1. Database Views"})," (via TB_OBJECT with TYPE_OBJ=1):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Instead of joining 5 tables on every query:\nSELECT p.*, c.name as category, s.name as supplier, ...\nFROM products p\nJOIN categories c ON p.category_id = c.id\nJOIN suppliers s ON p.supplier_id = s.id\n-- (expensive for frequent reads)\n\n-- Create database view via TB_OBJECT:\nCREATE VIEW v_products_enriched AS\nSELECT p.*, c.name as category, s.name as supplier, ...\nFROM products p\nLEFT JOIN categories c ON p.category_id = c.id\nLEFT JOIN suppliers s ON p.supplier_id = s.id;\n\n-- Query the view (fast):\nSELECT * FROM v_products_enriched WHERE price > 100;\n"})}),"\n",(0,r.jsx)(n.p,{children:"TB_OBJECT metadata with TYPE_OBJ=1 defines database views, CoreQuery uses them automatically."}),"\n",(0,r.jsx)(n.p,{children:'For TYPE_OBJ=2 ("OGGETTI SELECT"), CoreQuery executes select-of-selects without requiring a physical database view.'}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"2. Projection"})," (only fetch needed fields):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-http",children:"# Instead of SELECT * (slow, wasteful):\nGET /api/v4/core/PRD\n\n# Client requests specific fields (fast):\nGET /api/v4/core/PRD?$select=XPRD01,XPRD02\n\n# CoreQuery generates:\nSELECT XPRD01, XPRD02 FROM TB_ANAG_PRD00 WHERE ...\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"3. Filtering at Database"})," (not in application):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-http",children:"GET /api/v4/core/PRD?$filter=XPRD02 gt 100 AND XPRD06 eq 1\n\n# CoreQuery generates WHERE clause:\nSELECT * FROM TB_ANAG_PRD00 WHERE XPRD02 > 100 AND XPRD06 = 1\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Note: Use filter operators (",(0,r.jsx)(n.code,{children:"gt"}),", ",(0,r.jsx)(n.code,{children:"lt"}),", ",(0,r.jsx)(n.code,{children:"eq"}),", ",(0,r.jsx)(n.code,{children:"ne"}),", ",(0,r.jsx)(n.code,{children:"ge"}),", ",(0,r.jsx)(n.code,{children:"le"}),") instead of SQL symbols to prevent SQL injection."]}),"\n",(0,r.jsx)(n.p,{children:"Database applies filters efficiently with indexes."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"4. Pagination"})," (limit data transfer):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-http",children:"GET /api/v4/core/PRD?$offset=100&$num_rows=50\n\n# CoreQuery generates:\nSELECT * FROM TB_ANAG_PRD00 LIMIT 50 OFFSET 100\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"5. Field-Level Caching"})," (possible future enhancement):"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Cache TB_COST metadata (rarely changes)"}),"\n",(0,r.jsx)(n.li,{children:"Cache TB_TYPE_FIELDS definitions"}),"\n",(0,r.jsx)(n.li,{children:"Reduce metadata queries significantly"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"6. Read Replicas"})," (possible scaling):"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Point CoreQuery to read-only database replica"}),"\n",(0,r.jsx)(n.li,{children:"Distribute read load across multiple databases"}),"\n",(0,r.jsx)(n.li,{children:"Write operations unaffected"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"trade-offs",children:"Trade-Offs"}),"\n",(0,r.jsxs)(n.p,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Fast reads (optimized queries, views, caching)"}),"\n",(0,r.jsx)(n.li,{children:"Scalable (read replicas, horizontal scaling)"}),"\n",(0,r.jsx)(n.li,{children:"Flexible (supports complex filters, projections)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u274c ",(0,r.jsx)(n.strong,{children:"Cons"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Eventually consistent"})," - if using read replicas with replication lag"]}),"\n",(0,r.jsx)(n.li,{children:"Cannot modify data (read-only service)"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"corewrite-write-optimized-service",children:"CoreWrite: Write-Optimized Service"}),"\n",(0,r.jsx)(n.h3,{id:"responsibilities-1",children:"Responsibilities"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Multi-layer validation"})," (token, grant, required fields, types)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Pre-insert functions"})," (counters, UUIDs, sequences)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Transaction management"})," (ACID guarantees)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Cascade operations"})," (INSERT_CASCADE, UPDATE_CASCADE, DELETE_CASCADE)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Outbox pattern"})," (write-ahead log for event sourcing)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"RabbitMQ publishing"})," (distribute change events)"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"optimizations-1",children:"Optimizations"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"1. Transactional Consistency"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Everything in a single transaction\n$this->db_data->beginTransaction();\n\n// Main write\nINSERT INTO TB_ANAG_PRD00 (...) VALUES (...);\n\n// Cascades (if metadata defines them)\nINSERT INTO TB_ANAG_PRDDET00 (...) VALUES (...);\n\n// Outbox for event sourcing\nINSERT INTO TB_ANAG_OUTBOX00 (...) VALUES (...);\n\n$this->db_data->commit();\n\n// ACID guarantee: all succeed or all fail\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"2. Outbox Pattern"})," (at-least-once delivery):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502         Database                 \u2502\n\u2502                                  \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510               \u2502\n\u2502  \u2502TB_ANAG_PRD00 \u2502  Main Data    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518               \u2502\n\u2502                                  \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510               \u2502\n\u2502  \u2502TB_ANAG_OUTBOX\u2502  Write-Ahead  \u2502\n\u2502  \u2502     00       \u2502    Log        \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518               \u2502\n\u2502                                  \u2502\n\u2502  Both written in same transaction\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502\n       \u2502 After commit\n       v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  RabbitMQ    \u2502  Async publish\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nIf RabbitMQ is down:\n- Transaction still commits\n- Outbox record remains\n- Background job retries publish\n"})}),"\n",(0,r.jsx)(n.p,{children:"Guarantees: Data is safe even if message broker fails."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"3. Batch Operations"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-http",children:'POST /api/v4/core/PRD\n[\n  {source: "...", XPRD01: "Product 1", XPRD02: 10},\n  {source: "...", XPRD01: "Product 2", XPRD02: 20},\n  {source: "...", XPRD01: "Product 3", XPRD02: 30}\n]\n\n# Single transaction for all three inserts\n# Reduces roundtrips, improves throughput\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"4. Validation Caching"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Cache TB_COST metadata (validation rules)"}),"\n",(0,r.jsx)(n.li,{children:"Cache TB_COUNTER metadata (counter configurations)"}),"\n",(0,r.jsx)(n.li,{children:"Avoid redundant metadata queries"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"5. Connection Pooling"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Reuse database connections across requests"}),"\n",(0,r.jsx)(n.li,{children:"Reduce connection overhead"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"trade-offs-1",children:"Trade-Offs"}),"\n",(0,r.jsxs)(n.p,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Strong consistency (ACID transactions)"}),"\n",(0,r.jsx)(n.li,{children:"Guaranteed event delivery (outbox pattern)"}),"\n",(0,r.jsx)(n.li,{children:"Cascades handled automatically"}),"\n",(0,r.jsx)(n.li,{children:"Audit trail built-in"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u274c ",(0,r.jsx)(n.strong,{children:"Cons"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Slower than reads"})," (validation, transactions, outbox overhead)"]}),"\n",(0,r.jsx)(n.li,{children:"Harder to scale horizontally (write bottleneck)"}),"\n",(0,r.jsx)(n.li,{children:"Cannot use caching (data must be fresh)"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"consistency-model",children:"Consistency Model"}),"\n",(0,r.jsx)(n.h3,{id:"immediate-consistency-within-corewrite",children:"Immediate Consistency (Within CoreWrite)"}),"\n",(0,r.jsxs)(n.p,{children:["All changes in a single transaction are ",(0,r.jsx)(n.strong,{children:"immediately consistent"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Create order + order items in one transaction\nbeginTransaction();\n  INSERT INTO TB_ANAG_ORD00 (...);  // order\n  INSERT INTO TB_ANAG_ORDITEM00 (...);  // item 1\n  INSERT INTO TB_ANAG_ORDITEM00 (...);  // item 2\ncommit();\n\n// If any INSERT fails, ALL rollback - no partial state\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Read-Your-Writes Consistency"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"1. Client creates product via CoreWrite\n2. CoreWrite commits transaction, returns success\n3. Client immediately reads product via CoreQuery\n4. CoreQuery returns the just-created product\n\n\u2705 Guaranteed to see your own writes\n"})}),"\n",(0,r.jsx)(n.h3,{id:"eventual-consistency-across-services",children:"Eventual Consistency (Across Services)"}),"\n",(0,r.jsxs)(n.p,{children:["Changes propagated via RabbitMQ are ",(0,r.jsx)(n.strong,{children:"eventually consistent"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"1. CoreWrite creates order in database\n2. CoreWrite publishes event to RabbitMQ\n3. Inventory service subscribes to events\n4. Inventory service receives event (async, some delay)\n5. Inventory service reserves stock\n\nThere's a delay (typically < 100ms) between steps 1 and 5.\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"This is acceptable"})," because:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Subscribers are separate microservices (not Core APIs)"}),"\n",(0,r.jsx)(n.li,{children:"Business workflows can tolerate brief delays"}),"\n",(0,r.jsx)(n.li,{children:"At-least-once delivery guarantees eventual consistency"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsx)(n.p,{children:"Environment variables control backend endpoints:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Read API (CoreQuery)\nR_API_HOST=corequery-service\nR_API_PORT=8081\nR_API_VERSION=v4\n\n# Write API (CoreWrite)\nW_API_HOST=corewrite-service\nW_API_PORT=8082\nW_API_VERSION=v4\n"})}),"\n",(0,r.jsx)(n.p,{children:"CoreService uses these to construct backend URLs:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"GET request \u2192 http://corequery-service:8081/api/v4/core/PRD\nPOST request \u2192 http://corewrite-service:8082/api/v4/core/PRD\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Can be scaled independently"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Deploy 5 CoreQuery instances for high read load"}),"\n",(0,r.jsx)(n.li,{children:"Deploy 2 CoreWrite instances for moderate write load"}),"\n",(0,r.jsx)(n.li,{children:"Scale each based on actual usage patterns"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"benefits-in-practice",children:"Benefits in Practice"}),"\n",(0,r.jsx)(n.h3,{id:"real-world-scenario",children:"Real-World Scenario"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"E-commerce platform"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"90% reads (browsing products, viewing orders)"}),"\n",(0,r.jsx)(n.li,{children:"10% writes (checkout, update cart)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Traditional monolith"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"All requests \u2192 Same server \u2192 Same database\nPeak traffic: 10,000 req/s\n\nServer must handle:\n- 9,000 read req/s (fast queries)\n- 1,000 write req/s (slow transactions)\n\nWrites block reads. Reads slow down. Everything suffers.\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Q01 with CQRS"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"9,000 reads \u2192 CoreQuery \u2192 Read replica (optimized for reads)\n1,000 writes \u2192 CoreWrite \u2192 Write master (optimized for writes)\n\nCoreQuery:\n- Uses denormalized views\n- Caches metadata\n- Horizontal scaling (3 instances = 3,000 req/s each)\n- Fast, consistent performance\n\nCoreWrite:\n- Handles transactions safely\n- Publishes events asynchronously\n- Doesn't block reads\n- Focused optimization\n\nResult: 10x better performance with same infrastructure\n"})}),"\n",(0,r.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,r.jsxs)(n.p,{children:["Q01 implements ",(0,r.jsx)(n.strong,{children:"CQRS at the service level"}),":"]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Aspect"}),(0,r.jsx)(n.th,{children:"CoreQuery"}),(0,r.jsx)(n.th,{children:"CoreWrite"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Purpose"})}),(0,r.jsx)(n.td,{children:"Read operations"}),(0,r.jsx)(n.td,{children:"Write operations"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Optimization"})}),(0,r.jsx)(n.td,{children:"Speed, scalability"}),(0,r.jsx)(n.td,{children:"Consistency, reliability"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Consistency"})}),(0,r.jsx)(n.td,{children:"Eventually consistent (acceptable)"}),(0,r.jsx)(n.td,{children:"Immediately consistent (required)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Caching"})}),(0,r.jsx)(n.td,{children:"Yes (metadata, results)"}),(0,r.jsx)(n.td,{children:"No (must be fresh)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Scaling"})}),(0,r.jsx)(n.td,{children:"Horizontal (read replicas)"}),(0,r.jsx)(n.td,{children:"Vertical (better hardware)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Routing"})}),(0,r.jsx)(n.td,{children:"GET requests"}),(0,r.jsx)(n.td,{children:"POST/PUT/PATCH/DELETE requests"})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Key benefits"}),":"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Performance"})," - reads don't block writes, writes don't slow reads"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Scalability"})," - scale read and write infrastructure independently"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Flexibility"})," - optimize each service for its specific needs"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Transparency"})," - clients see unified API surface"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Key trade-offs"}),":"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u26a0\ufe0f ",(0,r.jsx)(n.strong,{children:"Complexity"})," - two services instead of one"]}),"\n",(0,r.jsxs)(n.li,{children:["\u26a0\ufe0f ",(0,r.jsx)(n.strong,{children:"Consistency"})," - eventual consistency for cross-service events"]}),"\n",(0,r.jsxs)(n.li,{children:["\u26a0\ufe0f ",(0,r.jsx)(n.strong,{children:"Infrastructure"})," - requires message queue (RabbitMQ)"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["For multi-tenant SaaS platforms with read-heavy workloads, ",(0,r.jsx)(n.strong,{children:"CQRS is a net win"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Try the ",(0,r.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/introduction/quick-start",children:"Quick Start"})," to see CQRS in action"]}),"\n",(0,r.jsxs)(n.li,{children:["Understand ",(0,r.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/",children:"Core Concepts"})," that power both services"]}),"\n",(0,r.jsxs)(n.li,{children:["Learn ",(0,r.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/query-patterns/",children:"Query Patterns"})," for CoreQuery"]}),"\n",(0,r.jsxs)(n.li,{children:["Learn ",(0,r.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/",children:"Write Patterns"})," for CoreWrite"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.M)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},2172:(e,n,i)=>{i.d(n,{I:()=>l,M:()=>c});var r=i(1504);const s={},t=r.createContext(s);function c(e){const n=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);