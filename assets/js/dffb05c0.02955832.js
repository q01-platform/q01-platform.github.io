"use strict";(self.webpackChunkq_01_docs=self.webpackChunkq_01_docs||[]).push([[5028],{9752:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>h,frontMatter:()=>l,metadata:()=>d,toc:()=>a});var s=r(7624),i=r(2172);const l={title:"Entity Lifecycle - TREC States",sidebar_label:"8. Entity Lifecycle",sidebar_position:9,description:"Understanding record lifecycle tracking through TREC states and audit trail fields"},t="Entity Lifecycle: TREC State Management",d={id:"products/map.q01.io/core-api-platform-v4/core-concepts/entity-lifecycle",title:"Entity Lifecycle - TREC States",description:"Understanding record lifecycle tracking through TREC states and audit trail fields",source:"@site/docs/products/map.q01.io/core-api-platform-v4/01-core-concepts/entity-lifecycle.md",sourceDirName:"products/map.q01.io/core-api-platform-v4/01-core-concepts",slug:"/products/map.q01.io/core-api-platform-v4/core-concepts/entity-lifecycle",permalink:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/entity-lifecycle",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:9,frontMatter:{title:"Entity Lifecycle - TREC States",sidebar_label:"8. Entity Lifecycle",sidebar_position:9,description:"Understanding record lifecycle tracking through TREC states and audit trail fields"},sidebar:"mapSidebar",previous:{title:"7. Nested Set Model",permalink:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/nested-set-model"},next:{title:"9. Cascade Operations",permalink:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/cascades"}},c={},a=[{value:"What is TREC?",id:"what-is-trec",level:2},{value:"The Four TREC States",id:"the-four-trec-states",level:2},{value:"Visual State Flow",id:"visual-state-flow",level:3},{value:"Audit Trail Fields",id:"audit-trail-fields",level:2},{value:"Automatic TREC Management",id:"automatic-trec-management",level:2},{value:"1. CREATE Operation (POST)",id:"1-create-operation-post",level:3},{value:"2. UPDATE Operation (PUT/PATCH)",id:"2-update-operation-putpatch",level:3},{value:"3. DELETE Operation (Soft Delete)",id:"3-delete-operation-soft-delete",level:3},{value:"4. DELETE Operation (Physical Delete)",id:"4-delete-operation-physical-delete",level:3},{value:"Provvisorio State (TREC=&#39;P&#39;)",id:"provvisorio-state-trecp",level:2},{value:"What is TREC=&#39;P&#39;?",id:"what-is-trecp",level:3},{value:"Use Cases",id:"use-cases",level:3},{value:"Querying by TREC State",id:"querying-by-trec-state",level:2},{value:"Default Behavior: Exclude Cancelled",id:"default-behavior-exclude-cancelled",level:3},{value:"Including Cancelled Records",id:"including-cancelled-records",level:3},{value:"Only Cancelled Records",id:"only-cancelled-records",level:3},{value:"Common Patterns",id:"common-patterns",level:2},{value:"Pattern 1: Soft Delete with Recovery",id:"pattern-1-soft-delete-with-recovery",level:3},{value:"Pattern 2: Audit Trail Report",id:"pattern-2-audit-trail-report",level:3},{value:"Pattern 3: Working with Draft Records",id:"pattern-3-working-with-draft-records",level:3},{value:"TREC in Cascade Operations",id:"trec-in-cascade-operations",level:2},{value:"Example: Order with Items",id:"example-order-with-items",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"\u2705 DO: Trust Automatic TREC Management",id:"-do-trust-automatic-trec-management",level:3},{value:"\u2705 DO: Use Soft Delete by Default",id:"-do-use-soft-delete-by-default",level:3},{value:"\u2705 DO: Query Audit Trail for Compliance",id:"-do-query-audit-trail-for-compliance",level:3},{value:"\u2705 DO: Use TREC=&#39;P&#39; for Draft/Provisional Data",id:"-do-use-trecp-for-draftprovisional-data",level:3},{value:"\u274c DON&#39;T: Manually Set TREC in Requests",id:"-dont-manually-set-trec-in-requests",level:3},{value:"\u274c DON&#39;T: Use Physical Delete for Routine Operations",id:"-dont-use-physical-delete-for-routine-operations",level:3},{value:"\u274c DON&#39;T: Assume TREC=&#39;N&#39; Means Unmodified",id:"-dont-assume-trecn-means-unmodified",level:3},{value:"Common Pitfalls",id:"common-pitfalls",level:2},{value:"Pitfall 1: Filtering TREC in Application Code",id:"pitfall-1-filtering-trec-in-application-code",level:3},{value:"Pitfall 2: Not Handling Cascade TREC in UI",id:"pitfall-2-not-handling-cascade-trec-in-ui",level:3},{value:"Pitfall 3: Ignoring TIMESTAMP for Concurrency",id:"pitfall-3-ignoring-timestamp-for-concurrency",level:3},{value:"Summary",id:"summary",level:2}];function o(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.M)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"entity-lifecycle-trec-state-management",children:"Entity Lifecycle: TREC State Management"}),"\n",(0,s.jsx)(n.h2,{id:"what-is-trec",children:"What is TREC?"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"TREC"})," (Transaction Record State) is a single-character field present in ",(0,s.jsx)(n.strong,{children:"every dimension table"})," (",(0,s.jsx)(n.code,{children:"TB_ANAG_{DIM}00"}),") that tracks the lifecycle state of each record."]}),"\n",(0,s.jsx)(n.p,{children:"Combined with audit trail fields (OWNER, CDATA, LOWNER, LDATA, TIMESTAMP), TREC enables:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Soft delete"})," - Non-destructive data archiving"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"State tracking"})," - Understanding record history"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Audit trails"})," - Who created/modified what and when"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Data recovery"})," - Undeleting cancelled records"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key Insight:"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["TREC is not just a status field - it's the foundation for ",(0,s.jsx)(n.strong,{children:"non-destructive data management"})," throughout Q01 Core APIs."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"the-four-trec-states",children:"The Four TREC States"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"State"}),(0,s.jsx)(n.th,{children:"Code"}),(0,s.jsx)(n.th,{children:"Meaning"}),(0,s.jsx)(n.th,{children:"Set By"}),(0,s.jsx)(n.th,{children:"Use Case"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"New"})}),(0,s.jsx)(n.td,{children:"N"}),(0,s.jsx)(n.td,{children:"Newly created record"}),(0,s.jsx)(n.td,{children:"CoreWrite on INSERT"}),(0,s.jsx)(n.td,{children:"Fresh records not yet modified"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Modified"})}),(0,s.jsx)(n.td,{children:"M"}),(0,s.jsx)(n.td,{children:"Record has been updated"}),(0,s.jsx)(n.td,{children:"CoreWrite on UPDATE"}),(0,s.jsx)(n.td,{children:"Records with changes since creation"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Cancelled"})}),(0,s.jsx)(n.td,{children:"C"}),(0,s.jsx)(n.td,{children:"Soft deleted record"}),(0,s.jsx)(n.td,{children:"CoreWrite on DELETE"}),(0,s.jsx)(n.td,{children:"Archived/deleted data (recoverable)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Provvisorio"})}),(0,s.jsx)(n.td,{children:"P"}),(0,s.jsx)(n.td,{children:"Provisional/temporary record"}),(0,s.jsx)(n.td,{children:"Manual/system logic"}),(0,s.jsx)(n.td,{children:"Draft records, temporary data, work in progress"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"visual-state-flow",children:"Visual State Flow"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"    CREATE              UPDATE              DELETE\n      \u2193                   \u2193                   \u2193\n   \u250c\u2500\u2500\u2500\u2500\u2500\u2510           \u250c\u2500\u2500\u2500\u2500\u2500\u2510             \u250c\u2500\u2500\u2500\u2500\u2500\u2510\n   \u2502  N  \u2502  ------\u2192  \u2502  M  \u2502  --------\u2192  \u2502  C  \u2502\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2518           \u2514\u2500\u2500\u2500\u2500\u2500\u2518             \u2514\u2500\u2500\u2500\u2500\u2500\u2518\n     New             Modified            Cancelled\n      \u2502                 \u2502                     \u2191\n      \u2502                 \u2502                     \u2502\n      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n              (can also transition directly)\n\n   \u250c\u2500\u2500\u2500\u2500\u2500\u2510\n   \u2502  P  \u2502  \u2190 Set manually - provisional/draft state\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2518\n  Provvisorio\n"})}),"\n",(0,s.jsx)(n.h2,{id:"audit-trail-fields",children:"Audit Trail Fields"}),"\n",(0,s.jsx)(n.p,{children:"Every dimension table includes these standard fields:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Field"}),(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Purpose"}),(0,s.jsx)(n.th,{children:"Auto-Populated"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"OWNER"})}),(0,s.jsx)(n.td,{children:"varchar(50)"}),(0,s.jsx)(n.td,{children:"User ID who created record"}),(0,s.jsx)(n.td,{children:"\u2705 On INSERT"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"CDATA"})}),(0,s.jsx)(n.td,{children:"varchar(14)"}),(0,s.jsx)(n.td,{children:"Creation date (YYYYMMDDHHmmss)"}),(0,s.jsx)(n.td,{children:"\u2705 On INSERT"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"LOWNER"})}),(0,s.jsx)(n.td,{children:"varchar(50)"}),(0,s.jsx)(n.td,{children:"User ID who last modified record"}),(0,s.jsx)(n.td,{children:"\u2705 On UPDATE"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"LDATA"})}),(0,s.jsx)(n.td,{children:"varchar(14)"}),(0,s.jsx)(n.td,{children:"Last modification date"}),(0,s.jsx)(n.td,{children:"\u2705 On UPDATE"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"TIMESTAMP"})}),(0,s.jsx)(n.td,{children:"varchar(20)"}),(0,s.jsx)(n.td,{children:"Microsecond timestamp"}),(0,s.jsx)(n.td,{children:"\u2705 On INSERT/UPDATE"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"TREC"})}),(0,s.jsx)(n.td,{children:"char(1)"}),(0,s.jsx)(n.td,{children:"Record state (N/M/C/P)"}),(0,s.jsx)(n.td,{children:"\u2705 On INSERT/UPDATE/DELETE"})]})]})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example Record:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "PRD_ID": "123",\n  "XPRD01": "Premium Widget",\n  "XPRD02": 49.99,\n  "OWNER": "user_5",\n  "CDATA": "20250115103045",\n  "LOWNER": "user_12",\n  "LDATA": "20250118141522",\n  "TIMESTAMP": "1737207322485000",\n  "TREC": "M"\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Interpretation:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Created by ",(0,s.jsx)(n.code,{children:"user_5"})," on January 15, 2025 at 10:30:45"]}),"\n",(0,s.jsxs)(n.li,{children:["Last modified by ",(0,s.jsx)(n.code,{children:"user_12"})," on January 18, 2025 at 14:15:22"]}),"\n",(0,s.jsx)(n.li,{children:"Current state: Modified (M)"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"automatic-trec-management",children:"Automatic TREC Management"}),"\n",(0,s.jsx)(n.p,{children:"CoreWrite automatically manages TREC transitions during CRUD operations:"}),"\n",(0,s.jsx)(n.h3,{id:"1-create-operation-post",children:"1. CREATE Operation (POST)"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Default Behavior:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"INSERT INTO TB_ANAG_PRD00 (\n  XPRD01, XPRD02,\n  OWNER, CDATA, LOWNER, LDATA, TIMESTAMP, TREC\n) VALUES (\n  'Widget', 49.99,\n  'user_5', '20250115103045', 'user_5', '20250115103045', '1737207322485000', 'N'\n);\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"TREC State:"})," ",(0,s.jsx)(n.code,{children:"N"})," (New)"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Audit Fields:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"OWNER"})," = Current user from JWT"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"CDATA"})," = Current timestamp (YYYYMMDDHHmmss)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"LOWNER"})," = Same as OWNER (first modification)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"LDATA"})," = Same as CDATA"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"TIMESTAMP"})," = Microsecond timestamp"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Code Reference:"})," ",(0,s.jsx)(n.code,{children:"DataStore.php:876"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"$sql .= \" TREC = '\" . ($param['TREC'] ? $param['TREC'] : 'N') . \"', \";\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-update-operation-putpatch",children:"2. UPDATE Operation (PUT/PATCH)"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Default Behavior:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"UPDATE TB_ANAG_PRD00 SET\n  XPRD02 = 59.99,\n  LOWNER = 'user_12',\n  LDATA = '20250118141522',\n  TIMESTAMP = '1737207322485000',\n  TREC = 'M'\nWHERE PRD_ID = '123';\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"TREC State:"})," ",(0,s.jsx)(n.code,{children:"M"})," (Modified)"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Audit Fields:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"OWNER"})," and ",(0,s.jsx)(n.code,{children:"CDATA"})," remain unchanged"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"LOWNER"})," = Current user from JWT"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"LDATA"})," = Current timestamp"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"TIMESTAMP"})," = Updated microsecond timestamp"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Code Reference:"})," ",(0,s.jsx)(n.code,{children:"DataStore.php:822"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"$dupKey .= \"TREC = 'M', \";\n"})}),"\n",(0,s.jsx)(n.h3,{id:"3-delete-operation-soft-delete",children:"3. DELETE Operation (Soft Delete)"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Default Behavior:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"UPDATE TB_ANAG_PRD00 SET\n  TREC = 'C',\n  LOWNER = 'user_12',\n  LDATA = '20250119095030'\nWHERE PRD_ID = '123';\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"TREC State:"})," ",(0,s.jsx)(n.code,{children:"C"})," (Cancelled)"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"What Happens:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Record ",(0,s.jsx)(n.strong,{children:"remains in database"})]}),"\n",(0,s.jsx)(n.li,{children:"Marked as cancelled (TREC='C')"}),"\n",(0,s.jsx)(n.li,{children:"Standard queries exclude TREC='C' by default"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"LOWNER"})," and ",(0,s.jsx)(n.code,{children:"LDATA"})," track who deleted and when"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Code Reference:"})," ",(0,s.jsx)(n.code,{children:"DataStore.php:2420"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"$sqlDel = \"update TB_ANAG_{$dim}00 set TREC = 'C', LDATA = :LDATA where {$dim}_ID = :value\";\n"})}),"\n",(0,s.jsx)(n.h3,{id:"4-delete-operation-physical-delete",children:"4. DELETE Operation (Physical Delete)"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Force Delete:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:"DELETE /api/v4/core/PRD/123?forceDelete=true\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Behavior:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"DELETE FROM TB_ANAG_PRD00 WHERE PRD_ID = '123';\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"TREC State:"})," N/A (record physically removed)"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"When to Use:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Removing test data"}),"\n",(0,s.jsx)(n.li,{children:"Compliance requirements (GDPR right to be forgotten)"}),"\n",(0,s.jsx)(n.li,{children:"Data corruption cleanup"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Warning:"})," Physical deletes are ",(0,s.jsx)(n.strong,{children:"irreversible"})," and should be rare."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Code Reference:"})," ",(0,s.jsx)(n.code,{children:"DataStore.php:2414"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"if ($flag && $this->_skipTREC == false) {\n    // Soft delete (TREC='C')\n} else {\n    // Physical delete\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"provvisorio-state-trecp",children:"Provvisorio State (TREC='P')"}),"\n",(0,s.jsx)(n.h3,{id:"what-is-trecp",children:"What is TREC='P'?"}),"\n",(0,s.jsxs)(n.p,{children:["Records with ",(0,s.jsx)(n.code,{children:"TREC='P'"})," represent ",(0,s.jsx)(n.strong,{children:"provisional or draft data"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Temporary records not yet finalized"}),"\n",(0,s.jsx)(n.li,{children:"Draft documents or work in progress"}),"\n",(0,s.jsx)(n.li,{children:"Data pending approval or validation"}),"\n",(0,s.jsx)(n.li,{children:"Can be filtered out from production queries"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"use-cases",children:"Use Cases"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example 1: Draft Order"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Order being prepared, not yet submitted\nINSERT INTO TB_ANAG_ORD00 (XORD01, XORD02, TREC, ...)\nVALUES ('Draft Order', 'Customer Name', 'P', ...);\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example 2: Temporary Product Entry"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Product being configured, not ready for sale\nUPDATE TB_ANAG_PRD00 SET TREC = 'P'\nWHERE PRD_ID = 123 AND XPRD13 = 'DRAFT';\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Code Reference:"})," ",(0,s.jsx)(n.code,{children:"CleanExpiredSessions.php:85"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"$sql = \"select SESSIONS_ID, TREC, XSESSIONS05, XSESSIONS12\n        from TB_ANAG_SESSIONS00\n        where TREC != 'P'\n        order by XSESSIONS05 desc\";\n"})}),"\n",(0,s.jsx)(n.p,{children:"Session cleanup excludes TREC='P' records (provisional sessions)."}),"\n",(0,s.jsx)(n.h2,{id:"querying-by-trec-state",children:"Querying by TREC State"}),"\n",(0,s.jsx)(n.h3,{id:"default-behavior-exclude-cancelled",children:"Default Behavior: Exclude Cancelled"}),"\n",(0,s.jsxs)(n.p,{children:["CoreQuery ",(0,s.jsx)(n.strong,{children:"automatically excludes TREC='C'"})," unless explicitly requested:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:"GET /api/v4/core/PRD?source=productList&center_dett=visualizza\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Generated SQL:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM TB_ANAG_PRD00\nWHERE TREC != 'C'  -- Automatically added\nORDER BY PRD_ID;\n"})}),"\n",(0,s.jsx)(n.h3,{id:"including-cancelled-records",children:"Including Cancelled Records"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Explicit TREC Filter:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:"GET /api/v4/core/PRD?source=productList&center_dett=visualizza&cond_trec=N,M,C\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Generated SQL:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM TB_ANAG_PRD00\nWHERE TREC IN ('N', 'M', 'C')  -- All states including cancelled\nORDER BY PRD_ID;\n"})}),"\n",(0,s.jsx)(n.h3,{id:"only-cancelled-records",children:"Only Cancelled Records"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Archive Query:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:"GET /api/v4/core/PRD?source=productList&center_dett=visualizza&cond_trec=C\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Use Case:"})," Recovering deleted data, audit reports."]}),"\n",(0,s.jsx)(n.h2,{id:"common-patterns",children:"Common Patterns"}),"\n",(0,s.jsx)(n.h3,{id:"pattern-1-soft-delete-with-recovery",children:"Pattern 1: Soft Delete with Recovery"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Scenario:"})," User deletes product by mistake, then wants to recover it."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Step 1: Soft Delete"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:"DELETE /api/v4/core/PRD/123\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Result:"})," TREC='C', record still exists."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Step 2: Recover"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:'PATCH /api/v4/core/PRD/123\n{\n  "TREC": "M"\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Result:"})," TREC='M', record visible again."]}),"\n",(0,s.jsx)(n.h3,{id:"pattern-2-audit-trail-report",children:"Pattern 2: Audit Trail Report"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Query:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:"GET /api/v4/core/PRD?source=productList&center_dett=visualizza&cond_trec=N,M,C&$select=PRD_ID,XPRD01,TREC,OWNER,CDATA,LOWNER,LDATA\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Response:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'[\n  {\n    "PRD_ID": "123",\n    "XPRD01": "Widget A",\n    "TREC": "M",\n    "OWNER": "user_5",\n    "CDATA": "20250115103045",\n    "LOWNER": "user_12",\n    "LDATA": "20250118141522"\n  },\n  {\n    "PRD_ID": "124",\n    "XPRD01": "Widget B",\n    "TREC": "C",\n    "OWNER": "user_8",\n    "CDATA": "20250110080000",\n    "LOWNER": "user_8",\n    "LDATA": "20250119095030"\n  }\n]\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Interpretation:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Product 123: Modified by user_12 on Jan 18"}),"\n",(0,s.jsx)(n.li,{children:"Product 124: Deleted by user_8 on Jan 19"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"pattern-3-working-with-draft-records",children:"Pattern 3: Working with Draft Records"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Mark as Provisional/Draft:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:'PATCH /api/v4/core/PRD/999\n{\n  "TREC": "P"\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Result:"})," Product 999 marked as provisional/draft, can be filtered from production queries."]}),"\n",(0,s.jsx)(n.h2,{id:"trec-in-cascade-operations",children:"TREC in Cascade Operations"}),"\n",(0,s.jsx)(n.p,{children:"When cascading deletes, TREC propagates:"}),"\n",(0,s.jsx)(n.h3,{id:"example-order-with-items",children:"Example: Order with Items"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Dimension Setup:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"TB_DIM: ORD (orders)\nTB_DIM: ORDITEM (order items)\n\nTB_COST:\n- XORDITEM01 (foreign key to ORD)\n- DELETE_CASCADE configured on XORDITEM01\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Delete Order:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:"DELETE /api/v4/core/ORD/555\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Cascade Behavior:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Parent record\nUPDATE TB_ANAG_ORD00 SET TREC = 'C', LDATA = '20250119095030' WHERE ORD_ID = '555';\n\n-- Cascaded child records\nUPDATE TB_ANAG_ORDITEM00 SET TREC = 'C', LDATA = '20250119095030' WHERE XORDITEM01 = '555';\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Result:"})," Order and all items marked TREC='C', recoverable as unit."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Code Reference:"})," ",(0,s.jsx)(n.code,{children:"DataStore.php:2372"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"$q = \"update TB_ANAG_{$tbl}00 set TREC = 'C', LDATA = '\" . date(\"YmdHis\") . \"' where {$joinField} = '{$cascadeVal}'\";\n"})}),"\n",(0,s.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsx)(n.h3,{id:"-do-trust-automatic-trec-management",children:"\u2705 DO: Trust Automatic TREC Management"}),"\n",(0,s.jsx)(n.p,{children:"CoreWrite sets TREC correctly during operations:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"INSERT \u2192 TREC='N'"}),"\n",(0,s.jsx)(n.li,{children:"UPDATE \u2192 TREC='M'"}),"\n",(0,s.jsx)(n.li,{children:"DELETE \u2192 TREC='C'"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"No manual TREC manipulation needed."})}),"\n",(0,s.jsx)(n.h3,{id:"-do-use-soft-delete-by-default",children:"\u2705 DO: Use Soft Delete by Default"}),"\n",(0,s.jsxs)(n.p,{children:["Reserve physical delete (",(0,s.jsx)(n.code,{children:"forceDelete=true"}),") for exceptional cases:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Test data cleanup"}),"\n",(0,s.jsx)(n.li,{children:"Legal compliance (GDPR)"}),"\n",(0,s.jsx)(n.li,{children:"Data corruption"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Default soft delete enables recovery."})}),"\n",(0,s.jsx)(n.h3,{id:"-do-query-audit-trail-for-compliance",children:"\u2705 DO: Query Audit Trail for Compliance"}),"\n",(0,s.jsx)(n.p,{children:"Use OWNER, CDATA, LOWNER, LDATA for:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Regulatory audits"}),"\n",(0,s.jsx)(n.li,{children:"Change tracking"}),"\n",(0,s.jsx)(n.li,{children:"User activity reports"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example Query:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:"GET /api/v4/core/PRD?$filter=LDATA gt 20250101000000&$select=PRD_ID,XPRD01,LOWNER,LDATA\n"})}),"\n",(0,s.jsx)(n.p,{children:"All products modified after January 1, 2025."}),"\n",(0,s.jsx)(n.h3,{id:"-do-use-trecp-for-draftprovisional-data",children:"\u2705 DO: Use TREC='P' for Draft/Provisional Data"}),"\n",(0,s.jsx)(n.p,{children:"Mark temporary or work-in-progress records:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Draft orders before submission"}),"\n",(0,s.jsx)(n.li,{children:"Product configurations being set up"}),"\n",(0,s.jsx)(n.li,{children:"Documents pending approval"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"-dont-manually-set-trec-in-requests",children:"\u274c DON'T: Manually Set TREC in Requests"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Wrong:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:'POST /api/v4/core/PRD\n{\n  "XPRD01": "Widget",\n  "TREC": "N"\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Why:"})," CoreWrite sets TREC automatically. Manual values can cause inconsistencies."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Right:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:'POST /api/v4/core/PRD\n{\n  "XPRD01": "Widget"\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["CoreWrite adds ",(0,s.jsx)(n.code,{children:"TREC='N'"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"-dont-use-physical-delete-for-routine-operations",children:"\u274c DON'T: Use Physical Delete for Routine Operations"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Wrong:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:"DELETE /api/v4/core/PRD/123?forceDelete=true\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Why:"})," Irreversible, no audit trail, breaks cascades."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Right:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:"DELETE /api/v4/core/PRD/123\n"})}),"\n",(0,s.jsx)(n.p,{children:"Soft delete (TREC='C') preserves data."}),"\n",(0,s.jsx)(n.h3,{id:"-dont-assume-trecn-means-unmodified",children:"\u274c DON'T: Assume TREC='N' Means Unmodified"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Misconception:"})," TREC='N' means record never changed."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Reality:"})," TREC='N' means:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Created but not yet updated via PUT/PATCH"}),"\n",(0,s.jsx)(n.li,{children:"May have been modified via duplicate key logic (INSERT with ON DUPLICATE KEY UPDATE)"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Check LDATA vs CDATA for true modification detection:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'if (record.LDATA !== record.CDATA) {\n  console.log("Record was modified");\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"common-pitfalls",children:"Common Pitfalls"}),"\n",(0,s.jsx)(n.h3,{id:"pitfall-1-filtering-trec-in-application-code",children:"Pitfall 1: Filtering TREC in Application Code"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Wrong:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// Client-side filtering\nconst activeProducts = allProducts.filter(p => p.TREC !== 'C');\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Why:"})," Wasteful - CoreQuery already excludes TREC='C' by default."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Right:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:"GET /api/v4/core/PRD?source=productList\n"})}),"\n",(0,s.jsx)(n.p,{children:"CoreQuery returns only TREC !='C' automatically."}),"\n",(0,s.jsx)(n.h3,{id:"pitfall-2-not-handling-cascade-trec-in-ui",children:"Pitfall 2: Not Handling Cascade TREC in UI"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Scenario:"})," Deleting order marks items as TREC='C', but UI still shows items."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Solution:"})," Refresh related data after delete:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"await api.delete(`/core/ORD/${orderId}`);\n// Refresh order items list - they're now TREC='C'\nawait fetchOrderItems(orderId, { cond_trec: 'N,M' });\n"})}),"\n",(0,s.jsx)(n.h3,{id:"pitfall-3-ignoring-timestamp-for-concurrency",children:"Pitfall 3: Ignoring TIMESTAMP for Concurrency"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Scenario:"})," Two users update same record simultaneously."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Problem:"})," Last write wins, no conflict detection."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Solution:"})," Use TIMESTAMP for optimistic locking:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:'PUT /api/v4/core/PRD/123\n{\n  "XPRD02": 59.99,\n  "TIMESTAMP": "1737207322485000"  // From GET response\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"CoreWrite can validate TIMESTAMP hasn't changed (if configured)."}),"\n",(0,s.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"TREC State Management"})," enables:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Non-destructive deletes"})," - Soft delete (TREC='C') preserves data"]}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"State tracking"})," - N/M/C/P lifecycle visibility"]}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Audit trails"})," - OWNER, CDATA, LOWNER, LDATA track changes"]}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Data recovery"})," - Undelete by changing TREC='C' to TREC='M'"]}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Protection"})," - TREC='P' prevents accidental deletion"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key Insights:"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["TREC is not optional metadata - it's the ",(0,s.jsx)(n.strong,{children:"foundation for safe data operations"})," in Q01 Core APIs. Trust automatic TREC management, use soft delete by default, and leverage audit fields for compliance."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Next Concept:"})}),"\n",(0,s.jsxs)(n.p,{children:["Continue to ",(0,s.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/cascades",children:"Cascade Operations"})," to understand how TREC propagates across related dimensions."]})]})}function h(e={}){const{wrapper:n}={...(0,i.M)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},2172:(e,n,r)=>{r.d(n,{I:()=>d,M:()=>t});var s=r(1504);const i={},l=s.createContext(i);function t(e){const n=s.useContext(l);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);