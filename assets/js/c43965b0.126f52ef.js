"use strict";(self.webpackChunkq_01_docs=self.webpackChunkq_01_docs||[]).push([[2112],{4040:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>l});var o=t(7624),s=t(2172);const r={title:"Webhook Integration",sidebar_label:"Webhook Integration",sidebar_position:7,description:"External system notifications via webhooks"},i="Webhook Integration",a={id:"products/map.q01.io/core-api-platform-v4/advanced-topics/webhook-integration",title:"Webhook Integration",description:"External system notifications via webhooks",source:"@site/docs/products/map.q01.io/core-api-platform-v4/06-advanced-topics/webhook-integration.md",sourceDirName:"products/map.q01.io/core-api-platform-v4/06-advanced-topics",slug:"/products/map.q01.io/core-api-platform-v4/advanced-topics/webhook-integration",permalink:"/docs/products/map.q01.io/core-api-platform-v4/advanced-topics/webhook-integration",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:7,frontMatter:{title:"Webhook Integration",sidebar_label:"Webhook Integration",sidebar_position:7,description:"External system notifications via webhooks"},sidebar:"mapSidebar",previous:{title:"Performance Optimization",permalink:"/docs/products/map.q01.io/core-api-platform-v4/advanced-topics/performance-optimization"},next:{title:"Custom Functions",permalink:"/docs/products/map.q01.io/core-api-platform-v4/advanced-topics/custom-functions"}},c={},l=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Webhook Registration",id:"webhook-registration",level:2},{value:"Register Webhook Endpoint",id:"register-webhook-endpoint",level:3},{value:"Webhook Configuration",id:"webhook-configuration",level:3},{value:"Webhook Dispatcher Implementation",id:"webhook-dispatcher-implementation",level:2},{value:"Node.js Webhook Dispatcher",id:"nodejs-webhook-dispatcher",level:3},{value:"Webhook Receiver Implementation",id:"webhook-receiver-implementation",level:2},{value:"Verify Webhook Signature",id:"verify-webhook-signature",level:3},{value:"PHP Webhook Receiver",id:"php-webhook-receiver",level:3},{value:"Webhook Payload Structure",id:"webhook-payload-structure",level:2},{value:"Standard Webhook Payload",id:"standard-webhook-payload",level:3},{value:"HTTP Headers",id:"http-headers",level:3},{value:"Event Filtering",id:"event-filtering",level:2},{value:"Filter by Dimension",id:"filter-by-dimension",level:3},{value:"Filter by Event Type",id:"filter-by-event-type",level:3},{value:"Filter by Field Value",id:"filter-by-field-value",level:3},{value:"Error Handling and Retry",id:"error-handling-and-retry",level:2},{value:"Exponential Backoff",id:"exponential-backoff",level:3},{value:"Circuit Breaker Pattern",id:"circuit-breaker-pattern",level:3},{value:"Webhook Monitoring",id:"webhook-monitoring",level:2},{value:"TB_WEBHOOK_LOG Table",id:"tb_webhook_log-table",level:3},{value:"Monitor Webhook Health",id:"monitor-webhook-health",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"\u2705 DO:",id:"-do",level:3},{value:"\u274c DON&#39;T:",id:"-dont",level:3},{value:"Summary",id:"summary",level:2},{value:"Related Concepts",id:"related-concepts",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.M)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"webhook-integration",children:"Webhook Integration"}),"\n",(0,o.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Webhooks"})," enable Q01 Core APIs to notify external systems about data changes in real-time. They are implemented as ",(0,o.jsx)(n.strong,{children:"Outbox subscribers"})," that consume events from RabbitMQ and forward them to external HTTP endpoints."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Use Cases:"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Notify external CRM when customer created"}),"\n",(0,o.jsx)(n.li,{children:"Trigger fulfillment system on order placement"}),"\n",(0,o.jsx)(n.li,{children:"Update external analytics platform"}),"\n",(0,o.jsx)(n.li,{children:"Send data to third-party integrations"}),"\n",(0,o.jsx)(n.li,{children:"Synchronize with external databases"}),"\n",(0,o.jsx)(n.li,{children:"Trigger external workflows"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Benefits:"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"\u2705 Real-time notifications (instant updates)"}),"\n",(0,o.jsx)(n.li,{children:"\u2705 Decoupled integration (no direct dependencies)"}),"\n",(0,o.jsx)(n.li,{children:"\u2705 Reliable delivery (retry on failure)"}),"\n",(0,o.jsx)(n.li,{children:"\u2705 Event filtering (subscribe to specific events)"}),"\n",(0,o.jsx)(n.li,{children:"\u2705 Webhook signing (security verification)"}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"Write Operation (POST/PUT/DELETE)\n    \u2193\nCoreWrite inserts OUTBOX event\n    \u2193\nRabbitMQ Fanout Exchange (corewrite.fanout)\n    \u2193\nWebhook Dispatcher Subscriber\n    \u2193\nExternal HTTP Endpoints:\n\u251c\u2500\u2500 https://crm.example.com/webhooks/customer\n\u251c\u2500\u2500 https://analytics.example.com/events\n\u251c\u2500\u2500 https://fulfillment.example.com/orders\n\u2514\u2500\u2500 https://warehouse.example.com/inventory\n"})}),"\n",(0,o.jsx)(n.h2,{id:"webhook-registration",children:"Webhook Registration"}),"\n",(0,o.jsx)(n.h3,{id:"register-webhook-endpoint",children:"Register Webhook Endpoint"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Via API:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'# Register webhook for customer events\ncurl -X POST https://api.q01.io/api/v4/webhooks \\\n  -H "Authorization: Bearer $TOKEN" \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "url": "https://crm.example.com/webhooks/customer",\n    "events": ["CustomerCreated", "CustomerUpdated", "CustomerDeleted"],\n    "dimensions": ["CUST"],\n    "secret": "whsec_abc123xyz789",\n    "active": true,\n    "filters": {\n      "source": "tenant_123"\n    }\n  }\'\n'})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Response:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n  "webhook_id": "wh_xyz789",\n  "url": "https://crm.example.com/webhooks/customer",\n  "events": ["CustomerCreated", "CustomerUpdated", "CustomerDeleted"],\n  "dimensions": ["CUST"],\n  "secret": "whsec_abc123xyz789",\n  "active": true,\n  "created_at": "2025-12-19T10:00:00Z"\n}\n'})}),"\n",(0,o.jsx)(n.h3,{id:"webhook-configuration",children:"Webhook Configuration"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"TB_WEBHOOK metadata table:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE TB_WEBHOOK (\n  WEBHOOK_ID INT PRIMARY KEY AUTO_INCREMENT,\n  SOURCE VARCHAR(50) NOT NULL,          -- Tenant identifier\n  URL VARCHAR(500) NOT NULL,            -- Target endpoint\n  EVENTS JSON NOT NULL,                 -- Event types to send\n  DIMENSIONS JSON,                      -- Filter by dimensions\n  SECRET VARCHAR(100),                  -- Signing secret\n  ACTIVE CHAR(1) DEFAULT 'Y',          -- Y/N\n  RETRY_COUNT INT DEFAULT 3,           -- Max retries\n  TIMEOUT_MS INT DEFAULT 5000,         -- Request timeout\n  CREATED_AT TIMESTAMP DEFAULT NOW(),\n  UPDATED_AT TIMESTAMP DEFAULT NOW() ON UPDATE NOW(),\n  INDEX idx_webhook_source (SOURCE),\n  INDEX idx_webhook_active (ACTIVE)\n);\n"})}),"\n",(0,o.jsx)(n.h2,{id:"webhook-dispatcher-implementation",children:"Webhook Dispatcher Implementation"}),"\n",(0,o.jsx)(n.h3,{id:"nodejs-webhook-dispatcher",children:"Node.js Webhook Dispatcher"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"const amqp = require('amqplib');\nconst axios = require('axios');\nconst crypto = require('crypto');\n\nclass WebhookDispatcher {\n  constructor() {\n    this.subscriber = null;\n    this.webhooks = [];\n  }\n\n  async start() {\n    // Load webhooks from database\n    await this.loadWebhooks();\n\n    // Connect to RabbitMQ\n    this.subscriber = new OutboxSubscriber('webhook-dispatcher');\n    await this.subscriber.connect();\n\n    // Subscribe to events\n    await this.subscriber.subscribe(async (event) => {\n      await this.dispatchEvent(event);\n    });\n\n    console.log('[WebhookDispatcher] Started');\n  }\n\n  async loadWebhooks() {\n    // Load from database\n    const result = await db.query(`\n      SELECT * FROM TB_WEBHOOK\n      WHERE ACTIVE = 'Y'\n    `);\n\n    this.webhooks = result.map(row => ({\n      webhook_id: row.WEBHOOK_ID,\n      url: row.URL,\n      events: JSON.parse(row.EVENTS),\n      dimensions: JSON.parse(row.DIMENSIONS),\n      secret: row.SECRET,\n      retry_count: row.RETRY_COUNT,\n      timeout_ms: row.TIMEOUT_MS\n    }));\n\n    console.log(`[WebhookDispatcher] Loaded ${this.webhooks.length} webhooks`);\n  }\n\n  async dispatchEvent(event) {\n    const { EVENT_TYPE, AGGREGATE_TYPE, AGGREGATE_ID, PAYLOAD } = event;\n\n    // Find matching webhooks\n    const matchingWebhooks = this.webhooks.filter(webhook =>\n      webhook.events.includes(EVENT_TYPE) &&\n      (!webhook.dimensions || webhook.dimensions.includes(AGGREGATE_TYPE))\n    );\n\n    console.log(\n      `[WebhookDispatcher] Found ${matchingWebhooks.length} webhooks for ${EVENT_TYPE}`\n    );\n\n    // Dispatch to all matching webhooks\n    for (const webhook of matchingWebhooks) {\n      await this.sendWebhook(webhook, event);\n    }\n  }\n\n  async sendWebhook(webhook, event, attempt = 1) {\n    try {\n      const payload = this.buildPayload(event);\n      const signature = this.sign(payload, webhook.secret);\n\n      console.log(`[WebhookDispatcher] Sending to ${webhook.url} (attempt ${attempt})`);\n\n      const response = await axios.post(webhook.url, payload, {\n        headers: {\n          'Content-Type': 'application/json',\n          'X-Q01-Signature': signature,\n          'X-Q01-Event-Type': event.EVENT_TYPE,\n          'X-Q01-Event-ID': event.OUTBOX_ID,\n          'X-Q01-Timestamp': new Date().toISOString()\n        },\n        timeout: webhook.timeout_ms\n      });\n\n      console.log(`[WebhookDispatcher] Success: ${response.status}`);\n\n      // Log success\n      await this.logWebhook(webhook.webhook_id, event.OUTBOX_ID, 'success', null);\n    } catch (error) {\n      console.error(`[WebhookDispatcher] Error: ${error.message}`);\n\n      // Retry with exponential backoff\n      if (attempt < webhook.retry_count) {\n        const delay = Math.pow(2, attempt) * 1000; // 2s, 4s, 8s\n        console.log(`[WebhookDispatcher] Retrying in ${delay}ms...`);\n\n        await this.sleep(delay);\n        return this.sendWebhook(webhook, event, attempt + 1);\n      }\n\n      // Max retries exceeded - log failure\n      await this.logWebhook(webhook.webhook_id, event.OUTBOX_ID, 'failed', error.message);\n    }\n  }\n\n  buildPayload(event) {\n    return {\n      event_id: event.OUTBOX_ID,\n      event_type: event.EVENT_TYPE,\n      timestamp: event.CREATED_AT,\n      dimension: event.AGGREGATE_TYPE,\n      record_id: event.AGGREGATE_ID,\n      data: event.PAYLOAD\n    };\n  }\n\n  sign(payload, secret) {\n    if (!secret) return null;\n\n    const hmac = crypto.createHmac('sha256', secret);\n    hmac.update(JSON.stringify(payload));\n    return `sha256=${hmac.digest('hex')}`;\n  }\n\n  async logWebhook(webhookId, outboxId, status, error) {\n    await db.query(`\n      INSERT INTO TB_WEBHOOK_LOG\n      (WEBHOOK_ID, OUTBOX_ID, STATUS, ERROR_MESSAGE, CREATED_AT)\n      VALUES (?, ?, ?, ?, NOW())\n    `, [webhookId, outboxId, status, error]);\n  }\n\n  sleep(ms) {\n    return new Promise(resolve => setTimeout(resolve, ms));\n  }\n}\n\n// Start dispatcher\nconst dispatcher = new WebhookDispatcher();\ndispatcher.start().catch(console.error);\n"})}),"\n",(0,o.jsx)(n.h2,{id:"webhook-receiver-implementation",children:"Webhook Receiver Implementation"}),"\n",(0,o.jsx)(n.h3,{id:"verify-webhook-signature",children:"Verify Webhook Signature"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Node.js receiver:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"const express = require('express');\nconst crypto = require('crypto');\nconst bodyParser = require('body-parser');\n\nconst app = express();\n\n// Use raw body for signature verification\napp.use(bodyParser.json({\n  verify: (req, res, buf) => {\n    req.rawBody = buf.toString();\n  }\n}));\n\n// Webhook endpoint\napp.post('/webhooks/customer', (req, res) => {\n  const signature = req.headers['x-q01-signature'];\n  const secret = process.env.WEBHOOK_SECRET;\n\n  // Verify signature\n  if (!verifySignature(req.rawBody, signature, secret)) {\n    console.error('[Webhook] Invalid signature');\n    return res.status(401).json({ error: 'Invalid signature' });\n  }\n\n  // Process webhook\n  const { event_type, dimension, record_id, data } = req.body;\n\n  console.log(`[Webhook] Received: ${event_type} for ${dimension}/${record_id}`);\n\n  // Handle event\n  handleCustomerEvent(event_type, data)\n    .then(() => {\n      console.log('[Webhook] Processed successfully');\n      res.status(200).json({ received: true });\n    })\n    .catch(error => {\n      console.error('[Webhook] Error:', error);\n      res.status(500).json({ error: error.message });\n    });\n});\n\nfunction verifySignature(payload, signature, secret) {\n  if (!signature || !secret) return false;\n\n  const hmac = crypto.createHmac('sha256', secret);\n  hmac.update(payload);\n  const expectedSignature = `sha256=${hmac.digest('hex')}`;\n\n  return crypto.timingSafeEqual(\n    Buffer.from(signature),\n    Buffer.from(expectedSignature)\n  );\n}\n\nasync function handleCustomerEvent(eventType, data) {\n  switch (eventType) {\n    case 'CustomerCreated':\n      await createCustomerInCRM(data);\n      break;\n\n    case 'CustomerUpdated':\n      await updateCustomerInCRM(data);\n      break;\n\n    case 'CustomerDeleted':\n      await deleteCustomerInCRM(data);\n      break;\n\n    default:\n      console.log(`Unknown event type: ${eventType}`);\n  }\n}\n\napp.listen(3000, () => {\n  console.log('[Webhook] Receiver listening on port 3000');\n});\n"})}),"\n",(0,o.jsx)(n.h3,{id:"php-webhook-receiver",children:"PHP Webhook Receiver"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-php",children:"<?php\n// webhook-receiver.php\n\n$secret = getenv('WEBHOOK_SECRET');\n\n// Get raw body\n$payload = file_get_contents('php://input');\n$signature = $_SERVER['HTTP_X_Q01_SIGNATURE'] ?? '';\n\n// Verify signature\nif (!verifySignature($payload, $signature, $secret)) {\n    http_response_code(401);\n    echo json_encode(['error' => 'Invalid signature']);\n    exit;\n}\n\n// Parse payload\n$event = json_decode($payload, true);\n\n// Handle event\ntry {\n    handleEvent($event);\n    http_response_code(200);\n    echo json_encode(['received' => true]);\n} catch (Exception $e) {\n    http_response_code(500);\n    echo json_encode(['error' => $e->getMessage()]);\n}\n\nfunction verifySignature($payload, $signature, $secret) {\n    if (empty($signature) || empty($secret)) {\n        return false;\n    }\n\n    $expectedSignature = 'sha256=' . hash_hmac('sha256', $payload, $secret);\n\n    return hash_equals($expectedSignature, $signature);\n}\n\nfunction handleEvent($event) {\n    $eventType = $event['event_type'];\n    $data = $event['data'];\n\n    switch ($eventType) {\n        case 'CustomerCreated':\n            createCustomerInCRM($data);\n            break;\n\n        case 'CustomerUpdated':\n            updateCustomerInCRM($data);\n            break;\n\n        case 'CustomerDeleted':\n            deleteCustomerInCRM($data);\n            break;\n\n        default:\n            error_log(\"Unknown event type: $eventType\");\n    }\n}\n?>\n"})}),"\n",(0,o.jsx)(n.h2,{id:"webhook-payload-structure",children:"Webhook Payload Structure"}),"\n",(0,o.jsx)(n.h3,{id:"standard-webhook-payload",children:"Standard Webhook Payload"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n  "event_id": "outbox_123456",\n  "event_type": "CustomerCreated",\n  "timestamp": "2025-12-19T10:30:00Z",\n  "dimension": "CUST",\n  "record_id": 1234,\n  "data": {\n    "CUST_ID": 1234,\n    "XCUST01": "John Doe",\n    "XCUST02": "john.doe@example.com",\n    "XCUST03": "+1234567890",\n    "XCUST04": "123 Main St",\n    "CREATED_AT": "2025-12-19T10:30:00Z",\n    "UPDATED_AT": "2025-12-19T10:30:00Z"\n  }\n}\n'})}),"\n",(0,o.jsx)(n.h3,{id:"http-headers",children:"HTTP Headers"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-http",children:"POST /webhooks/customer HTTP/1.1\nHost: crm.example.com\nContent-Type: application/json\nX-Q01-Signature: sha256=abc123...\nX-Q01-Event-Type: CustomerCreated\nX-Q01-Event-ID: outbox_123456\nX-Q01-Timestamp: 2025-12-19T10:30:00Z\nContent-Length: 512\n\n{...}\n"})}),"\n",(0,o.jsx)(n.h2,{id:"event-filtering",children:"Event Filtering"}),"\n",(0,o.jsx)(n.h3,{id:"filter-by-dimension",children:"Filter by Dimension"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"// Only send product events\nconst webhook = {\n  url: 'https://warehouse.example.com/inventory',\n  events: ['ProductCreated', 'ProductUpdated', 'ProductDeleted'],\n  dimensions: ['PRD']  // Only PRD dimension\n};\n"})}),"\n",(0,o.jsx)(n.h3,{id:"filter-by-event-type",children:"Filter by Event Type"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"// Only send creation events\nconst webhook = {\n  url: 'https://analytics.example.com/new-customers',\n  events: ['CustomerCreated'],  // Only creation\n  dimensions: ['CUST']\n};\n"})}),"\n",(0,o.jsx)(n.h3,{id:"filter-by-field-value",children:"Filter by Field Value"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"class WebhookDispatcher {\n  async dispatchEvent(event) {\n    const matchingWebhooks = this.webhooks.filter(webhook => {\n      // Event type match\n      if (!webhook.events.includes(event.EVENT_TYPE)) {\n        return false;\n      }\n\n      // Dimension match\n      if (webhook.dimensions && !webhook.dimensions.includes(event.AGGREGATE_TYPE)) {\n        return false;\n      }\n\n      // Custom filters\n      if (webhook.filters) {\n        for (const [field, value] of Object.entries(webhook.filters)) {\n          if (event.PAYLOAD[field] !== value) {\n            return false;\n          }\n        }\n      }\n\n      return true;\n    });\n\n    for (const webhook of matchingWebhooks) {\n      await this.sendWebhook(webhook, event);\n    }\n  }\n}\n"})}),"\n",(0,o.jsx)(n.h2,{id:"error-handling-and-retry",children:"Error Handling and Retry"}),"\n",(0,o.jsx)(n.h3,{id:"exponential-backoff",children:"Exponential Backoff"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"async function sendWebhookWithRetry(webhook, event) {\n  const maxRetries = 5;\n  const baseDelay = 1000; // 1 second\n\n  for (let attempt = 1; attempt <= maxRetries; attempt++) {\n    try {\n      await axios.post(webhook.url, event, {\n        timeout: 5000,\n        headers: {\n          'X-Q01-Signature': sign(event, webhook.secret)\n        }\n      });\n\n      console.log('[Webhook] Success');\n      return;\n    } catch (error) {\n      console.error(`[Webhook] Attempt ${attempt} failed: ${error.message}`);\n\n      if (attempt === maxRetries) {\n        console.error('[Webhook] Max retries exceeded');\n        await logFailedWebhook(webhook, event, error);\n        return;\n      }\n\n      // Exponential backoff: 1s, 2s, 4s, 8s, 16s\n      const delay = baseDelay * Math.pow(2, attempt - 1);\n      console.log(`[Webhook] Retrying in ${delay}ms...`);\n      await sleep(delay);\n    }\n  }\n}\n"})}),"\n",(0,o.jsx)(n.h3,{id:"circuit-breaker-pattern",children:"Circuit Breaker Pattern"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"class CircuitBreaker {\n  constructor(threshold = 5, timeout = 60000) {\n    this.failureCount = 0;\n    this.threshold = threshold;\n    this.timeout = timeout;\n    this.state = 'CLOSED'; // CLOSED, OPEN, HALF_OPEN\n    this.nextAttempt = Date.now();\n  }\n\n  async execute(fn) {\n    if (this.state === 'OPEN') {\n      if (Date.now() < this.nextAttempt) {\n        throw new Error('Circuit breaker is OPEN');\n      }\n      this.state = 'HALF_OPEN';\n    }\n\n    try {\n      const result = await fn();\n      this.onSuccess();\n      return result;\n    } catch (error) {\n      this.onFailure();\n      throw error;\n    }\n  }\n\n  onSuccess() {\n    this.failureCount = 0;\n    this.state = 'CLOSED';\n  }\n\n  onFailure() {\n    this.failureCount++;\n\n    if (this.failureCount >= this.threshold) {\n      this.state = 'OPEN';\n      this.nextAttempt = Date.now() + this.timeout;\n      console.log(`[CircuitBreaker] OPEN for ${this.timeout}ms`);\n    }\n  }\n}\n\n// Usage\nconst breaker = new CircuitBreaker();\n\nasync function sendWebhook(webhook, event) {\n  try {\n    await breaker.execute(() =>\n      axios.post(webhook.url, event, { timeout: 5000 })\n    );\n  } catch (error) {\n    console.error('[Webhook] Failed (circuit breaker may be open)');\n  }\n}\n"})}),"\n",(0,o.jsx)(n.h2,{id:"webhook-monitoring",children:"Webhook Monitoring"}),"\n",(0,o.jsx)(n.h3,{id:"tb_webhook_log-table",children:"TB_WEBHOOK_LOG Table"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE TB_WEBHOOK_LOG (\n  LOG_ID BIGINT PRIMARY KEY AUTO_INCREMENT,\n  WEBHOOK_ID INT NOT NULL,\n  OUTBOX_ID BIGINT NOT NULL,\n  STATUS ENUM('success', 'failed', 'retrying') NOT NULL,\n  HTTP_STATUS INT,\n  ERROR_MESSAGE TEXT,\n  ATTEMPT_COUNT INT DEFAULT 1,\n  CREATED_AT TIMESTAMP DEFAULT NOW(),\n  INDEX idx_webhook_log_webhook (WEBHOOK_ID),\n  INDEX idx_webhook_log_status (STATUS),\n  INDEX idx_webhook_log_created (CREATED_AT)\n);\n"})}),"\n",(0,o.jsx)(n.h3,{id:"monitor-webhook-health",children:"Monitor Webhook Health"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"class WebhookMonitor {\n  async getWebhookStats(webhookId) {\n    const stats = await db.query(`\n      SELECT\n        COUNT(*) as total_deliveries,\n        SUM(CASE WHEN STATUS = 'success' THEN 1 ELSE 0 END) as successful,\n        SUM(CASE WHEN STATUS = 'failed' THEN 1 ELSE 0 END) as failed,\n        AVG(CASE WHEN STATUS = 'success' THEN ATTEMPT_COUNT END) as avg_attempts\n      FROM TB_WEBHOOK_LOG\n      WHERE WEBHOOK_ID = ?\n      AND CREATED_AT > DATE_SUB(NOW(), INTERVAL 24 HOUR)\n    `, [webhookId]);\n\n    const successRate = (stats.successful / stats.total_deliveries) * 100;\n\n    return {\n      webhook_id: webhookId,\n      total_deliveries: stats.total_deliveries,\n      successful: stats.successful,\n      failed: stats.failed,\n      success_rate: successRate.toFixed(2) + '%',\n      avg_attempts: stats.avg_attempts\n    };\n  }\n\n  async alertOnFailures(webhookId) {\n    const stats = await this.getWebhookStats(webhookId);\n\n    if (stats.success_rate < 90) {\n      await sendAlert({\n        title: 'Webhook Health Degraded',\n        webhook_id: webhookId,\n        success_rate: stats.success_rate,\n        failed: stats.failed\n      });\n    }\n  }\n}\n"})}),"\n",(0,o.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,o.jsx)(n.h3,{id:"-do",children:"\u2705 DO:"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Verify webhook signatures:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"// \u2705 Good - always verify\nif (!verifySignature(payload, signature, secret)) {\n  return res.status(401).json({ error: 'Invalid signature' });\n}\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Return 200 quickly:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"// \u2705 Good - acknowledge immediately, process async\napp.post('/webhook', async (req, res) => {\n  res.status(200).json({ received: true });\n\n  // Process asynchronously\n  processWebhook(req.body).catch(console.error);\n});\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Implement idempotency:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"// \u2705 Good - check if already processed\nif (await isProcessed(event.event_id)) {\n  return res.status(200).json({ received: true, duplicate: true });\n}\nawait process(event);\nawait markProcessed(event.event_id);\n"})}),"\n",(0,o.jsx)(n.h3,{id:"-dont",children:"\u274c DON'T:"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Don't ignore signatures:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"// \u274c Bad - security risk\napp.post('/webhook', (req, res) => {\n  // No signature verification!\n  processWebhook(req.body);\n});\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Don't block the response:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"// \u274c Bad - slow response\napp.post('/webhook', async (req, res) => {\n  await longRunningProcess(req.body);  // Blocks webhook delivery\n  res.status(200).json({ received: true });\n});\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Don't store secrets in code:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"// \u274c Bad - hardcoded secret\nconst secret = 'whsec_abc123xyz';\n\n// \u2705 Good - environment variable\nconst secret = process.env.WEBHOOK_SECRET;\n"})}),"\n",(0,o.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"\u2705 Webhooks enable real-time external system notifications"}),"\n",(0,o.jsx)(n.li,{children:"\u2705 Implemented as Outbox subscribers consuming RabbitMQ events"}),"\n",(0,o.jsx)(n.li,{children:"\u2705 Always verify webhook signatures for security"}),"\n",(0,o.jsx)(n.li,{children:"\u2705 Implement retry with exponential backoff"}),"\n",(0,o.jsx)(n.li,{children:"\u2705 Return 200 quickly, process asynchronously"}),"\n",(0,o.jsx)(n.li,{children:"\u2705 Filter events by dimension and event type"}),"\n",(0,o.jsx)(n.li,{children:"\u2705 Monitor webhook health and success rates"}),"\n",(0,o.jsx)(n.li,{children:"\u2705 Use circuit breaker for failing endpoints"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Key Takeaways:"})}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Webhooks decouple external integrations"}),"\n",(0,o.jsx)(n.li,{children:"Signature verification prevents unauthorized access"}),"\n",(0,o.jsx)(n.li,{children:"Exponential backoff handles transient failures"}),"\n",(0,o.jsx)(n.li,{children:"Circuit breaker protects against persistent failures"}),"\n",(0,o.jsx)(n.li,{children:"Idempotency prevents duplicate processing"}),"\n",(0,o.jsx)(n.li,{children:"Async processing keeps webhook responses fast"}),"\n",(0,o.jsx)(n.li,{children:"Monitor success rates and alert on degradation"}),"\n",(0,o.jsx)(n.li,{children:"Log all webhook deliveries for debugging"}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"related-concepts",children:"Related Concepts"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/advanced-topics/outbox-subscribers",children:"Outbox Subscribers"})," - RabbitMQ event consumers"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/outbox-pattern",children:"Outbox Pattern"})," - Event sourcing"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/advanced-topics",children:"Advanced Topics"})," - Overview"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.M)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},2172:(e,n,t)=>{t.d(n,{I:()=>a,M:()=>i});var o=t(1504);const s={},r=o.createContext(s);function i(e){const n=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),o.createElement(r.Provider,{value:n},e.children)}}}]);