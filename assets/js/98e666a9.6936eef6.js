"use strict";(self.webpackChunkq_01_docs=self.webpackChunkq_01_docs||[]).push([[3724],{9732:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var t=r(7624),s=r(2172);const o={title:"Delete Operations",sidebar_label:"Delete Operations (DELETE)",sidebar_position:5,description:"Soft delete and force delete with CASCADE operations"},a="Delete Operations (DELETE)",i={id:"products/map.q01.io/core-api-platform-v4/write-patterns/delete-operations",title:"Delete Operations",description:"Soft delete and force delete with CASCADE operations",source:"@site/docs/products/map.q01.io/core-api-platform-v4/04-write-patterns/delete-operations.md",sourceDirName:"products/map.q01.io/core-api-platform-v4/04-write-patterns",slug:"/products/map.q01.io/core-api-platform-v4/write-patterns/delete-operations",permalink:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/delete-operations",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:5,frontMatter:{title:"Delete Operations",sidebar_label:"Delete Operations (DELETE)",sidebar_position:5,description:"Soft delete and force delete with CASCADE operations"},sidebar:"mapSidebar",previous:{title:"Partial Updates (PATCH)",permalink:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/partial-updates"},next:{title:"Multi-Level Validation",permalink:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/validation"}},d={},l=[{value:"Overview",id:"overview",level:2},{value:"Soft Delete (Default)",id:"soft-delete-default",level:2},{value:"Behavior",id:"behavior",level:3},{value:"TREC State Transition",id:"trec-state-transition",level:3},{value:"Query Behavior After Soft Delete",id:"query-behavior-after-soft-delete",level:3},{value:"Force Delete (Permanent)",id:"force-delete-permanent",level:2},{value:"Behavior",id:"behavior-1",level:3},{value:"When to Use Force Delete",id:"when-to-use-force-delete",level:3},{value:"Restore (Undelete)",id:"restore-undelete",level:2},{value:"Restore Soft-Deleted Record",id:"restore-soft-deleted-record",level:3},{value:"DELETE_CASCADE Operations",id:"delete_cascade-operations",level:2},{value:"Soft Delete Cascades",id:"soft-delete-cascades",level:3},{value:"Force Delete Cascades",id:"force-delete-cascades",level:3},{value:"Outbox Event",id:"outbox-event",level:2},{value:"Delete Event Publication",id:"delete-event-publication",level:3},{value:"JavaScript Implementation",id:"javascript-implementation",level:2},{value:"Delete Service",id:"delete-service",level:3},{value:"Trash Management",id:"trash-management",level:3},{value:"Common Patterns",id:"common-patterns",level:2},{value:"Pattern 1: Soft Delete with Confirmation",id:"pattern-1-soft-delete-with-confirmation",level:3},{value:"Pattern 2: Trash View with Restore",id:"pattern-2-trash-view-with-restore",level:3},{value:"Pattern 3: Auto-Cleanup (Force Delete Old Soft-Deleted Records)",id:"pattern-3-auto-cleanup-force-delete-old-soft-deleted-records",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"\u2705 DO:",id:"-do",level:3},{value:"\u274c DON&#39;T:",id:"-dont",level:3},{value:"Summary",id:"summary",level:2},{value:"Related Concepts",id:"related-concepts",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.M)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"delete-operations-delete",children:"Delete Operations (DELETE)"}),"\n",(0,t.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"DELETE"})," operations remove records through two modes: ",(0,t.jsx)(n.strong,{children:"soft delete"})," (default, reversible) and ",(0,t.jsx)(n.strong,{children:"force delete"})," (permanent, irreversible). CoreService routes DELETE requests to CoreWrite for validation and execution."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Endpoint:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"DELETE /api/v4/core/{dim}/{dim_id}\nDELETE /api/v4/core/{dim}/{dim_id}?force=true\nAuthorization: Bearer {token}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Two Deletion Modes:"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Soft Delete (default)"}),": Sets TREC='C', record remains in database"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Force Delete"}),": Physically removes record from database"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"soft-delete-default",children:"Soft Delete (Default)"}),"\n",(0,t.jsx)(n.h3,{id:"behavior",children:"Behavior"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Default DELETE is soft (reversible):"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Request:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"DELETE /api/v4/core/PRD/123\nAuthorization: Bearer eyJhbGc...\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Database Action:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- Soft delete: UPDATE, not DELETE\nUPDATE TB_ANAG_PRD00\nSET TREC = 'C',\n    LDATA = '20251219160000',\n    LOWNER = 'admin@example.com'\nWHERE PRD_ID = 123;\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Response:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "status": "success",\n  "message": "Record soft deleted",\n  "data": {\n    "PRD_ID": 123,\n    "XPRD01": "Widget Pro",\n    "TREC": "C",  // Changed to \'C\' (Cancelled)\n    "LDATA": "20251219160000",  // Last modification timestamp\n    "LOWNER": "admin@example.com"  // Who deleted it\n  }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Benefits:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u2705 Reversible (can restore)"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Maintains referential integrity"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Preserves audit trail"}),"\n",(0,t.jsx)(n.li,{children:'\u2705 "Trash" functionality possible'}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"trec-state-transition",children:"TREC State Transition"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"TREC='N' or TREC='M'\n    \u2193 DELETE (soft)\nTREC='C' (Cancelled)\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Audit Fields:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"TREC: Changed to 'C'"}),"\n",(0,t.jsx)(n.li,{children:"LDATA: Set to deletion timestamp"}),"\n",(0,t.jsx)(n.li,{children:"LOWNER: Set to user who deleted"}),"\n",(0,t.jsx)(n.li,{children:"CDATA/OWNER: Preserved (original creation info)"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"query-behavior-after-soft-delete",children:"Query Behavior After Soft Delete"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Default queries exclude TREC='C':"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# This won't return soft-deleted products\nGET /api/v4/core/PRD?source=productList\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"To include soft-deleted records:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Show deleted records\nGET /api/v4/core/PRD?source=productList&cond_trec=C\n\n# Show all records (including deleted)\nGET /api/v4/core/PRD?source=productList&cond_trec=N,M,C\n"})}),"\n",(0,t.jsx)(n.h2,{id:"force-delete-permanent",children:"Force Delete (Permanent)"}),"\n",(0,t.jsx)(n.h3,{id:"behavior-1",children:"Behavior"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Force delete physically removes record:"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Request:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"DELETE /api/v4/core/PRD/123?force=true\nAuthorization: Bearer eyJhbGc...\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Database Action:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- Force delete: Physical DELETE\nDELETE FROM TB_ANAG_PRD00\nWHERE PRD_ID = 123;\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Response:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "status": "success",\n  "message": "Record permanently deleted"\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["\u26a0\ufe0f ",(0,t.jsx)(n.strong,{children:"Warning:"})," Force delete is ",(0,t.jsx)(n.strong,{children:"irreversible"}),". Use with extreme caution."]}),"\n",(0,t.jsx)(n.h3,{id:"when-to-use-force-delete",children:"When to Use Force Delete"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Rarely needed:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:'GDPR "right to be forgotten" compliance'}),"\n",(0,t.jsx)(n.li,{children:"Test data cleanup"}),"\n",(0,t.jsx)(n.li,{children:"Removing invalid/corrupted records"}),"\n",(0,t.jsx)(n.li,{children:"Database maintenance"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Usually avoid:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Regular deletion (use soft delete instead)"}),"\n",(0,t.jsx)(n.li,{children:"User-initiated deletes (offer restore functionality)"}),"\n",(0,t.jsx)(n.li,{children:"Production data (maintain audit trail)"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"restore-undelete",children:"Restore (Undelete)"}),"\n",(0,t.jsx)(n.h3,{id:"restore-soft-deleted-record",children:"Restore Soft-Deleted Record"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Soft-deleted records can be restored via PATCH:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Restore by setting TREC=\'M\'\nPATCH /api/v4/core/PRD/123\n{\n  "data": {\n    "TREC": "M"  // Or "N" depending on use case\n  }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Result:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"UPDATE TB_ANAG_PRD00\nSET TREC = 'M',\n    LDATA = '20251219170000',\n    LOWNER = 'admin@example.com'\nWHERE PRD_ID = 123 AND TREC = 'C';\n"})}),"\n",(0,t.jsx)(n.h2,{id:"delete_cascade-operations",children:"DELETE_CASCADE Operations"}),"\n",(0,t.jsx)(n.h3,{id:"soft-delete-cascades",children:"Soft Delete Cascades"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"TB_COST.DELETE_CASCADE triggers related deletions:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- When order is soft-deleted, soft-delete all items\nINSERT INTO TB_COST (COD_DIM, NUM_COST, COD_VAR, DELETE_CASCADE) VALUES\n('ORD', 10, 'items', 'ORDITEM:XORDITEM_ORDER_ID:soft');\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Single Request Cascades to Related Records:"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Request:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"DELETE /api/v4/core/ORD/123\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Result:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- Soft delete order\nUPDATE TB_ANAG_ORD00\nSET TREC = 'C', LDATA = '20251219160000'\nWHERE ORD_ID = 123;\n\n-- Cascade: Soft delete all order items\nUPDATE TB_ANAG_ORDITEM00\nSET TREC = 'C', LDATA = '20251219160000'\nWHERE XORDITEM_ORDER_ID = 123;\n"})}),"\n",(0,t.jsx)(n.h3,{id:"force-delete-cascades",children:"Force Delete Cascades"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Force delete can cascade permanently:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- When order is force-deleted, force-delete all items\nINSERT INTO TB_COST (COD_DIM, NUM_COST, COD_VAR, DELETE_CASCADE) VALUES\n('ORD', 10, 'items', 'ORDITEM:XORDITEM_ORDER_ID:force');\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Request:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"DELETE /api/v4/core/ORD/123?force=true\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Result:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"-- Force delete order\nDELETE FROM TB_ANAG_ORD00\nWHERE ORD_ID = 123;\n\n-- Cascade: Force delete all order items\nDELETE FROM TB_ANAG_ORDITEM00\nWHERE XORDITEM_ORDER_ID = 123;\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u26a0\ufe0f ",(0,t.jsx)(n.strong,{children:"Danger:"})," Force cascades are irreversible for all related records."]}),"\n",(0,t.jsx)(n.h2,{id:"outbox-event",children:"Outbox Event"}),"\n",(0,t.jsx)(n.h3,{id:"delete-event-publication",children:"Delete Event Publication"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Every DELETE publishes event to RabbitMQ:"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Soft Delete Event:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "event_id": "evt_770g0622",\n  "event_type": "ProductDeleted",\n  "aggregate_id": "123",\n  "aggregate_type": "PRD",\n  "operation": "DELETE",\n  "deletion_type": "soft",\n  "timestamp": "2025-12-19T16:00:00Z",\n  "payload": {\n    "PRD_ID": 123,\n    "XPRD01": "Widget Pro",\n    "TREC": "C"\n  },\n  "user": "admin@example.com"\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Force Delete Event:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "event_id": "evt_880h1733",\n  "event_type": "ProductForceDeleted",\n  "aggregate_id": "123",\n  "aggregate_type": "PRD",\n  "operation": "DELETE",\n  "deletion_type": "force",\n  "timestamp": "2025-12-19T17:00:00Z",\n  "payload": {\n    "PRD_ID": 123,\n    "XPRD01": "Widget Pro"\n  },\n  "user": "admin@example.com"\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"javascript-implementation",children:"JavaScript Implementation"}),"\n",(0,t.jsx)(n.h3,{id:"delete-service",children:"Delete Service"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"class ProductService {\n  constructor(apiBase, token) {\n    this.apiBase = apiBase;\n    this.token = token;\n  }\n\n  /**\n   * Soft delete (default)\n   */\n  async deleteProduct(productId) {\n    const response = await fetch(`${this.apiBase}/api/v4/core/PRD/${productId}`, {\n      method: 'DELETE',\n      headers: { 'Authorization': `Bearer ${this.token}` }\n    });\n\n    if (!response.ok) {\n      const error = await response.json();\n      throw new ProductDeleteError(error);\n    }\n\n    return response.json();\n  }\n\n  /**\n   * Force delete (permanent)\n   */\n  async forceDeleteProduct(productId) {\n    const url = new URL(`${this.apiBase}/api/v4/core/PRD/${productId}`);\n    url.searchParams.append('force', 'true');\n\n    const response = await fetch(url, {\n      method: 'DELETE',\n      headers: { 'Authorization': `Bearer ${this.token}` }\n    });\n\n    if (!response.ok) {\n      const error = await response.json();\n      throw new ProductDeleteError(error);\n    }\n\n    return response.json();\n  }\n\n  /**\n   * Restore soft-deleted product\n   */\n  async restoreProduct(productId) {\n    const response = await fetch(`${this.apiBase}/api/v4/core/PRD/${productId}`, {\n      method: 'PATCH',\n      headers: {\n        'Authorization': `Bearer ${this.token}`,\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        data: { TREC: 'M' }\n      })\n    });\n\n    if (!response.ok) {\n      const error = await response.json();\n      throw new ProductRestoreError(error);\n    }\n\n    return response.json();\n  }\n\n  /**\n   * Check if product is soft-deleted\n   */\n  async isDeleted(productId) {\n    const url = new URL(`${this.apiBase}/api/v4/core/PRD/${productId}`);\n    url.searchParams.append('cond_trec', 'N,M,C');  // Include deleted\n\n    const response = await fetch(url, {\n      headers: { 'Authorization': `Bearer ${this.token}` }\n    });\n\n    const result = await response.json();\n    return result.data?.TREC === 'C';\n  }\n}\n\nclass ProductDeleteError extends Error {\n  constructor(errorResponse) {\n    super(errorResponse.message);\n    this.code = errorResponse.code;\n  }\n}\n\nclass ProductRestoreError extends Error {\n  constructor(errorResponse) {\n    super(errorResponse.message);\n    this.code = errorResponse.code;\n  }\n}\n\n// Usage\nconst productService = new ProductService(apiBase, token);\n\n// Soft delete\nawait productService.deleteProduct(123);\n\n// Restore\nawait productService.restoreProduct(123);\n\n// Force delete (with confirmation)\nif (confirm('Permanently delete? This cannot be undone!')) {\n  await productService.forceDeleteProduct(123);\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"trash-management",children:"Trash Management"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"class TrashService {\n  constructor(apiBase, token, dimension) {\n    this.apiBase = apiBase;\n    this.token = token;\n    this.dimension = dimension;\n  }\n\n  /**\n   * Get trash (soft-deleted records)\n   */\n  async getTrash(options = {}) {\n    const url = new URL(`${this.apiBase}/api/v4/core/${this.dimension}`);\n    url.searchParams.append('source', options.source || 'list');\n    url.searchParams.append('cond_trec', 'C');  // Only soft-deleted\n    url.searchParams.append('$order', 'LDATA DESC');  // Recently deleted first\n    url.searchParams.append('$num_rows', options.limit || 25);\n    url.searchParams.append('$offset', options.offset || 0);\n\n    const response = await fetch(url, {\n      headers: { 'Authorization': `Bearer ${this.token}` }\n    });\n\n    return response.json();\n  }\n\n  /**\n   * Empty trash (force delete all soft-deleted records)\n   */\n  async emptyTrash() {\n    // 1. Get all soft-deleted records\n    const trash = await this.getTrash({ limit: 1000 });\n\n    // 2. Force delete each\n    const deletions = trash.data.map(record =>\n      fetch(`${this.apiBase}/api/v4/core/${this.dimension}/${record[`${this.dimension}_ID`]}?force=true`, {\n        method: 'DELETE',\n        headers: { 'Authorization': `Bearer ${this.token}` }\n      })\n    );\n\n    return Promise.all(deletions);\n  }\n\n  /**\n   * Restore from trash\n   */\n  async restore(recordId) {\n    const response = await fetch(`${this.apiBase}/api/v4/core/${this.dimension}/${recordId}`, {\n      method: 'PATCH',\n      headers: {\n        'Authorization': `Bearer ${this.token}`,\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        data: { TREC: 'M' }\n      })\n    });\n\n    return response.json();\n  }\n}\n\n// Usage\nconst trash = new TrashService(apiBase, token, 'PRD');\n\n// Get trash\nconst deleted = await trash.getTrash();\nconsole.log(`${deleted.data.length} items in trash`);\n\n// Restore item\nawait trash.restore(123);\n\n// Empty trash (with confirmation)\nif (confirm('Permanently delete all items in trash?')) {\n  await trash.emptyTrash();\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"common-patterns",children:"Common Patterns"}),"\n",(0,t.jsx)(n.h3,{id:"pattern-1-soft-delete-with-confirmation",children:"Pattern 1: Soft Delete with Confirmation"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"async function deleteProductWithConfirmation(productId) {\n  if (!confirm('Move product to trash?')) {\n    return;\n  }\n\n  try {\n    await fetch(`${apiBase}/api/v4/core/PRD/${productId}`, {\n      method: 'DELETE',\n      headers: { 'Authorization': `Bearer ${token}` }\n    });\n\n    alert('Product moved to trash. You can restore it later.');\n  } catch (error) {\n    alert('Failed to delete product');\n  }\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"pattern-2-trash-view-with-restore",children:"Pattern 2: Trash View with Restore"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"async function loadTrash() {\n  const url = new URL(`${apiBase}/api/v4/core/PRD`);\n  url.searchParams.append('source', 'productList');\n  url.searchParams.append('cond_trec', 'C');  // Only deleted\n  url.searchParams.append('$order', 'LDATA DESC');\n\n  const response = await fetch(url, {\n    headers: { 'Authorization': `Bearer ${token}` }\n  });\n\n  const trash = await response.json();\n\n  // Render trash items with restore buttons\n  trash.data.forEach(product => {\n    renderTrashItem(product, async () => {\n      // Restore callback\n      await fetch(`${apiBase}/api/v4/core/PRD/${product.PRD_ID}`, {\n        method: 'PATCH',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({ data: { TREC: 'M' } })\n      });\n\n      alert('Product restored!');\n      loadTrash();  // Refresh\n    });\n  });\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"pattern-3-auto-cleanup-force-delete-old-soft-deleted-records",children:"Pattern 3: Auto-Cleanup (Force Delete Old Soft-Deleted Records)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"async function autoCleanup(daysOld = 30) {\n  // Calculate cutoff date\n  const cutoffDate = new Date();\n  cutoffDate.setDate(cutoffDate.getDate() - daysOld);\n  const cutoffTimestamp = cutoffDate.toISOString().replace(/[-:T.]/g, '').slice(0, 14);\n\n  // Get old soft-deleted records\n  const url = new URL(`${apiBase}/api/v4/core/PRD`);\n  url.searchParams.append('source', 'productList');\n  url.searchParams.append('cond_trec', 'C');  // Only soft-deleted\n  url.searchParams.append('$filter', `LDATA lt '${cutoffTimestamp}'`);\n\n  const response = await fetch(url, {\n    headers: { 'Authorization': `Bearer ${token}` }\n  });\n\n  const oldDeleted = await response.json();\n\n  // Force delete each\n  const deletions = oldDeleted.data.map(product =>\n    fetch(`${apiBase}/api/v4/core/PRD/${product.PRD_ID}?force=true`, {\n      method: 'DELETE',\n      headers: { 'Authorization': `Bearer ${token}` }\n    })\n  );\n\n  await Promise.all(deletions);\n\n  console.log(`Auto-cleaned ${oldDeleted.data.length} records older than ${daysOld} days`);\n}\n\n// Run daily cleanup\nsetInterval(() => autoCleanup(30), 24 * 60 * 60 * 1000);\n"})}),"\n",(0,t.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,t.jsx)(n.h3,{id:"-do",children:"\u2705 DO:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Use soft delete by default:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"// \u2705 Good - reversible\nDELETE /api/v4/core/PRD/123\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Confirm before force delete:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"// \u2705 Good\nif (confirm('Permanently delete? This cannot be undone!')) {\n  DELETE /api/v4/core/PRD/123?force=true\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Provide restore functionality:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"// \u2705 Good - users can restore\nasync function restoreProduct(id) {\n  await fetch(`${apiBase}/api/v4/core/PRD/${id}`, {\n    method: 'PATCH',\n    body: JSON.stringify({ data: { TREC: 'M' } })\n  });\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Auto-cleanup old soft-deleted records:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"// \u2705 Good - force delete after 30 days\nawait autoCleanup(30);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"-dont",children:"\u274c DON'T:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Don't use force delete for regular deletions:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"// \u274c Bad - irreversible by default\nDELETE /api/v4/core/PRD/123?force=true\n\n// \u2705 Good - soft delete first\nDELETE /api/v4/core/PRD/123\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Don't forget to handle cascades:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"// \u274c Bad - orphaned order items\nDELETE /api/v4/core/ORD/123\n// Order items left without parent\n\n// \u2705 Good - configure DELETE_CASCADE in metadata\n// TB_COST.DELETE_CASCADE handles related records\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Don't force delete without confirmation:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"// \u274c Bad - no warning\nawait forceDeleteProduct(123);\n\n// \u2705 Good - confirm first\nif (confirm('Permanently delete?')) {\n  await forceDeleteProduct(123);\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u2705 Soft delete (default): Sets TREC='C', reversible"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Force delete (?force=true): Physical removal, irreversible"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Soft-deleted records excluded from default queries"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Restore via PATCH setting TREC='M'"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 DELETE_CASCADE propagates deletions to related records"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Outbox event published to RabbitMQ"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Use cond_trec=C to query soft-deleted records"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Key Takeaways:"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Default DELETE is soft (TREC='C'), not physical removal"}),"\n",(0,t.jsx)(n.li,{children:"Force delete (?force=true) is permanent and irreversible"}),"\n",(0,t.jsx)(n.li,{children:'Soft delete enables "trash" and restore functionality'}),"\n",(0,t.jsx)(n.li,{children:"Always confirm before force delete"}),"\n",(0,t.jsx)(n.li,{children:"DELETE_CASCADE handles related record deletion"}),"\n",(0,t.jsx)(n.li,{children:"Auto-cleanup old soft-deleted records (e.g., after 30 days)"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Decision Matrix:"})}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Use Case"}),(0,t.jsx)(n.th,{children:"Operation"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"User deletes record"}),(0,t.jsx)(n.td,{children:"Soft delete (TREC='C')"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Restore from trash"}),(0,t.jsx)(n.td,{children:"PATCH with TREC='M'"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"GDPR data removal"}),(0,t.jsx)(n.td,{children:"Force delete (?force=true)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Test data cleanup"}),(0,t.jsx)(n.td,{children:"Force delete (?force=true)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"30+ day old deleted records"}),(0,t.jsx)(n.td,{children:"Force delete (auto-cleanup)"})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Next:"})," ",(0,t.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/validation",children:"Validation \u2192"})]}),"\n",(0,t.jsx)(n.h2,{id:"related-concepts",children:"Related Concepts"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/query-patterns/trec-filtering",children:"TREC Filtering"})," - Query by TREC state"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/entity-lifecycle",children:"Entity Lifecycle"})," - TREC state machine"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/cascade-operations",children:"Cascade Operations"})," - DELETE_CASCADE patterns"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.M)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},2172:(e,n,r)=>{r.d(n,{I:()=>i,M:()=>a});var t=r(1504);const s={},o=t.createContext(s);function a(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);