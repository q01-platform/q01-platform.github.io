"use strict";(self.webpackChunkq_01_docs=self.webpackChunkq_01_docs||[]).push([[4904],{7036:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>t,metadata:()=>o,toc:()=>d});var r=s(7624),i=s(2172);const t={title:"Authentication",sidebar_label:"Authentication",sidebar_position:2,description:"JWT token authentication with refresh tokens"},a="Authentication",o={id:"products/map.q01.io/core-api-platform-v4/security/authentication",title:"Authentication",description:"JWT token authentication with refresh tokens",source:"@site/docs/products/map.q01.io/core-api-platform-v4/05-security/authentication.md",sourceDirName:"products/map.q01.io/core-api-platform-v4/05-security",slug:"/products/map.q01.io/core-api-platform-v4/security/authentication",permalink:"/docs/products/map.q01.io/core-api-platform-v4/security/authentication",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"Authentication",sidebar_label:"Authentication",sidebar_position:2,description:"JWT token authentication with refresh tokens"},sidebar:"mapSidebar",previous:{title:"Security",permalink:"/docs/products/map.q01.io/core-api-platform-v4/security/"},next:{title:"Authorization",permalink:"/docs/products/map.q01.io/core-api-platform-v4/security/authorization"}},c={},d=[{value:"Overview",id:"overview",level:2},{value:"Three-Phase Authentication Process",id:"three-phase-authentication-process",level:2},{value:"Phase 1: Authentication",id:"phase-1-authentication",level:3},{value:"Phase 2: Profiling",id:"phase-2-profiling",level:3},{value:"Phase 3: Interface/Database Accessibility",id:"phase-3-interfacedatabase-accessibility",level:3},{value:"JWT Token Structure",id:"jwt-token-structure",level:2},{value:"Token Components",id:"token-components",level:3},{value:"Header",id:"header",level:4},{value:"Payload (Claims)",id:"payload-claims",level:4},{value:"Signature",id:"signature",level:4},{value:"Standard Claims",id:"standard-claims",level:3},{value:"Custom Claims",id:"custom-claims",level:3},{value:"Session Management",id:"session-management",level:2},{value:"sessionId Concept",id:"sessionid-concept",level:3},{value:"Token Validation",id:"token-validation",level:2},{value:"Server-Side Validation",id:"server-side-validation",level:3},{value:"Validation Failures",id:"validation-failures",level:3},{value:"Token Validator Endpoint",id:"token-validator-endpoint",level:3},{value:"Login Flow",id:"login-flow",level:2},{value:"Obtaining Tokens",id:"obtaining-tokens",level:3},{value:"Access Token Authentication",id:"access-token-authentication",level:3},{value:"JavaScript Implementation",id:"javascript-implementation",level:3},{value:"Making Authenticated Requests",id:"making-authenticated-requests",level:2},{value:"Request Header",id:"request-header",level:3},{value:"JavaScript API Client",id:"javascript-api-client",level:3},{value:"Token Refresh",id:"token-refresh",level:2},{value:"Refresh Flow",id:"refresh-flow",level:3},{value:"Refresh Endpoint",id:"refresh-endpoint",level:3},{value:"JavaScript Refresh Implementation",id:"javascript-refresh-implementation",level:3},{value:"Automatic Refresh",id:"automatic-refresh",level:3},{value:"Token Storage",id:"token-storage",level:2},{value:"Security Considerations",id:"security-considerations",level:3},{value:"HttpOnly Cookie Implementation",id:"httponly-cookie-implementation",level:3},{value:"Logout Flow",id:"logout-flow",level:2},{value:"Logout Endpoint",id:"logout-endpoint",level:3},{value:"JavaScript Logout",id:"javascript-logout",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"\u2705 DO:",id:"-do",level:3},{value:"\u274c DON&#39;T:",id:"-dont",level:3},{value:"Summary",id:"summary",level:2},{value:"Related Concepts",id:"related-concepts",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.M)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"authentication",children:"Authentication"}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsxs)(n.p,{children:["Q01 Core APIs use ",(0,r.jsx)(n.strong,{children:"JSON Web Tokens (JWT)"})," for stateless authentication. Every API request must include a valid JWT in the ",(0,r.jsx)(n.code,{children:"Authorization"})," header. Tokens carry user identity, tenant context, and permissions."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Benefits:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u2705 Stateless (no server-side session storage)"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Self-contained (includes user claims)"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Cryptographically signed (tamper-proof)"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Expiring (security via short TTL)"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Portable (works across services)"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Authentication Flow:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"1. Client \u2192 POST /auth/login (username/password)\n2. Server validates credentials\n3. Server generates access token (15 min active + 60 min renewable)\n4. Server generates refresh token (30 days TTL)\n5. Client stores tokens\n6. Client \u2192 API request with access token\n7. Server validates token\n8. Server executes request\n9. Access token expires \u2192 401 Unauthorized\n10. Client \u2192 POST /auth/refresh (refresh token)\n11. Server generates new access token\n12. Repeat from step 6\n"})}),"\n",(0,r.jsx)(n.h2,{id:"three-phase-authentication-process",children:"Three-Phase Authentication Process"}),"\n",(0,r.jsx)(n.p,{children:"The authentication system consists of three distinct phases that occur during login:"}),"\n",(0,r.jsx)(n.h3,{id:"phase-1-authentication",children:"Phase 1: Authentication"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Credential Verification:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"User submits username/password OR access_token"}),"\n",(0,r.jsx)(n.li,{children:"Credentials validated against msauth microservice"}),"\n",(0,r.jsx)(n.li,{children:"Invalid credentials \u2192 401 Unauthorized"}),"\n",(0,r.jsx)(n.li,{children:"Session establishment begins"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose:"})," Verify user identity"]}),"\n",(0,r.jsx)(n.h3,{id:"phase-2-profiling",children:"Phase 2: Profiling"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"User Context Retrieval:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"User information loaded (email, name, tenant_id)"}),"\n",(0,r.jsx)(n.li,{children:"User grants fetched from TB_MENU (nested set hierarchy)"}),"\n",(0,r.jsx)(n.li,{children:"User level (peso) determined (1=admin, 2=manager, 3=user)"}),"\n",(0,r.jsx)(n.li,{children:"Context established: source, centro_dett, ambiente, modulo, lingua"}),"\n",(0,r.jsx)(n.li,{children:"Default preferences loaded"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose:"})," Build user authorization context"]}),"\n",(0,r.jsx)(n.h3,{id:"phase-3-interfacedatabase-accessibility",children:"Phase 3: Interface/Database Accessibility"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Session Data Storage:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"BOX and MENU items user can access retrieved"}),"\n",(0,r.jsx)(n.li,{children:"Interface rendering data prepared (visible menu items, buttons, forms)"}),"\n",(0,r.jsx)(n.li,{children:"Database connection information configured (per tenant)"}),"\n",(0,r.jsxs)(n.li,{children:["All profiling data stored in ",(0,r.jsx)(n.strong,{children:"TB_ANAG_SESSIONS00"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"sessionId"})," generated and inserted into JWT payload"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose:"})," Prepare application session environment"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Complete Flow:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Login Request\n    \u2193\nPhase 1: Verify credentials (msauth)\n    \u2193\nPhase 2: Load user profile + grants + context (TB_MENU)\n    \u2193\nPhase 3: Prepare interface data + store in TB_ANAG_SESSIONS00\n    \u2193\nGenerate JWT with sessionId reference\n    \u2193\nReturn access_token + refresh_token\n"})}),"\n",(0,r.jsx)(n.h2,{id:"jwt-token-structure",children:"JWT Token Structure"}),"\n",(0,r.jsx)(n.h3,{id:"token-components",children:"Token Components"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"JWT has three parts: Header.Payload.Signature"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoidXNlckBleGFtcGxlLmNvbSIsInRlbmFudF9pZCI6InRlbmFudF8xMjMiLCJzb3VyY2UiOiJwcm9kdWN0TWFuYWdlbWVudCIsImNlbnRyb19kZXR0IjoiYWRtaW4iLCJwZXNvIjoiMSIsImFtYmllbnRlIjoicHJvZHVjdGlvbiIsImdyYW50cyI6WyJwcm9kdWN0cy5yZWFkIiwicHJvZHVjdHMud3JpdGUiXSwiZXhwIjoxNzM1NTc0NDAwLCJpYXQiOjE3MzU0ODgwMDB9.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Base64-decoded structure:"})}),"\n",(0,r.jsx)(n.h4,{id:"header",children:"Header"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "alg": "HS256",\n  "typ": "JWT"\n}\n'})}),"\n",(0,r.jsx)(n.h4,{id:"payload-claims",children:"Payload (Claims)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "user_id": "user@example.com",\n  "tenant_id": "tenant_123",\n  "sessionId": "uuid-session-123",\n  "source": "productManagement",\n  "centro_dett": "admin",\n  "peso": "1",\n  "ambiente": "production",\n  "lingua": "en",\n  "grants": ["products.read", "products.write", "orders.read"],\n  "exp": 1735574400,\n  "iat": 1735488000,\n  "iss": "q01-auth-service",\n  "sub": "user@example.com"\n}\n'})}),"\n",(0,r.jsx)(n.h4,{id:"signature",children:"Signature"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'HMACSHA256(\n  base64UrlEncode(header) + "." +\n  base64UrlEncode(payload),\n  secret\n)\n'})}),"\n",(0,r.jsx)(n.h3,{id:"standard-claims",children:"Standard Claims"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Claim"}),(0,r.jsx)(n.th,{children:"Description"}),(0,r.jsx)(n.th,{children:"Example"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"iss"})}),(0,r.jsx)(n.td,{children:"Issuer (who created token)"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"q01-auth-service"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"sub"})}),(0,r.jsx)(n.td,{children:"Subject (user identifier)"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"user@example.com"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"aud"})}),(0,r.jsx)(n.td,{children:"Audience (intended recipient)"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"q01-core-api"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"exp"})}),(0,r.jsx)(n.td,{children:"Expiration timestamp"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"1735574400"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"iat"})}),(0,r.jsx)(n.td,{children:"Issued at timestamp"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"1735488000"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nbf"})}),(0,r.jsx)(n.td,{children:"Not before timestamp"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"1735488000"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"jti"})}),(0,r.jsx)(n.td,{children:"JWT ID (unique identifier)"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"uuid-..."})})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"custom-claims",children:"Custom Claims"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Claim"}),(0,r.jsx)(n.th,{children:"Description"}),(0,r.jsx)(n.th,{children:"Example"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"user_id"})}),(0,r.jsx)(n.td,{children:"User email/username"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"user@example.com"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"tenant_id"})}),(0,r.jsx)(n.td,{children:"Tenant identifier"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"tenant_123"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"sessionId"})}),(0,r.jsx)(n.td,{children:"Session reference (TB_ANAG_SESSIONS00)"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"uuid-session-123"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"source"})}),(0,r.jsx)(n.td,{children:"Application/tenant source"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"productManagement"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"centro_dett"})}),(0,r.jsx)(n.td,{children:"Organizational unit"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"admin"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"peso"})}),(0,r.jsx)(n.td,{children:"User level (1=admin, 2=manager, 3=user)"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"1"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ambiente"})}),(0,r.jsx)(n.td,{children:"Environment"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"production"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"lingua"})}),(0,r.jsx)(n.td,{children:"User language"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"en"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"grants"})}),(0,r.jsx)(n.td,{children:"Permission array"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:'["products.read", "products.write"]'})})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"session-management",children:"Session Management"}),"\n",(0,r.jsx)(n.h3,{id:"sessionid-concept",children:"sessionId Concept"}),"\n",(0,r.jsxs)(n.p,{children:["The JWT payload includes a ",(0,r.jsx)(n.strong,{children:"sessionId"})," field that references a server-side session record in ",(0,r.jsx)(n.strong,{children:"TB_ANAG_SESSIONS00"}),". This hybrid approach combines stateless JWT benefits with server-side session data."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Why sessionId?"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"JWT remains stateless and portable"}),"\n",(0,r.jsx)(n.li,{children:"Server can look up detailed session data without bloating token"}),"\n",(0,r.jsx)(n.li,{children:"Enables server-side session management (revocation, updates)"}),"\n",(0,r.jsx)(n.li,{children:"Stores database connections, grants, interface permissions"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"TB_ANAG_SESSIONS00 Structure:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE TB_ANAG_SESSIONS00 (\n    SESSION_ID VARCHAR(36) PRIMARY KEY,  -- UUID referenced in JWT\n    USER_ID VARCHAR(100),                 -- User identifier\n    TENANT_ID VARCHAR(50),                -- Tenant\n    GRANTS JSON,                          -- User permissions from TB_MENU\n    DB_CONNECTIONS JSON,                  -- Source-specific DB configs\n    INTERFACE_DATA JSON,                  -- BOX/MENU items user can access\n    CONTEXT JSON,                         -- source, peso, ambiente, centro_dett\n    CREATED_AT TIMESTAMP,\n    EXPIRES_AT TIMESTAMP,\n    LAST_ACTIVITY TIMESTAMP\n);\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Example Session Data:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "SESSION_ID": "uuid-session-123",\n  "USER_ID": "user@example.com",\n  "TENANT_ID": "tenant_123",\n  "GRANTS": [\n    {"COD_MENU": "settings-2", "NLEFT": 2, "NRIGHT": 9, "OPERATIONS": ["read", "write"]},\n    {"COD_MENU": "sales-1", "NLEFT": 20, "NRIGHT": 35, "OPERATIONS": ["read"]}\n  ],\n  "DB_CONNECTIONS": {\n    "productManagement": {\n      "host": "db.example.com",\n      "database": "tenant_123_products"\n    }\n  },\n  "INTERFACE_DATA": {\n    "menus": ["Products", "Orders", "Reports"],\n    "boxes": ["Dashboard", "Analytics"]\n  },\n  "CONTEXT": {\n    "source": "productManagement",\n    "peso": 1,\n    "ambiente": "production",\n    "centro_dett": "admin",\n    "lingua": "en"\n  },\n  "CREATED_AT": "2025-12-19T14:00:00Z",\n  "EXPIRES_AT": "2025-12-19T15:00:00Z",\n  "LAST_ACTIVITY": "2025-12-19T14:30:00Z"\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"How sessionId Works:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"API Request with JWT\n    \u2193\nServer decodes JWT payload\n    \u2193\nExtract sessionId from payload\n    \u2193\nSELECT * FROM TB_ANAG_SESSIONS00 WHERE SESSION_ID = ?\n    \u2193\nLoad user grants, context, DB connections\n    \u2193\nExecute request with session context\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Benefits:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u2705 Reduce JWT size (don't embed all grants in token)"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Server-side session revocation (delete session record)"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Update permissions without re-issuing token"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Audit trail (track session creation, expiration, activity)"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Multi-database routing (source-specific DB configs)"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"token-validation",children:"Token Validation"}),"\n",(0,r.jsx)(n.h3,{id:"server-side-validation",children:"Server-Side Validation"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"CoreQuery/CoreWrite validate every request:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// RequestValidatorSubscriber.php\npublic function validateJWT(string $token): array {\n    // 1. Decode header and payload\n    $parts = explode('.', $token);\n    if (count($parts) !== 3) {\n        throw new AuthenticationException('Invalid token format');\n    }\n\n    [$headerB64, $payloadB64, $signatureB64] = $parts;\n\n    // 2. Verify signature\n    $secret = getenv('JWT_SECRET');\n    $expectedSignature = hash_hmac(\n        'sha256',\n        \"$headerB64.$payloadB64\",\n        $secret,\n        true\n    );\n\n    if (!hash_equals(base64_decode($signatureB64), $expectedSignature)) {\n        throw new AuthenticationException('Invalid token signature');\n    }\n\n    // 3. Decode payload\n    $payload = json_decode(base64_decode($payloadB64), true);\n\n    // 4. Check expiration\n    if ($payload['exp'] < time()) {\n        throw new AuthenticationException('Token expired');\n    }\n\n    // 5. Check not-before\n    if (isset($payload['nbf']) && $payload['nbf'] > time()) {\n        throw new AuthenticationException('Token not yet valid');\n    }\n\n    // 6. Check issuer\n    if ($payload['iss'] !== 'q01-auth-service') {\n        throw new AuthenticationException('Invalid token issuer');\n    }\n\n    return $payload;\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"validation-failures",children:"Validation Failures"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"TOKEN_INVALID:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "error": "AuthenticationError",\n  "message": "Invalid or malformed token",\n  "code": "TOKEN_INVALID",\n  "status": 401\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"TOKEN_EXPIRED:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "error": "AuthenticationError",\n  "message": "Token has expired",\n  "code": "TOKEN_EXPIRED",\n  "status": 401,\n  "expired_at": "2025-12-19T15:00:00Z"\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"TOKEN_MISSING:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "error": "AuthenticationError",\n  "message": "Authorization header missing",\n  "code": "TOKEN_MISSING",\n  "status": 401\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"token-validator-endpoint",children:"Token Validator Endpoint"}),"\n",(0,r.jsx)(n.p,{children:"The platform provides a dedicated endpoint for validating JWT tokens without executing any business logic."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Endpoint:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"GET /api/v4/auth/tokenvalidator\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Headers:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Authorization: Bearer {access_token}\nmicroservice: msauth\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Success Response (200):"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "code": 200,\n  "message": "Token is Valid"\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Error Response (401):"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "code": 401,\n  "msg": "Invalid Auth Token provided. Kindly login again to get valid token"\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Use Cases:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Health check for token validity"}),"\n",(0,r.jsx)(n.li,{children:"Pre-flight validation before expensive operations"}),"\n",(0,r.jsx)(n.li,{children:"Client-side token validation before API calls"}),"\n",(0,r.jsx)(n.li,{children:"Token debugging and troubleshooting"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Example JavaScript Usage:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"async function isTokenValid(token) {\n  try {\n    const response = await fetch('/api/v4/auth/tokenvalidator', {\n      headers: {\n        'Authorization': `Bearer ${token}`,\n        'microservice': 'msauth'\n      }\n    });\n\n    if (response.status === 200) {\n      return true;\n    } else {\n      return false;\n    }\n  } catch (error) {\n    return false;\n  }\n}\n\n// Usage\nif (!await isTokenValid(currentToken)) {\n  await refreshToken();\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"login-flow",children:"Login Flow"}),"\n",(0,r.jsx)(n.h3,{id:"obtaining-tokens",children:"Obtaining Tokens"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"POST /auth/login:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'POST /auth/login\nContent-Type: application/json\n\n{\n  "username": "user@example.com",\n  "password": "secure_password",\n  "source": "productManagement",\n  "centro_dett": "admin"\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Response:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "status": "success",\n  "data": {\n    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",\n    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",\n    "token_type": "Bearer",\n    "expires_in": 3600,\n    "user": {\n      "user_id": "user@example.com",\n      "tenant_id": "tenant_123",\n      "source": "productManagement",\n      "centro_dett": "admin",\n      "peso": "1",\n      "grants": ["products.read", "products.write"]\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"access-token-authentication",children:"Access Token Authentication"}),"\n",(0,r.jsxs)(n.p,{children:["As an alternative to username/password, the login endpoint accepts an existing ",(0,r.jsx)(n.strong,{children:"access_token"})," for authentication. This is useful for:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"OAuth/SSO integrations"}),"\n",(0,r.jsx)(n.li,{children:"Service-to-service authentication"}),"\n",(0,r.jsx)(n.li,{children:"Token exchange scenarios"}),"\n",(0,r.jsx)(n.li,{children:"Migration from other authentication systems"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"POST /auth/login with access_token:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'POST /auth/login\nContent-Type: application/json\n\n{\n  "access_token": "existing_valid_token",\n  "resource": "productManagement",\n  "tenantId": "tenant_123"\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Response:"})}),"\n",(0,r.jsx)(n.p,{children:"Same as username/password login - returns new access_token and refresh_token for Q01 platform."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "status": "success",\n  "data": {\n    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",\n    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",\n    "token_type": "Bearer",\n    "expires_in": 3600,\n    "user": {\n      "user_id": "user@example.com",\n      "tenant_id": "tenant_123",\n      "source": "productManagement",\n      "peso": "1"\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Use Case Example - OAuth Integration:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// User logs in via OAuth provider (Google, Microsoft, etc.)\nconst oauthToken = await oauthProvider.authenticate();\n\n// Exchange OAuth token for Q01 platform token\nconst response = await fetch('/auth/login', {\n  method: 'POST',\n  headers: {\n    'Content-Type': 'application/json'\n  },\n  body: JSON.stringify({\n    access_token: oauthToken,\n    resource: 'productManagement',\n    tenantId: 'tenant_123'\n  })\n});\n\nconst { access_token, refresh_token } = await response.json();\n\n// Now use Q01 access_token for Core API requests\nconst products = await fetch('/api/v4/core/PRD', {\n  headers: {\n    'Authorization': `Bearer ${access_token}`\n  }\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"javascript-implementation",children:"JavaScript Implementation"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"class AuthService {\n  constructor() {\n    this.authBase = 'https://api.example.com';\n  }\n\n  async login(username, password, source, centro_dett) {\n    const response = await fetch(`${this.authBase}/auth/login`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        username,\n        password,\n        source,\n        centro_dett\n      })\n    });\n\n    if (!response.ok) {\n      const error = await response.json();\n      throw new Error(error.message);\n    }\n\n    const data = await response.json();\n\n    // Store tokens securely\n    this.storeTokens(data.data.access_token, data.data.refresh_token);\n\n    return data.data.user;\n  }\n\n  storeTokens(accessToken, refreshToken) {\n    // \u2705 Good - httpOnly cookie (server-side)\n    // Set by server via Set-Cookie header\n\n    // \u26a0\ufe0f Alternative - sessionStorage (less secure, but simpler)\n    sessionStorage.setItem('access_token', accessToken);\n    sessionStorage.setItem('refresh_token', refreshToken);\n  }\n\n  getAccessToken() {\n    return sessionStorage.getItem('access_token');\n  }\n\n  getRefreshToken() {\n    return sessionStorage.getItem('refresh_token');\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"making-authenticated-requests",children:"Making Authenticated Requests"}),"\n",(0,r.jsx)(n.h3,{id:"request-header",children:"Request Header"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Every API request includes JWT:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"GET /api/v4/core/PRD\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\n"})}),"\n",(0,r.jsx)(n.h3,{id:"javascript-api-client",children:"JavaScript API Client"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"class CoreAPIClient {\n  constructor(authService) {\n    this.authService = authService;\n    this.apiBase = 'https://api.example.com';\n  }\n\n  async request(path, options = {}) {\n    const token = this.authService.getAccessToken();\n\n    if (!token) {\n      throw new Error('Not authenticated');\n    }\n\n    const response = await fetch(`${this.apiBase}${path}`, {\n      ...options,\n      headers: {\n        ...options.headers,\n        'Authorization': `Bearer ${token}`,\n        'Content-Type': 'application/json'\n      }\n    });\n\n    // Handle token expiration\n    if (response.status === 401) {\n      const refreshed = await this.handleTokenExpiration();\n      if (refreshed) {\n        // Retry request with new token\n        return this.request(path, options);\n      } else {\n        // Redirect to login\n        window.location.href = '/login';\n        throw new Error('Authentication required');\n      }\n    }\n\n    return response;\n  }\n\n  async handleTokenExpiration() {\n    try {\n      await this.authService.refreshAccessToken();\n      return true;\n    } catch (error) {\n      return false;\n    }\n  }\n\n  async getProducts() {\n    const response = await this.request('/api/v4/core/PRD');\n    return response.json();\n  }\n\n  async createProduct(data) {\n    const response = await this.request('/api/v4/core/PRD', {\n      method: 'POST',\n      body: JSON.stringify({ data })\n    });\n    return response.json();\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"token-refresh",children:"Token Refresh"}),"\n",(0,r.jsx)(n.h3,{id:"refresh-flow",children:"Refresh Flow"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Access token expires (15-75 minutes) \u2192 Use refresh token to get new access token"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Client: Access token expired (401)\n    \u2193\nClient: POST /auth/refresh (refresh token)\n    \u2193\nServer: Validate refresh token\n    \u2193\nServer: Generate new access token\n    \u2193\nClient: Store new access token\n    \u2193\nClient: Retry original request\n"})}),"\n",(0,r.jsx)(n.h3,{id:"refresh-endpoint",children:"Refresh Endpoint"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"POST /auth/refresh:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'POST /auth/refresh\nContent-Type: application/json\n\n{\n  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Response:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "status": "success",\n  "data": {\n    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",\n    "token_type": "Bearer",\n    "expires_in": 3600\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"javascript-refresh-implementation",children:"JavaScript Refresh Implementation"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"class AuthService {\n  async refreshAccessToken() {\n    const refreshToken = this.getRefreshToken();\n\n    if (!refreshToken) {\n      throw new Error('No refresh token available');\n    }\n\n    const response = await fetch(`${this.authBase}/auth/refresh`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({ refresh_token: refreshToken })\n    });\n\n    if (!response.ok) {\n      // Refresh token invalid or expired\n      this.clearTokens();\n      throw new Error('Refresh token expired');\n    }\n\n    const data = await response.json();\n\n    // Store new access token\n    sessionStorage.setItem('access_token', data.data.access_token);\n\n    return data.data.access_token;\n  }\n\n  clearTokens() {\n    sessionStorage.removeItem('access_token');\n    sessionStorage.removeItem('refresh_token');\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"automatic-refresh",children:"Automatic Refresh"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Proactively refresh before expiration:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"class AuthService {\n  startTokenRefreshTimer() {\n    // Decode token to get expiration\n    const token = this.getAccessToken();\n    const payload = this.decodeToken(token);\n    const expiresAt = payload.exp * 1000;  // Convert to milliseconds\n    const now = Date.now();\n\n    // Refresh 5 minutes before expiration\n    const refreshIn = expiresAt - now - (5 * 60 * 1000);\n\n    if (refreshIn > 0) {\n      setTimeout(async () => {\n        try {\n          await this.refreshAccessToken();\n          this.startTokenRefreshTimer();  // Schedule next refresh\n        } catch (error) {\n          console.error('Token refresh failed:', error);\n          window.location.href = '/login';\n        }\n      }, refreshIn);\n    }\n  }\n\n  decodeToken(token) {\n    const parts = token.split('.');\n    const payload = JSON.parse(atob(parts[1]));\n    return payload;\n  }\n}\n\n// Usage\nconst authService = new AuthService();\nawait authService.login(username, password, source, centro_dett);\nauthService.startTokenRefreshTimer();  // Auto-refresh\n"})}),"\n",(0,r.jsx)(n.h2,{id:"token-storage",children:"Token Storage"}),"\n",(0,r.jsx)(n.h3,{id:"security-considerations",children:"Security Considerations"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Options:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"HttpOnly Cookies (Most Secure)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u2705 Not accessible via JavaScript (XSS protection)"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Automatically sent with requests"}),"\n",(0,r.jsx)(n.li,{children:"\u26a0\ufe0f Requires server-side cookie handling"}),"\n",(0,r.jsx)(n.li,{children:"\u26a0\ufe0f CSRF protection needed"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"SessionStorage (Moderate Security)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u2705 Cleared when tab closes"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Not shared across tabs"}),"\n",(0,r.jsx)(n.li,{children:"\u26a0\ufe0f Vulnerable to XSS attacks"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Simple implementation"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"LocalStorage (Least Secure)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u274c Persistent across sessions"}),"\n",(0,r.jsx)(n.li,{children:"\u274c Shared across tabs"}),"\n",(0,r.jsx)(n.li,{children:"\u274c Vulnerable to XSS attacks"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Survives page reloads"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Recommendation:"})," Use ",(0,r.jsx)(n.strong,{children:"httpOnly cookies"})," for production, ",(0,r.jsx)(n.strong,{children:"sessionStorage"})," for development."]}),"\n",(0,r.jsx)(n.h3,{id:"httponly-cookie-implementation",children:"HttpOnly Cookie Implementation"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Server sets cookie:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-http",children:"Set-Cookie: access_token=eyJhbGci...; HttpOnly; Secure; SameSite=Strict; Max-Age=3600\nSet-Cookie: refresh_token=eyJhbGci...; HttpOnly; Secure; SameSite=Strict; Max-Age=2592000; Path=/auth/refresh\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Client automatically sends cookie:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// No need to manually add Authorization header\nconst response = await fetch('/api/v4/core/PRD', {\n  credentials: 'include'  // Send cookies\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"logout-flow",children:"Logout Flow"}),"\n",(0,r.jsx)(n.h3,{id:"logout-endpoint",children:"Logout Endpoint"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"POST /auth/logout:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"POST /auth/logout\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Response:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "status": "success",\n  "message": "Logged out successfully"\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"javascript-logout",children:"JavaScript Logout"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"class AuthService {\n  async logout() {\n    const token = this.getAccessToken();\n\n    if (token) {\n      try {\n        await fetch(`${this.authBase}/auth/logout`, {\n          method: 'POST',\n          headers: {\n            'Authorization': `Bearer ${token}`\n          }\n        });\n      } catch (error) {\n        console.error('Logout failed:', error);\n      }\n    }\n\n    // Clear local tokens\n    this.clearTokens();\n\n    // Redirect to login\n    window.location.href = '/login';\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsx)(n.h3,{id:"-do",children:"\u2705 DO:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Use HTTPS in production:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// \u2705 Good - encrypted transport\nconst apiBase = 'https://api.example.com';\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Refresh tokens proactively:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// \u2705 Good - refresh 5 minutes before expiration\nif (tokenExpiresIn() < 5 * 60) {\n  await refreshAccessToken();\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Handle 401 errors gracefully:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// \u2705 Good - auto-retry with refresh\nif (response.status === 401) {\n  await refreshAccessToken();\n  return retryRequest();\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Clear tokens on logout:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// \u2705 Good - complete cleanup\nsessionStorage.clear();\n"})}),"\n",(0,r.jsx)(n.h3,{id:"-dont",children:"\u274c DON'T:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Don't store tokens in localStorage:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// \u274c Bad - XSS vulnerable\nlocalStorage.setItem('token', jwt);\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Don't log tokens:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// \u274c Bad - exposes tokens in logs\nconsole.log('Token:', token);\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Don't send tokens in URL:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// \u274c Bad - visible in browser history\nfetch(`/api/products?token=${token}`);\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Don't skip token validation:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"// \u274c Bad - trusting client-side token\nconst payload = JSON.parse(atob(token.split('.')[1]));\n// Always validate server-side!\n"})}),"\n",(0,r.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u2705 JWT tokens provide stateless authentication"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Tokens include user identity, context, and permissions (including sessionId)"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Access tokens have two states: active (15 min) + renewable (60 min)"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Refresh tokens extend session (30 days)"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Session data stored in TB_ANAG_SESSIONS00 (referenced by sessionId)"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Three-phase authentication: Authentication \u2192 Profiling \u2192 Interface Accessibility"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Server validates signature, expiration, issuer"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 401 errors trigger token refresh"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 HttpOnly cookies recommended for storage"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 HTTPS required in production"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Key Takeaways:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Every API request requires valid JWT in Authorization header"}),"\n",(0,r.jsx)(n.li,{children:"Tokens are cryptographically signed and self-contained"}),"\n",(0,r.jsx)(n.li,{children:"JWT includes sessionId referencing TB_ANAG_SESSIONS00 for detailed session data"}),"\n",(0,r.jsx)(n.li,{children:"Access tokens expire quickly (15 min active + 60 min renewable)"}),"\n",(0,r.jsx)(n.li,{children:"Handle 401 errors by refreshing token and retrying"}),"\n",(0,r.jsx)(n.li,{children:"Store tokens securely (httpOnly cookies or sessionStorage)"}),"\n",(0,r.jsx)(n.li,{children:"Always use HTTPS to protect tokens in transit"}),"\n",(0,r.jsx)(n.li,{children:"Clear tokens on logout"}),"\n",(0,r.jsx)(n.li,{children:"Can authenticate with username/password OR access_token"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Token Lifecycle:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Login \u2192 Access Token (15min active + 60min renewable) + Refresh Token (30d)\n    \u2193\nAPI Requests (Authorization: Bearer {access_token})\n    \u2193\nAccess Token Expires \u2192 401\n    \u2193\nRefresh Token \u2192 New Access Token\n    \u2193\nContinue API Requests\n    \u2193\nRefresh Token Expires \u2192 Redirect to Login\n"})}),"\n",(0,r.jsx)(n.h2,{id:"related-concepts",children:"Related Concepts"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/security/authorization",children:"Authorization"})," - TB_MENU grants"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/security",children:"Security Overview"})," - Multi-level security"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/security/tenant-isolation",children:"Tenant Isolation"})," - Multi-tenancy"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/security/context-security",children:"Context Security"})," - source/peso/ambiente"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/error-handling",children:"Error Handling"})," - 401/403 errors"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.M)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},2172:(e,n,s)=>{s.d(n,{I:()=>o,M:()=>a});var r=s(1504);const i={},t=r.createContext(i);function a(e){const n=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);