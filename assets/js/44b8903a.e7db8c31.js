"use strict";(self.webpackChunkq_01_docs=self.webpackChunkq_01_docs||[]).push([[9328],{5532:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>o});var s=r(7624),t=r(2172);const i={title:"Authorization",sidebar_label:"Authorization",sidebar_position:3,description:"TB_MENU grants and nested set permissions"},d="Authorization",a={id:"products/map.q01.io/core-api-platform-v4/security/authorization",title:"Authorization",description:"TB_MENU grants and nested set permissions",source:"@site/docs/products/map.q01.io/core-api-platform-v4/05-security/authorization.md",sourceDirName:"products/map.q01.io/core-api-platform-v4/05-security",slug:"/products/map.q01.io/core-api-platform-v4/security/authorization",permalink:"/docs/products/map.q01.io/core-api-platform-v4/security/authorization",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{title:"Authorization",sidebar_label:"Authorization",sidebar_position:3,description:"TB_MENU grants and nested set permissions"},sidebar:"mapSidebar",previous:{title:"Authentication",permalink:"/docs/products/map.q01.io/core-api-platform-v4/security/authentication"},next:{title:"Tenant Isolation",permalink:"/docs/products/map.q01.io/core-api-platform-v4/security/tenant-isolation"}},c={},o=[{value:"Overview",id:"overview",level:2},{value:"TB_MENU Table",id:"tb_menu-table",level:2},{value:"Schema",id:"schema",level:3},{value:"Nested Set Example",id:"nested-set-example",level:3},{value:"Grant Checking",id:"grant-checking",level:2},{value:"Direct Grant Check",id:"direct-grant-check",level:3},{value:"Hierarchical Grant Check",id:"hierarchical-grant-check",level:3},{value:"CoreQuery Grant Validation",id:"corequery-grant-validation",level:3},{value:"Grant Hierarchy",id:"grant-hierarchy",level:2},{value:"Parent Grants Include Children",id:"parent-grants-include-children",level:3},{value:"Fine-Grained Grants",id:"fine-grained-grants",level:3},{value:"Operation Grant Mapping",id:"operation-grant-mapping",level:2},{value:"Read Operations (GET)",id:"read-operations-get",level:3},{value:"Write Operations (POST/PUT/PATCH)",id:"write-operations-postputpatch",level:3},{value:"Delete Operations (DELETE)",id:"delete-operations-delete",level:3},{value:"Grant Determination Logic",id:"grant-determination-logic",level:3},{value:"JWT Token Grants",id:"jwt-token-grants",level:2},{value:"Token Structure",id:"token-structure",level:3},{value:"Grant Assignment",id:"grant-assignment",level:3},{value:"Authorization Errors",id:"authorization-errors",level:2},{value:"403 Forbidden",id:"403-forbidden",level:3},{value:"Client-Side Grant Checking",id:"client-side-grant-checking",level:2},{value:"Hiding UI Elements",id:"hiding-ui-elements",level:3},{value:"Decoding JWT Client-Side",id:"decoding-jwt-client-side",level:3},{value:"Role-Based Access Control",id:"role-based-access-control",level:2},{value:"Roles as Grant Bundles",id:"roles-as-grant-bundles",level:3},{value:"Assign Roles to Users",id:"assign-roles-to-users",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"\u2705 DO:",id:"-do",level:3},{value:"\u274c DON&#39;T:",id:"-dont",level:3},{value:"Summary",id:"summary",level:2},{value:"Related Concepts",id:"related-concepts",level:2}];function l(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.M)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"authorization",children:"Authorization"}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(n.p,{children:["Q01 Core APIs use ",(0,s.jsx)(n.strong,{children:"TB_MENU nested set model"})," for hierarchical permissions. After authentication validates ",(0,s.jsx)(n.em,{children:"who you are"}),", authorization determines ",(0,s.jsx)(n.em,{children:"what you can do"}),". Every operation checks if the user has the required grant."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Authorization Flow:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"API Request (authenticated)\n    \u2193\n1. Extract grants from JWT token\n2. Determine required grant for operation\n3. Query TB_MENU nested set\n4. Check if user has grant (exact or parent)\n5. Grant found \u2192 proceed\n6. Grant missing \u2192 403 Forbidden\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Benefits:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u2705 Hierarchical permissions (parent includes children)"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Efficient grant checking (nested set queries)"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Fine-grained or broad permissions"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Centralized permission management"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Role-based access control"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"tb_menu-table",children:"TB_MENU Table"}),"\n",(0,s.jsx)(n.h3,{id:"schema",children:"Schema"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Nested set model"})," uses NLEFT/NRIGHT for hierarchy:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE TB_MENU (\n    MENU_ID VARCHAR(100) PRIMARY KEY,    -- Grant identifier\n    NLEFT INT NOT NULL,                   -- Left boundary\n    NRIGHT INT NOT NULL,                  -- Right boundary\n    DESCRIZIONE VARCHAR(255),             -- Description\n    MENU_TYPE VARCHAR(10),                -- Type (module, operation)\n    PARENT_ID VARCHAR(100),               -- Parent grant\n    CREATED_AT TIMESTAMP,\n    UPDATED_AT TIMESTAMP\n);\n\nCREATE INDEX idx_menu_nleft_nright ON TB_MENU(NLEFT, NRIGHT);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"nested-set-example",children:"Nested Set Example"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Visual Hierarchy:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"products (NLEFT=1, NRIGHT=10)\n\u251c\u2500\u2500 products.read (NLEFT=2, NRIGHT=3)\n\u251c\u2500\u2500 products.write (NLEFT=4, NRIGHT=7)\n\u2502   \u251c\u2500\u2500 products.create (NLEFT=5, NRIGHT=6)\n\u2514\u2500\u2500 products.delete (NLEFT=8, NRIGHT=9)\n\norders (NLEFT=11, NRIGHT=20)\n\u251c\u2500\u2500 orders.read (NLEFT=12, NRIGHT=13)\n\u251c\u2500\u2500 orders.write (NLEFT=14, NRIGHT=17)\n\u2502   \u251c\u2500\u2500 orders.create (NLEFT=15, NRIGHT=16)\n\u2514\u2500\u2500 orders.delete (NLEFT=18, NRIGHT=19)\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"SQL Data:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"INSERT INTO TB_MENU (MENU_ID, NLEFT, NRIGHT, DESCRIZIONE, PARENT_ID) VALUES\n('products', 1, 10, 'Products Module', NULL),\n('products.read', 2, 3, 'Read Products', 'products'),\n('products.write', 4, 7, 'Write Products', 'products'),\n('products.create', 5, 6, 'Create Products', 'products.write'),\n('products.delete', 8, 9, 'Delete Products', 'products'),\n('orders', 11, 20, 'Orders Module', NULL),\n('orders.read', 12, 13, 'Read Orders', 'orders'),\n('orders.write', 14, 17, 'Write Orders', 'orders'),\n('orders.create', 15, 16, 'Create Orders', 'orders.write'),\n('orders.delete', 18, 19, 'Delete Orders', 'orders');\n"})}),"\n",(0,s.jsx)(n.h2,{id:"grant-checking",children:"Grant Checking"}),"\n",(0,s.jsx)(n.h3,{id:"direct-grant-check",children:"Direct Grant Check"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Check if user has specific grant:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- User has grant 'products.read'?\nSELECT COUNT(*) FROM TB_MENU\nWHERE MENU_ID = 'products.read'\n  AND MENU_ID IN (user_grants);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"hierarchical-grant-check",children:"Hierarchical Grant Check"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Check if user has grant or parent grant:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- User has 'products.create' or any parent grant?\nSELECT COUNT(*) > 0 as HAS_GRANT\nFROM TB_MENU parent\nINNER JOIN TB_MENU child\n    ON child.NLEFT BETWEEN parent.NLEFT AND parent.NRIGHT\nWHERE parent.MENU_ID IN (user_grants)\n  AND child.MENU_ID = 'products.create';\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["User has grant: ",(0,s.jsx)(n.code,{children:"products"})]}),"\n",(0,s.jsxs)(n.li,{children:["Required grant: ",(0,s.jsx)(n.code,{children:"products.create"})]}),"\n",(0,s.jsxs)(n.li,{children:["Check: Is ",(0,s.jsx)(n.code,{children:"products.create"})," (NLEFT=5, NRIGHT=6) within ",(0,s.jsx)(n.code,{children:"products"})," (NLEFT=1, NRIGHT=10)?"]}),"\n",(0,s.jsx)(n.li,{children:"Result: \u2705 Yes (5 between 1 and 10)"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"corequery-grant-validation",children:"CoreQuery Grant Validation"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"RequestValidatorSubscriber.php:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"public function checkGrant(array $userGrants, string $requiredGrant): bool {\n    // 1. Get required grant from TB_MENU\n    $childNode = $this->pdo->query(\n        \"SELECT NLEFT, NRIGHT FROM TB_MENU WHERE MENU_ID = :grant\",\n        ['grant' => $requiredGrant]\n    )->fetch();\n\n    if (!$childNode) {\n        // Grant doesn't exist in system\n        return false;\n    }\n\n    // 2. Check if user has grant or parent grant\n    $hasGrant = $this->pdo->query(\n        \"SELECT COUNT(*) as count FROM TB_MENU parent\n         INNER JOIN TB_MENU child\n             ON child.NLEFT BETWEEN parent.NLEFT AND parent.NRIGHT\n         WHERE parent.MENU_ID IN (:user_grants)\n           AND child.NLEFT = :child_left\n           AND child.NRIGHT = :child_right\",\n        [\n            'user_grants' => $userGrants,\n            'child_left' => $childNode['NLEFT'],\n            'child_right' => $childNode['NRIGHT']\n        ]\n    )->fetch();\n\n    return $hasGrant['count'] > 0;\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"grant-hierarchy",children:"Grant Hierarchy"}),"\n",(0,s.jsx)(n.h3,{id:"parent-grants-include-children",children:"Parent Grants Include Children"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Grant Inheritance:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"User has: products\n    \u2193\nUser can:\n\u251c\u2500\u2500 products.read \u2705\n\u251c\u2500\u2500 products.write \u2705\n\u2502   \u2514\u2500\u2500 products.create \u2705\n\u2514\u2500\u2500 products.delete \u2705\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"SQL Query:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Find all grants user has (including children)\nSELECT child.MENU_ID\nFROM TB_MENU parent\nINNER JOIN TB_MENU child\n    ON child.NLEFT BETWEEN parent.NLEFT AND parent.NRIGHT\nWHERE parent.MENU_ID IN ('products');\n\n-- Result:\n-- products\n-- products.read\n-- products.write\n-- products.create\n-- products.delete\n"})}),"\n",(0,s.jsx)(n.h3,{id:"fine-grained-grants",children:"Fine-Grained Grants"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"User has specific grant only:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"User has: products.read\n    \u2193\nUser can:\n\u2514\u2500\u2500 products.read \u2705\n\nUser cannot:\n\u251c\u2500\u2500 products.write \u274c\n\u251c\u2500\u2500 products.create \u274c\n\u2514\u2500\u2500 products.delete \u274c\n"})}),"\n",(0,s.jsx)(n.h2,{id:"operation-grant-mapping",children:"Operation Grant Mapping"}),"\n",(0,s.jsx)(n.h3,{id:"read-operations-get",children:"Read Operations (GET)"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Required grants:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Endpoint"}),(0,s.jsx)(n.th,{children:"Grant"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"GET /api/v4/core/PRD"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"products.read"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"GET /api/v4/core/PRD/123"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"products.read"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"GET /api/v4/core/ORD"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"orders.read"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"GET /api/v4/core/CUST"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"customers.read"})})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"write-operations-postputpatch",children:"Write Operations (POST/PUT/PATCH)"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Required grants:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Endpoint"}),(0,s.jsx)(n.th,{children:"Grant"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"POST /api/v4/core/PRD"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"products.create"})," or ",(0,s.jsx)(n.code,{children:"products.write"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PUT /api/v4/core/PRD/123"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"products.write"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PATCH /api/v4/core/PRD/123"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"products.write"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"POST /api/v4/core/ORD"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"orders.create"})," or ",(0,s.jsx)(n.code,{children:"orders.write"})]})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"delete-operations-delete",children:"Delete Operations (DELETE)"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Required grants:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Endpoint"}),(0,s.jsx)(n.th,{children:"Grant"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"DELETE /api/v4/core/PRD/123"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"products.delete"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"DELETE /api/v4/core/ORD/123"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"orders.delete"})})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"grant-determination-logic",children:"Grant Determination Logic"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"CoreQuery determines required grant from dimension:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"public function getRequiredGrant(string $dimension, string $operation): string {\n    $dimensionLower = strtolower($dimension);\n\n    switch ($operation) {\n        case 'GET':\n            return \"{$dimensionLower}.read\";\n\n        case 'POST':\n            return \"{$dimensionLower}.create\";\n\n        case 'PUT':\n        case 'PATCH':\n            return \"{$dimensionLower}.write\";\n\n        case 'DELETE':\n            return \"{$dimensionLower}.delete\";\n\n        default:\n            throw new \\Exception(\"Unknown operation: $operation\");\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"jwt-token-grants",children:"JWT Token Grants"}),"\n",(0,s.jsx)(n.h3,{id:"token-structure",children:"Token Structure"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Grants stored in JWT payload:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "user_id": "user@example.com",\n  "grants": [\n    "products.read",\n    "products.write",\n    "orders.read",\n    "customers.read",\n    "customers.write"\n  ],\n  "exp": 1735574400\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"grant-assignment",children:"Grant Assignment"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Grants assigned during login:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// Auth service generates JWT\npublic function generateToken(User $user): string {\n    // Get user's grants from database\n    $grants = $this->getUserGrants($user->id);\n\n    $payload = [\n        'user_id' => $user->email,\n        'tenant_id' => $user->tenant_id,\n        'source' => $user->source,\n        'centro_dett' => $user->centro_dett,\n        'peso' => $user->peso,\n        'ambiente' => $user->ambiente,\n        'grants' => $grants,  // Array of grant IDs\n        'exp' => time() + 3600,\n        'iat' => time()\n    ];\n\n    return $this->jwt->encode($payload);\n}\n\nprivate function getUserGrants(string $userId): array {\n    return $this->pdo->query(\n        \"SELECT MENU_ID FROM USER_GRANTS WHERE USER_ID = :user_id\",\n        ['user_id' => $userId]\n    )->fetchAll(PDO::FETCH_COLUMN);\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"authorization-errors",children:"Authorization Errors"}),"\n",(0,s.jsx)(n.h3,{id:"403-forbidden",children:"403 Forbidden"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Response when grant check fails:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "error": "AuthorizationError",\n  "message": "Insufficient permissions for this operation",\n  "code": "GRANT_DENIED",\n  "status": 403,\n  "required_grant": "products.write",\n  "user_grants": ["products.read"],\n  "user": "user@example.com"\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# User has only products.read\nPOST /api/v4/core/PRD\nAuthorization: Bearer eyJhbGci...\n\n# Response: 403 Forbidden\n{\n  "error": "AuthorizationError",\n  "message": "Insufficient permissions for this operation",\n  "code": "GRANT_DENIED",\n  "status": 403,\n  "required_grant": "products.create",\n  "user_grants": ["products.read"]\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"client-side-grant-checking",children:"Client-Side Grant Checking"}),"\n",(0,s.jsx)(n.h3,{id:"hiding-ui-elements",children:"Hiding UI Elements"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Check grants before showing actions:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"class GrantChecker {\n  constructor(grants) {\n    this.grants = grants;  // From JWT token\n  }\n\n  hasGrant(requiredGrant) {\n    // Client-side approximation (not authoritative)\n    // Server ALWAYS checks grants\n\n    return this.grants.some(grant => {\n      // Exact match\n      if (grant === requiredGrant) {\n        return true;\n      }\n\n      // Parent match (simple check)\n      // e.g., 'products' includes 'products.read'\n      if (requiredGrant.startsWith(grant + '.')) {\n        return true;\n      }\n\n      return false;\n    });\n  }\n\n  canRead(dimension) {\n    return this.hasGrant(`${dimension}.read`);\n  }\n\n  canWrite(dimension) {\n    return this.hasGrant(`${dimension}.write`) ||\n           this.hasGrant(`${dimension}.create`);\n  }\n\n  canDelete(dimension) {\n    return this.hasGrant(`${dimension}.delete`);\n  }\n}\n\n// Usage in React\nfunction ProductList({ grants }) {\n  const grantChecker = new GrantChecker(grants);\n\n  return (\n    <div>\n      <h1>Products</h1>\n\n      {/* Show create button only if user can write */}\n      {grantChecker.canWrite('products') && (\n        <button onClick={handleCreate}>Create Product</button>\n      )}\n\n      <table>\n        {products.map(product => (\n          <tr key={product.PRD_ID}>\n            <td>{product.XPRD01}</td>\n\n            {/* Show delete button only if user can delete */}\n            {grantChecker.canDelete('products') && (\n              <td>\n                <button onClick={() => handleDelete(product.PRD_ID)}>\n                  Delete\n                </button>\n              </td>\n            )}\n          </tr>\n        ))}\n      </table>\n    </div>\n  );\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"decoding-jwt-client-side",children:"Decoding JWT Client-Side"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"class AuthService {\n  decodeToken(token) {\n    const parts = token.split('.');\n    const payload = JSON.parse(atob(parts[1]));\n    return payload;\n  }\n\n  getUserGrants() {\n    const token = this.getAccessToken();\n    if (!token) return [];\n\n    const payload = this.decodeToken(token);\n    return payload.grants || [];\n  }\n}\n\n// Usage\nconst authService = new AuthService();\nconst grants = authService.getUserGrants();\nconst grantChecker = new GrantChecker(grants);\n\nif (grantChecker.canWrite('products')) {\n  showCreateButton();\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"role-based-access-control",children:"Role-Based Access Control"}),"\n",(0,s.jsx)(n.h3,{id:"roles-as-grant-bundles",children:"Roles as Grant Bundles"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Define roles as collections of grants:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Admin role (full access)\nINSERT INTO ROLE_GRANTS (ROLE_ID, MENU_ID) VALUES\n('admin', 'products'),\n('admin', 'orders'),\n('admin', 'customers');\n\n-- Manager role (read/write, no delete)\nINSERT INTO ROLE_GRANTS (ROLE_ID, MENU_ID) VALUES\n('manager', 'products.read'),\n('manager', 'products.write'),\n('manager', 'orders.read'),\n('manager', 'orders.write');\n\n-- User role (read only)\nINSERT INTO ROLE_GRANTS (ROLE_ID, MENU_ID) VALUES\n('user', 'products.read'),\n('user', 'orders.read');\n"})}),"\n",(0,s.jsx)(n.h3,{id:"assign-roles-to-users",children:"Assign Roles to Users"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- Assign role to user\nINSERT INTO USER_ROLES (USER_ID, ROLE_ID)\nVALUES ('user@example.com', 'manager');\n\n-- Get user's grants via roles\nSELECT DISTINCT rg.MENU_ID\nFROM USER_ROLES ur\nINNER JOIN ROLE_GRANTS rg ON ur.ROLE_ID = rg.ROLE_ID\nWHERE ur.USER_ID = 'user@example.com';\n"})}),"\n",(0,s.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsx)(n.h3,{id:"-do",children:"\u2705 DO:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Use hierarchical grants:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- \u2705 Good - parent includes children\nUser has: products\nUser can do: products.read, products.write, products.delete\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Check grants server-side:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:'// \u2705 Good - server always validates\npublic function beforeQuery(string $dimension): void {\n    $requiredGrant = "{$dimension}.read";\n    if (!$this->checkGrant($this->userGrants, $requiredGrant)) {\n        throw new AuthorizationException("Grant denied: $requiredGrant");\n    }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Hide UI elements based on grants:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// \u2705 Good - better UX\n{hasGrant('products.write') && <CreateButton />}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Use roles for grant bundles:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- \u2705 Good - easier management\nINSERT INTO USER_ROLES (USER_ID, ROLE_ID)\nVALUES ('user@example.com', 'manager');\n"})}),"\n",(0,s.jsx)(n.h3,{id:"-dont",children:"\u274c DON'T:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Don't skip server-side validation:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// \u274c Bad - client check only\nif (hasGrant('products.write')) {\n  await createProduct(data);  // Server MUST still check!\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Don't hardcode grants in code:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// \u274c Bad - inflexible\nif ($user->email === 'admin@example.com') {\n    // Allow\n}\n\n// \u2705 Good - grant-based\nif ($this->checkGrant($user->grants, 'products.write')) {\n    // Allow\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Don't expose all grants in error:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'// \u274c Bad - security leak\n{\n  "error": "Grant denied",\n  "user_grants": ["secret.grant", "internal.admin"]\n}\n\n// \u2705 Good - minimal info\n{\n  "error": "Insufficient permissions",\n  "code": "GRANT_DENIED",\n  "status": 403\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u2705 TB_MENU nested set model for hierarchical permissions"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 NLEFT/NRIGHT for efficient grant checking"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Parent grants include all children"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Grants stored in JWT token"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Server validates every request"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 403 Forbidden when grant missing"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Client-side checking for better UX"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Roles bundle multiple grants"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key Takeaways:"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Authorization checks what you can do after authentication"}),"\n",(0,s.jsx)(n.li,{children:"TB_MENU nested set enables hierarchical permissions"}),"\n",(0,s.jsxs)(n.li,{children:["Parent grant includes all children (e.g., ",(0,s.jsx)(n.code,{children:"products"})," \u2192 ",(0,s.jsx)(n.code,{children:"products.read"}),")"]}),"\n",(0,s.jsx)(n.li,{children:"JWT token carries user's grants"}),"\n",(0,s.jsx)(n.li,{children:"Server validates grants for every operation"}),"\n",(0,s.jsx)(n.li,{children:"Client-side grant checking hides unavailable actions"}),"\n",(0,s.jsx)(n.li,{children:"Roles simplify grant management"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Grant Hierarchy Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'products (broad)\n\u251c\u2500\u2500 products.read (specific)\n\u251c\u2500\u2500 products.write (specific)\n\u2502   \u2514\u2500\u2500 products.create (very specific)\n\u2514\u2500\u2500 products.delete (specific)\n\nUser with "products" grant can do EVERYTHING.\nUser with "products.read" grant can ONLY read.\n'})}),"\n",(0,s.jsx)(n.h2,{id:"related-concepts",children:"Related Concepts"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/security/authentication",children:"Authentication"})," - JWT tokens"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/security",children:"Security Overview"})," - Multi-level security"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/security/tenant-isolation",children:"Tenant Isolation"})," - Multi-tenancy"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/security/context-security",children:"Context Security"})," - peso filtering"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/error-handling",children:"Error Handling"})," - 403 errors"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.M)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},2172:(e,n,r)=>{r.d(n,{I:()=>a,M:()=>d});var s=r(1504);const t={},i=s.createContext(t);function d(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:d(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);