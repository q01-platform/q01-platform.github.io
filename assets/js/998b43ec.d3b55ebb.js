"use strict";(self.webpackChunkq_01_docs=self.webpackChunkq_01_docs||[]).push([[9288],{4864:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>c,contentTitle:()=>s,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>l});var t=r(7624),i=r(2172);const a={title:"Transactions",sidebar_label:"ACID Transactions",sidebar_position:7,description:"Transaction management and ACID guarantees"},s="ACID Transactions",o={id:"products/map.q01.io/core-api-platform-v4/write-patterns/transactions",title:"Transactions",description:"Transaction management and ACID guarantees",source:"@site/docs/products/map.q01.io/core-api-platform-v4/04-write-patterns/transactions.md",sourceDirName:"products/map.q01.io/core-api-platform-v4/04-write-patterns",slug:"/products/map.q01.io/core-api-platform-v4/write-patterns/transactions",permalink:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/transactions",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:7,frontMatter:{title:"Transactions",sidebar_label:"ACID Transactions",sidebar_position:7,description:"Transaction management and ACID guarantees"},sidebar:"mapSidebar",previous:{title:"Multi-Level Validation",permalink:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/validation"},next:{title:"Cascade Operations",permalink:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/cascade-operations"}},c={},l=[{value:"Overview",id:"overview",level:2},{value:"Transaction Scope",id:"transaction-scope",level:2},{value:"Single Write Operation",id:"single-write-operation",level:3},{value:"Atomicity",id:"atomicity",level:2},{value:"All-or-Nothing Execution",id:"all-or-nothing-execution",level:3},{value:"Consistency",id:"consistency",level:2},{value:"Database Constraints Enforced",id:"database-constraints-enforced",level:3},{value:"Isolation",id:"isolation",level:2},{value:"Concurrent Transaction Handling",id:"concurrent-transaction-handling",level:3},{value:"Row-Level Locking",id:"row-level-locking",level:3},{value:"Durability",id:"durability",level:2},{value:"Write-Ahead Logging (WAL)",id:"write-ahead-logging-wal",level:3},{value:"Outbox Pattern Durability",id:"outbox-pattern-durability",level:3},{value:"Transaction Lifecycle",id:"transaction-lifecycle",level:2},{value:"Complete Transaction Example",id:"complete-transaction-example",level:3},{value:"Error Handling and Rollback",id:"error-handling-and-rollback",level:2},{value:"Automatic Rollback",id:"automatic-rollback",level:3},{value:"Deadlock Detection and Retry",id:"deadlock-detection-and-retry",level:2},{value:"Deadlock Scenario",id:"deadlock-scenario",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"\u2705 DO:",id:"-do",level:3},{value:"\u274c DON&#39;T:",id:"-dont",level:3},{value:"Summary",id:"summary",level:2},{value:"Related Concepts",id:"related-concepts",level:2}];function d(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.M)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.h1,{id:"acid-transactions",children:"ACID Transactions"}),"\n",(0,t.jsx)(e.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsxs)(e.p,{children:["Every write operation in CoreWrite executes within an ",(0,t.jsx)(e.strong,{children:"ACID transaction"}),". This ensures data consistency, integrity, and reliability across all operations including main record, cascades, and outbox events."]}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"ACID Properties:"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Atomicity"})," - All operations succeed or all fail"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Consistency"})," - Database remains in valid state"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Isolation"})," - Concurrent transactions don't interfere"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Durability"})," - Committed changes persist permanently"]}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"transaction-scope",children:"Transaction Scope"}),"\n",(0,t.jsx)(e.h3,{id:"single-write-operation",children:"Single Write Operation"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Every POST/PUT/PATCH/DELETE is transactional:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:"BEGIN TRANSACTION\n    \u2193\n1. Insert/Update/Delete main record\n2. Execute cascade operations\n3. Insert outbox event\n    \u2193\nCOMMIT TRANSACTION\n    \u2193\nSuccess: All changes persisted\n    OR\nROLLBACK TRANSACTION\n    \u2193\nFailure: All changes reverted\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"CoreWrite Implementation (PHP):"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"// CoreWrite DataStore.php\npublic function insert(string $dimension, array $data): array {\n    $this->pdo->beginTransaction();\n\n    try {\n        // 1. Insert main record\n        $recordId = $this->insertMainRecord($dimension, $data);\n\n        // 2. Execute INSERT_CASCADE operations\n        $this->executeCascadeInserts($dimension, $recordId, $data);\n\n        // 3. Insert outbox event\n        $this->insertOutboxEvent($dimension, $recordId, 'INSERT', $data);\n\n        // 4. Commit transaction (all-or-nothing)\n        $this->pdo->commit();\n\n        return ['id' => $recordId, 'status' => 'success'];\n    } catch (\\Exception $e) {\n        // Rollback on ANY error\n        $this->pdo->rollBack();\n        throw $e;\n    }\n}\n"})}),"\n",(0,t.jsx)(e.h2,{id:"atomicity",children:"Atomicity"}),"\n",(0,t.jsx)(e.h3,{id:"all-or-nothing-execution",children:"All-or-Nothing Execution"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Success case:"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Request:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:'POST /api/v4/core/ORD\n{\n  "data": {\n    "XORD01": "ORD-2025-001",\n    "XORD_CUSTOMER_ID": "cust_123",\n    "items": [\n      { "XORDITEM10": "prd_1", "XORDITEM_QTY": 2 },\n      { "XORDITEM10": "prd_2", "XORDITEM_QTY": 1 }\n    ]\n  }\n}\n'})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Transaction SQL:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"BEGIN TRANSACTION;\n\n-- 1. Insert order\nINSERT INTO TB_ANAG_ORD00 (XORD01, XORD_CUSTOMER_ID, TREC, CDATA, OWNER)\nVALUES ('ORD-2025-001', 'cust_123', 'N', '20251219160000', 'user@example.com');\n\n-- 2. Insert order items (cascade)\nINSERT INTO TB_ANAG_ORDITEM00 (XORDITEM_ORDER_ID, XORDITEM10, XORDITEM_QTY, TREC, CDATA, OWNER)\nVALUES (123, 'prd_1', 2, 'N', '20251219160000', 'user@example.com');\n\nINSERT INTO TB_ANAG_ORDITEM00 (XORDITEM_ORDER_ID, XORDITEM10, XORDITEM_QTY, TREC, CDATA, OWNER)\nVALUES (123, 'prd_2', 1, 'N', '20251219160000', 'user@example.com');\n\n-- 3. Insert outbox event\nINSERT INTO OUTBOX (event_type, aggregate_id, payload, created_at)\nVALUES ('OrderCreated', 123, '{\"XORD01\":\"ORD-2025-001\",...}', '20251219160000');\n\nCOMMIT;  -- \u2705 All changes persisted\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Result:"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Order created: TB_ANAG_ORD00"}),"\n",(0,t.jsx)(e.li,{children:"2 items created: TB_ANAG_ORDITEM00"}),"\n",(0,t.jsx)(e.li,{children:"Event queued: OUTBOX"}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Failure case (item 2 fails validation):"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"BEGIN TRANSACTION;\n\n-- 1. Insert order\nINSERT INTO TB_ANAG_ORD00 (...) VALUES (...);  -- \u2705 Success\n\n-- 2. Insert item 1\nINSERT INTO TB_ANAG_ORDITEM00 (...) VALUES (...);  -- \u2705 Success\n\n-- 3. Insert item 2\nINSERT INTO TB_ANAG_ORDITEM00 (...) VALUES (...);  -- \u274c Fails (foreign key violation)\n\nROLLBACK;  -- \u26a0\ufe0f All changes reverted\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Result:"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Order NOT created"}),"\n",(0,t.jsx)(e.li,{children:"Item 1 NOT created"}),"\n",(0,t.jsx)(e.li,{children:"Item 2 NOT created"}),"\n",(0,t.jsx)(e.li,{children:"No outbox event"}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:["\u26a0\ufe0f ",(0,t.jsx)(e.strong,{children:"Atomicity ensures no partial data"})," - either complete success or complete failure."]}),"\n",(0,t.jsx)(e.h2,{id:"consistency",children:"Consistency"}),"\n",(0,t.jsx)(e.h3,{id:"database-constraints-enforced",children:"Database Constraints Enforced"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Foreign keys, unique constraints, and check constraints are validated:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"-- Product table constraints\nCREATE TABLE TB_ANAG_PRD00 (\n    PRD_ID VARCHAR(36) PRIMARY KEY,\n    XPRD01 VARCHAR(255) NOT NULL,  -- Name required\n    XPRD02 DECIMAL(10,2) NOT NULL CHECK (XPRD02 >= 0),  -- Price non-negative\n    XPRD05 VARCHAR(50),\n    XPRD03 VARCHAR(50) UNIQUE,  -- Counter unique\n    FOREIGN KEY (XPRD05) REFERENCES TB_ANAG_CAT00(CAT_ID)  -- Category exists\n);\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Violation example:"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Request:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:'POST /api/v4/core/PRD\n{\n  "data": {\n    "XPRD01": "Widget",\n    "XPRD02": -10.00,  // \u274c Negative price (CHECK constraint violation)\n    "XPRD05": "cat_invalid"  // \u274c Category doesn\'t exist (FK violation)\n  }\n}\n'})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Transaction:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"BEGIN TRANSACTION;\n\nINSERT INTO TB_ANAG_PRD00 (XPRD01, XPRD02, XPRD05, ...)\nVALUES ('Widget', -10.00, 'cat_invalid', ...);\n\n-- \u274c CHECK constraint failed: XPRD02 >= 0\n-- \u274c Foreign key constraint failed: cat_invalid not in TB_ANAG_CAT00\n\nROLLBACK;  -- Database remains consistent\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Response:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-json",children:'{\n  "error": "ConstraintViolationError",\n  "message": "Check constraint violation: XPRD02 must be >= 0",\n  "code": "CHECK_CONSTRAINT_VIOLATION",\n  "status": 400\n}\n'})}),"\n",(0,t.jsx)(e.h2,{id:"isolation",children:"Isolation"}),"\n",(0,t.jsx)(e.h3,{id:"concurrent-transaction-handling",children:"Concurrent Transaction Handling"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Isolation level: READ COMMITTED (default):"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:"Transaction A (User 1)        Transaction B (User 2)\n    |                             |\nBEGIN TRANSACTION            BEGIN TRANSACTION\n    |                             |\nUPDATE product                    |\nSET XPRD02 = 89.99               |\nWHERE PRD_ID = 123               |\n    |                             |\n    |                        UPDATE product\n    |                        SET XPRD02 = 79.99\n    |                        WHERE PRD_ID = 123\n    |                             |\n    |                        [BLOCKED - waiting for A]\n    |                             |\nCOMMIT                            |\n    |                             |\n    |                        [UNBLOCKED - proceeds]\n    |                             |\n    |                        COMMIT\n"})}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Result:"})," Transaction B sees A's committed changes (89.99), then overwrites with 79.99 (last write wins)."]}),"\n",(0,t.jsx)(e.h3,{id:"row-level-locking",children:"Row-Level Locking"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"CoreWrite uses row-level locks (SELECT FOR UPDATE):"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"// CoreWrite DataStore.php\npublic function update(string $dimension, int $id, array $data): array {\n    $this->pdo->beginTransaction();\n\n    try {\n        // 1. Lock row for update\n        $current = $this->pdo->query(\n            \"SELECT * FROM TB_ANAG_{$dimension}00 WHERE {$dimension}_ID = :id FOR UPDATE\",\n            ['id' => $id]\n        )->fetch();\n\n        if (!$current) {\n            throw new NotFoundException(\"Record not found\");\n        }\n\n        // 2. Update record (no one else can modify until commit)\n        $this->updateRecord($dimension, $id, $data);\n\n        // 3. Execute cascades\n        $this->executeCascadeUpdates($dimension, $id, $data);\n\n        // 4. Insert outbox event\n        $this->insertOutboxEvent($dimension, $id, 'UPDATE', $data);\n\n        // 5. Commit (releases lock)\n        $this->pdo->commit();\n\n        return ['id' => $id, 'status' => 'success'];\n    } catch (\\Exception $e) {\n        $this->pdo->rollBack();\n        throw $e;\n    }\n}\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Benefits:"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Prevents lost updates"}),"\n",(0,t.jsx)(e.li,{children:"Ensures serializable modifications"}),"\n",(0,t.jsx)(e.li,{children:"Other transactions wait (no overwrite)"}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"durability",children:"Durability"}),"\n",(0,t.jsx)(e.h3,{id:"write-ahead-logging-wal",children:"Write-Ahead Logging (WAL)"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Database WAL ensures committed changes persist:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:"Transaction committed\n    \u2193\n1. Write changes to WAL (write-ahead log)\n2. WAL synced to disk (fsync)\n3. Changes applied to data files (async)\n    \u2193\nPower failure or crash\n    \u2193\nDatabase recovery from WAL\n    \u2193\nAll committed transactions replayed\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Durability guarantee:"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Committed changes survive crashes"}),"\n",(0,t.jsx)(e.li,{children:"Power failures don't lose data"}),"\n",(0,t.jsx)(e.li,{children:"Database can recover to consistent state"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"outbox-pattern-durability",children:"Outbox Pattern Durability"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Outbox events are part of transaction:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-sql",children:"BEGIN TRANSACTION;\n\n-- 1. Write main record\nINSERT INTO TB_ANAG_PRD00 (...) VALUES (...);\n\n-- 2. Write outbox event (same transaction)\nINSERT INTO OUTBOX (event_type, aggregate_id, payload, created_at)\nVALUES ('ProductCreated', 123, '...', '20251219160000');\n\nCOMMIT;  -- Both persisted together\n"})}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Benefit:"})," Event publishing is guaranteed (at-least-once delivery)."]}),"\n",(0,t.jsx)(e.h2,{id:"transaction-lifecycle",children:"Transaction Lifecycle"}),"\n",(0,t.jsx)(e.h3,{id:"complete-transaction-example",children:"Complete Transaction Example"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Request:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:'POST /api/v4/core/PRD\n{\n  "data": {\n    "XPRD01": "Widget Pro",\n    "XPRD02": 99.99,\n    "XPRD05": "cat_electronics"\n  }\n}\n'})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Transaction Steps:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"// 1. Start transaction\n$pdo->beginTransaction();\n\n// 2. Generate UUID for primary key\n$productId = Uuid::uuid4();\n\n// 3. Generate counter (TB_COUNTER)\n$counter = $this->generateCounter('PRD', 'XPRD03');  // \"PRD-2025-001\"\n\n// 4. Set audit fields\n$data['PRD_ID'] = $productId;\n$data['XPRD03'] = $counter;\n$data['TREC'] = 'N';\n$data['CDATA'] = date('YmdHis');\n$data['OWNER'] = $currentUser;\n\n// 5. Insert main record\n$sql = \"INSERT INTO TB_ANAG_PRD00 (PRD_ID, XPRD01, XPRD02, XPRD03, XPRD05, TREC, CDATA, OWNER)\n        VALUES (:PRD_ID, :XPRD01, :XPRD02, :XPRD03, :XPRD05, :TREC, :CDATA, :OWNER)\";\n$pdo->execute($sql, $data);\n\n// 6. Execute INSERT_CASCADE (if any)\nforeach ($cascades as $cascade) {\n    $this->executeCascade($cascade, $productId, $data);\n}\n\n// 7. Insert outbox event\n$event = [\n    'event_type' => 'ProductCreated',\n    'aggregate_id' => $productId,\n    'aggregate_type' => 'PRD',\n    'payload' => json_encode($data),\n    'created_at' => date('YmdHis')\n];\n$pdo->execute(\"INSERT INTO OUTBOX (...) VALUES (...)\", $event);\n\n// 8. Commit transaction\n$pdo->commit();\n\n// \u2705 All changes persisted atomically\n"})}),"\n",(0,t.jsx)(e.h2,{id:"error-handling-and-rollback",children:"Error Handling and Rollback"}),"\n",(0,t.jsx)(e.h3,{id:"automatic-rollback",children:"Automatic Rollback"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Any exception triggers rollback:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"public function insert(string $dimension, array $data): array {\n    $this->pdo->beginTransaction();\n\n    try {\n        $recordId = $this->insertMainRecord($dimension, $data);\n        $this->executeCascades($dimension, $recordId, $data);\n        $this->insertOutboxEvent($dimension, $recordId, 'INSERT', $data);\n\n        $this->pdo->commit();\n        return ['id' => $recordId, 'status' => 'success'];\n    } catch (ValidationException $e) {\n        $this->pdo->rollBack();  // Validation failed\n        throw $e;\n    } catch (ConstraintViolationException $e) {\n        $this->pdo->rollBack();  // DB constraint violated\n        throw $e;\n    } catch (\\PDOException $e) {\n        $this->pdo->rollBack();  // Database error\n        throw new DatabaseException('Database operation failed', 0, $e);\n    } catch (\\Exception $e) {\n        $this->pdo->rollBack();  // Any other error\n        throw $e;\n    }\n}\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Error types that trigger rollback:"})}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:"Validation errors (required field missing)"}),"\n",(0,t.jsx)(e.li,{children:"Constraint violations (foreign key, unique, check)"}),"\n",(0,t.jsx)(e.li,{children:"Database errors (connection lost, deadlock)"}),"\n",(0,t.jsx)(e.li,{children:"Business logic errors (custom validation)"}),"\n",(0,t.jsx)(e.li,{children:"Cascade failures"}),"\n",(0,t.jsx)(e.li,{children:"Any unexpected exceptions"}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"deadlock-detection-and-retry",children:"Deadlock Detection and Retry"}),"\n",(0,t.jsx)(e.h3,{id:"deadlock-scenario",children:"Deadlock Scenario"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:"Transaction A                Transaction B\n    |                            |\nBEGIN                        BEGIN\n    |                            |\nUPDATE product 123               |\n(locks product 123)              |\n    |                            |\n    |                       UPDATE product 456\n    |                       (locks product 456)\n    |                            |\nUPDATE product 456               |\n(waits for B's lock)             |\n    |                            |\n    |                       UPDATE product 123\n    |                       (waits for A's lock)\n    |                            |\n    |                            |\n[DEADLOCK DETECTED]              |\n    \u2193                            |\nROLLBACK                         |\n    |                            |\n    |                       [CONTINUES]\n    |                            |\n    |                       COMMIT\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"CoreWrite deadlock handling:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"public function insertWithRetry(string $dimension, array $data, int $maxRetries = 3): array {\n    $attempt = 0;\n\n    while ($attempt < $maxRetries) {\n        try {\n            return $this->insert($dimension, $data);\n        } catch (\\PDOException $e) {\n            // Deadlock error code (MySQL: 1213, Oracle: ORA-00060)\n            if ($this->isDeadlock($e)) {\n                $attempt++;\n                if ($attempt >= $maxRetries) {\n                    throw new DeadlockException('Transaction failed after retries', 0, $e);\n                }\n                // Exponential backoff\n                usleep(pow(2, $attempt) * 100000);  // 200ms, 400ms, 800ms\n                continue;\n            }\n            throw $e;\n        }\n    }\n}\n"})}),"\n",(0,t.jsx)(e.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,t.jsx)(e.h3,{id:"-do",children:"\u2705 DO:"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Trust transaction management:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"// \u2705 Good - let CoreWrite handle transactions\nawait createProduct(data);\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Keep transactions short:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"// \u2705 Good - quick transaction\nBEGIN TRANSACTION;\nINSERT INTO ...;\nINSERT INTO OUTBOX ...;\nCOMMIT;\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Handle transaction failures gracefully:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-javascript",children:"// \u2705 Good - retry on failure\ntry {\n  await createProduct(data);\n} catch (error) {\n  if (error.code === 'DEADLOCK') {\n    await retryWithBackoff(() => createProduct(data));\n  }\n}\n"})}),"\n",(0,t.jsx)(e.h3,{id:"-dont",children:"\u274c DON'T:"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Don't try to manage transactions manually:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"// \u274c Bad - CoreWrite handles this\n$pdo->beginTransaction();\n// ... CoreWrite operations ...\n$pdo->commit();\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Don't perform long operations in transactions:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-php",children:"// \u274c Bad - locks held too long\nBEGIN TRANSACTION;\nINSERT INTO ...;\nsleep(10);  // External API call, file I/O, etc.\nCOMMIT;\n"})}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Don't ignore transaction errors:"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-javascript",children:"// \u274c Bad - swallow errors\ntry {\n  await createProduct(data);\n} catch (error) {\n  // Ignore\n}\n\n// \u2705 Good - handle appropriately\ntry {\n  await createProduct(data);\n} catch (error) {\n  logError(error);\n  notifyUser(error);\n}\n"})}),"\n",(0,t.jsx)(e.h2,{id:"summary",children:"Summary"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u2705 Every write operation is ACID transactional"}),"\n",(0,t.jsx)(e.li,{children:"\u2705 Atomicity: All operations succeed or all fail (no partial writes)"}),"\n",(0,t.jsx)(e.li,{children:"\u2705 Consistency: Database constraints enforced"}),"\n",(0,t.jsx)(e.li,{children:"\u2705 Isolation: Row-level locking prevents concurrent conflicts"}),"\n",(0,t.jsx)(e.li,{children:"\u2705 Durability: Committed changes persist permanently"}),"\n",(0,t.jsx)(e.li,{children:"\u2705 Automatic rollback on any error"}),"\n",(0,t.jsx)(e.li,{children:"\u2705 Outbox event included in transaction (at-least-once delivery)"}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Key Takeaways:"})}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:"CoreWrite manages transactions automatically"}),"\n",(0,t.jsx)(e.li,{children:"Main record + cascades + outbox are atomic"}),"\n",(0,t.jsx)(e.li,{children:"Row-level locking prevents lost updates"}),"\n",(0,t.jsx)(e.li,{children:"Rollback on any validation or database error"}),"\n",(0,t.jsx)(e.li,{children:"Deadlock detection with automatic retry"}),"\n",(0,t.jsx)(e.li,{children:"Committed changes survive crashes (WAL)"}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Transaction Guarantees:"})}),"\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{children:"Property"}),(0,t.jsx)(e.th,{children:"Guarantee"})]})}),(0,t.jsxs)(e.tbody,{children:[(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"Atomicity"}),(0,t.jsx)(e.td,{children:"All-or-nothing execution"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"Consistency"}),(0,t.jsx)(e.td,{children:"Constraints enforced"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"Isolation"}),(0,t.jsx)(e.td,{children:"READ COMMITTED, row locks"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"Durability"}),(0,t.jsx)(e.td,{children:"WAL ensures persistence"})]})]})]}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"Next:"})," ",(0,t.jsx)(e.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/cascade-operations",children:"Cascade Operations \u2192"})]}),"\n",(0,t.jsx)(e.h2,{id:"related-concepts",children:"Related Concepts"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/cascade-operations",children:"Cascade Operations"})," - INSERT/UPDATE/DELETE_CASCADE"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/outbox-pattern",children:"Outbox Pattern"})," - Event sourcing with transactions"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/validation",children:"Validation"})," - Multi-level validation"]}),"\n"]})]})}function h(n={}){const{wrapper:e}={...(0,i.M)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(d,{...n})}):d(n)}},2172:(n,e,r)=>{r.d(e,{I:()=>o,M:()=>s});var t=r(1504);const i={},a=t.createContext(i);function s(n){const e=t.useContext(a);return t.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:s(n.components),t.createElement(a.Provider,{value:e},n.children)}}}]);