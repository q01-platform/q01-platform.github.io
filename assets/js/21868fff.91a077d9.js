"use strict";(self.webpackChunkq_01_docs=self.webpackChunkq_01_docs||[]).push([[530],{620:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>o,contentTitle:()=>c,default:()=>u,frontMatter:()=>t,metadata:()=>a,toc:()=>l});var s=r(7624),i=r(2172);const t={title:"Custom Functions",sidebar_label:"Custom Functions",sidebar_position:8,description:"Pre-insert functions and post-update hooks"},c="Custom Functions",a={id:"products/map.q01.io/core-api-platform-v4/advanced-topics/custom-functions",title:"Custom Functions",description:"Pre-insert functions and post-update hooks",source:"@site/docs/products/map.q01.io/core-api-platform-v4/06-advanced-topics/custom-functions.md",sourceDirName:"products/map.q01.io/core-api-platform-v4/06-advanced-topics",slug:"/products/map.q01.io/core-api-platform-v4/advanced-topics/custom-functions",permalink:"/docs/products/map.q01.io/core-api-platform-v4/advanced-topics/custom-functions",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:8,frontMatter:{title:"Custom Functions",sidebar_label:"Custom Functions",sidebar_position:8,description:"Pre-insert functions and post-update hooks"},sidebar:"mapSidebar",previous:{title:"Webhook Integration",permalink:"/docs/products/map.q01.io/core-api-platform-v4/advanced-topics/webhook-integration"},next:{title:"Internal Architecture",permalink:"/docs/products/map.q01.io/core-api-platform-v4/advanced-topics/internal-architecture"}},o={},l=[{value:"Overview",id:"overview",level:2},{value:"Function Configuration",id:"function-configuration",level:2},{value:"TB_VAR Metadata Structure",id:"tb_var-metadata-structure",level:3},{value:"Pre-Insert Functions",id:"pre-insert-functions",level:2},{value:"UUID Function",id:"uuid-function",level:3},{value:"Counter Function",id:"counter-function",level:3},{value:"Slugify Function",id:"slugify-function",level:3},{value:"MD5 Function",id:"md5-function",level:3},{value:"Sequence Function",id:"sequence-function",level:3},{value:"Timestamp Function",id:"timestamp-function",level:3},{value:"Concat Function",id:"concat-function",level:3},{value:"Default Function",id:"default-function",level:3},{value:"Post-Update Hooks",id:"post-update-hooks",level:2},{value:"On Update Functions",id:"on-update-functions",level:3},{value:"Conditional Functions",id:"conditional-functions",level:3},{value:"Function Execution Order",id:"function-execution-order",level:2},{value:"Pre-Insert Phase",id:"pre-insert-phase",level:3},{value:"Function Dependencies",id:"function-dependencies",level:3},{value:"Custom Function Development",id:"custom-function-development",level:2},{value:"Create New Function",id:"create-new-function",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"\u2705 DO:",id:"-do",level:3},{value:"\u274c DON&#39;T:",id:"-dont",level:3},{value:"Summary",id:"summary",level:2},{value:"Related Concepts",id:"related-concepts",level:2}];function d(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.M)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.h1,{id:"custom-functions",children:"Custom Functions"}),"\n",(0,s.jsx)(e.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.strong,{children:"Custom functions"})," enable metadata-driven field initialization and transformation without writing application code. They are defined in ",(0,s.jsx)(e.strong,{children:"TB_VAR"})," metadata and executed automatically by CoreWrite during INSERT and UPDATE operations."]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Available Functions:"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"uuid"})," - Generate UUID v4"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"md5"})," - Generate MD5 hash"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"counter"})," - Sequential formatted identifiers"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"slugify"})," - URL-safe slugs from text"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"sequence"})," - Auto-increment values"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"timestamp"})," - Current timestamp"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"concat"})," - Concatenate field values"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"default"})," - Default value if empty"]}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Benefits:"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u2705 No application code required"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 Consistent behavior across all clients"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 Metadata-driven configuration"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 Automatic execution by CoreWrite"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 Business logic centralization"}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"function-configuration",children:"Function Configuration"}),"\n",(0,s.jsx)(e.h3,{id:"tb_var-metadata-structure",children:"TB_VAR Metadata Structure"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sql",children:"SELECT\n  VAR_ID,           -- Variable ID\n  DIM_ID,           -- Dimension ID\n  VAR,              -- Field name (e.g., XPRD03)\n  VAR_FUNCTION,     -- Function name (e.g., 'uuid', 'counter')\n  VAR_PARAMS        -- Function parameters (JSON)\nFROM TB_VAR\nWHERE DIM_ID = 5  -- PRD dimension\nAND VAR_FUNCTION IS NOT NULL;\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Example configuration:"})}),"\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"VAR_ID"}),(0,s.jsx)(e.th,{children:"DIM_ID"}),(0,s.jsx)(e.th,{children:"VAR"}),(0,s.jsx)(e.th,{children:"VAR_FUNCTION"}),(0,s.jsx)(e.th,{children:"VAR_PARAMS"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"101"}),(0,s.jsx)(e.td,{children:"5"}),(0,s.jsx)(e.td,{children:"PRD_ID"}),(0,s.jsx)(e.td,{children:"uuid"}),(0,s.jsx)(e.td,{children:"null"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"102"}),(0,s.jsx)(e.td,{children:"5"}),(0,s.jsx)(e.td,{children:"XPRD03"}),(0,s.jsx)(e.td,{children:"counter"}),(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:'{"prefix": "PRD", "length": 8, "start": 1000}'})})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"103"}),(0,s.jsx)(e.td,{children:"5"}),(0,s.jsx)(e.td,{children:"XPRD04"}),(0,s.jsx)(e.td,{children:"slugify"}),(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:'{"source": "XPRD01"}'})})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"104"}),(0,s.jsx)(e.td,{children:"5"}),(0,s.jsx)(e.td,{children:"XPRD07"}),(0,s.jsx)(e.td,{children:"md5"}),(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:'{"source": "XPRD03"}'})})]})]})]}),"\n",(0,s.jsx)(e.h2,{id:"pre-insert-functions",children:"Pre-Insert Functions"}),"\n",(0,s.jsx)(e.h3,{id:"uuid-function",children:"UUID Function"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Generate unique identifiers:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n  "VAR": "PRD_ID",\n  "VAR_FUNCTION": "uuid",\n  "VAR_PARAMS": null\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Example:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'# Create product without PRD_ID\ncurl -X POST https://api.q01.io/api/v4/core/products \\\n  -H "Authorization: Bearer $TOKEN" \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "XPRD01": "Widget Pro",\n    "XPRD02": 29.99\n  }\'\n\n# Response - PRD_ID auto-generated\n{\n  "PRD_ID": "550e8400-e29b-41d4-a716-446655440000",\n  "XPRD01": "Widget Pro",\n  "XPRD02": 29.99\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Implementation:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-php",children:"class PreInsertFunctions {\n    public function uuid(): string {\n        // Generate UUID v4\n        return sprintf(\n            '%04x%04x-%04x-%04x-%04x-%04x%04x%04x',\n            mt_rand(0, 0xffff),\n            mt_rand(0, 0xffff),\n            mt_rand(0, 0xffff),\n            mt_rand(0, 0x0fff) | 0x4000,\n            mt_rand(0, 0x3fff) | 0x8000,\n            mt_rand(0, 0xffff),\n            mt_rand(0, 0xffff),\n            mt_rand(0, 0xffff)\n        );\n    }\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"counter-function",children:"Counter Function"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Generate sequential formatted identifiers:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n  "VAR": "XPRD03",\n  "VAR_FUNCTION": "counter",\n  "VAR_PARAMS": {\n    "prefix": "PRD",\n    "suffix": "",\n    "length": 8,\n    "start": 1000,\n    "step": 1,\n    "pad_char": "0"\n  }\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Example output:"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:"PRD00001000"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:"PRD00001001"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:"PRD00001002"})}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"TB_COUNTER table:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE TB_COUNTER (\n  COUNTER_ID INT PRIMARY KEY AUTO_INCREMENT,\n  COUNTER_NAME VARCHAR(100) NOT NULL UNIQUE,\n  CURRENT_VALUE INT NOT NULL DEFAULT 0,\n  PREFIX VARCHAR(20),\n  SUFFIX VARCHAR(20),\n  LENGTH INT DEFAULT 8,\n  PAD_CHAR CHAR(1) DEFAULT '0',\n  UPDATED_AT TIMESTAMP DEFAULT NOW() ON UPDATE NOW(),\n  INDEX idx_counter_name (COUNTER_NAME)\n);\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Usage:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'# Create product - XPRD03 auto-generated\ncurl -X POST https://api.q01.io/api/v4/core/products \\\n  -H "Authorization: Bearer $TOKEN" \\\n  -d \'{\n    "XPRD01": "Widget",\n    "XPRD02": 19.99\n  }\'\n\n# Response\n{\n  "PRD_ID": 123,\n  "XPRD01": "Widget",\n  "XPRD02": 19.99,\n  "XPRD03": "PRD00001000"  # Auto-generated\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Implementation:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-php",children:"class PreInsertFunctions {\n    public function counter(array $params, array $record): string {\n        $counterName = $params['counter_name'] ?? $params['prefix'];\n\n        // Atomic increment\n        $this->db->beginTransaction();\n\n        $counter = $this->db->query(\n            \"SELECT * FROM TB_COUNTER WHERE COUNTER_NAME = ? FOR UPDATE\",\n            [$counterName]\n        )->fetch();\n\n        if (!$counter) {\n            // Create counter\n            $this->db->query(\n                \"INSERT INTO TB_COUNTER (COUNTER_NAME, CURRENT_VALUE, PREFIX, LENGTH, PAD_CHAR)\n                 VALUES (?, ?, ?, ?, ?)\",\n                [$counterName, $params['start'], $params['prefix'], $params['length'], $params['pad_char']]\n            );\n            $value = $params['start'];\n        } else {\n            // Increment counter\n            $value = $counter['CURRENT_VALUE'] + ($params['step'] ?? 1);\n            $this->db->query(\n                \"UPDATE TB_COUNTER SET CURRENT_VALUE = ? WHERE COUNTER_NAME = ?\",\n                [$value, $counterName]\n            );\n        }\n\n        $this->db->commit();\n\n        // Format value\n        $formatted = str_pad(\n            $value,\n            $params['length'],\n            $params['pad_char'] ?? '0',\n            STR_PAD_LEFT\n        );\n\n        return ($params['prefix'] ?? '') . $formatted . ($params['suffix'] ?? '');\n    }\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"slugify-function",children:"Slugify Function"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Generate URL-safe slugs:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n  "VAR": "XPRD04",\n  "VAR_FUNCTION": "slugify",\n  "VAR_PARAMS": {\n    "source": "XPRD01",\n    "separator": "-",\n    "lowercase": true\n  }\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Example:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'# Input\n{\n  "XPRD01": "Widget Pro 2024!"\n}\n\n# Output\n{\n  "XPRD01": "Widget Pro 2024!",\n  "XPRD04": "widget-pro-2024"  # Auto-generated slug\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Implementation:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-php",children:"class PreInsertFunctions {\n    public function slugify(array $params, array $record): string {\n        $source = $record[$params['source']] ?? '';\n        $separator = $params['separator'] ?? '-';\n\n        // Convert to ASCII\n        $slug = iconv('UTF-8', 'ASCII//TRANSLIT', $source);\n\n        // Remove special characters\n        $slug = preg_replace('/[^a-zA-Z0-9\\s-]/', '', $slug);\n\n        // Replace spaces with separator\n        $slug = preg_replace('/\\s+/', $separator, $slug);\n\n        // Remove duplicate separators\n        $slug = preg_replace('/' . preg_quote($separator) . '+/', $separator, $slug);\n\n        // Trim separators from ends\n        $slug = trim($slug, $separator);\n\n        // Lowercase if specified\n        if ($params['lowercase'] ?? true) {\n            $slug = strtolower($slug);\n        }\n\n        return $slug;\n    }\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"md5-function",children:"MD5 Function"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Generate MD5 hashes:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n  "VAR": "XPRD07",\n  "VAR_FUNCTION": "md5",\n  "VAR_PARAMS": {\n    "source": "XPRD03"\n  }\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Example:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'# Input\n{\n  "XPRD03": "PRD00001000"\n}\n\n# Output\n{\n  "XPRD03": "PRD00001000",\n  "XPRD07": "5d41402abc4b2a76b9719d911017c592"  # MD5 hash\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Implementation:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-php",children:"class PreInsertFunctions {\n    public function md5(array $params, array $record): string {\n        $source = $record[$params['source']] ?? '';\n        return md5($source);\n    }\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"sequence-function",children:"Sequence Function"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Auto-increment values:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n  "VAR": "XPRD08",\n  "VAR_FUNCTION": "sequence",\n  "VAR_PARAMS": {\n    "sequence_name": "PRD_SEQ",\n    "start": 1,\n    "step": 1\n  }\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Example:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Multiple inserts\nPOST /api/v4/core/products  # XPRD08 = 1\nPOST /api/v4/core/products  # XPRD08 = 2\nPOST /api/v4/core/products  # XPRD08 = 3\n"})}),"\n",(0,s.jsx)(e.h3,{id:"timestamp-function",children:"Timestamp Function"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Current timestamp:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n  "VAR": "XPRD09",\n  "VAR_FUNCTION": "timestamp",\n  "VAR_PARAMS": {\n    "format": "Y-m-d H:i:s"\n  }\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Example:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'# Output\n{\n  "XPRD09": "2025-12-19 10:30:00"\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"concat-function",children:"Concat Function"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Concatenate fields:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n  "VAR": "XPRD10",\n  "VAR_FUNCTION": "concat",\n  "VAR_PARAMS": {\n    "fields": ["XPRD01", "XPRD03"],\n    "separator": " - "\n  }\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Example:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'# Input\n{\n  "XPRD01": "Widget Pro",\n  "XPRD03": "PRD00001000"\n}\n\n# Output\n{\n  "XPRD10": "Widget Pro - PRD00001000"\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"default-function",children:"Default Function"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Default value if empty:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n  "VAR": "XPRD06",\n  "VAR_FUNCTION": "default",\n  "VAR_PARAMS": {\n    "value": "Y"\n  }\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Example:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'# Input (XPRD06 not provided)\n{\n  "XPRD01": "Widget"\n}\n\n# Output\n{\n  "XPRD01": "Widget",\n  "XPRD06": "Y"  # Default value\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"post-update-hooks",children:"Post-Update Hooks"}),"\n",(0,s.jsx)(e.h3,{id:"on-update-functions",children:"On Update Functions"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Execute functions on UPDATE:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n  "VAR": "UPDATED_AT",\n  "VAR_FUNCTION": "timestamp",\n  "VAR_PARAMS": {\n    "on_event": "UPDATE"\n  }\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Example:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# Update product\nPUT /api/v4/core/products/123\n\n# UPDATED_AT automatically set to current timestamp\n"})}),"\n",(0,s.jsx)(e.h3,{id:"conditional-functions",children:"Conditional Functions"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Execute only if condition met:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n  "VAR": "XPRD11",\n  "VAR_FUNCTION": "counter",\n  "VAR_PARAMS": {\n    "prefix": "REV",\n    "length": 4,\n    "condition": {\n      "field": "TREC",\n      "operator": "=",\n      "value": "M"\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Example:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# First update - TREC changes from N to M\nPUT /api/v4/core/products/123\n# XPRD11 = REV0001 (counter incremented)\n\n# Second update - TREC already M\nPUT /api/v4/core/products/123\n# XPRD11 unchanged (condition not met)\n"})}),"\n",(0,s.jsx)(e.h2,{id:"function-execution-order",children:"Function Execution Order"}),"\n",(0,s.jsx)(e.h3,{id:"pre-insert-phase",children:"Pre-Insert Phase"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"1. Validate request (token, grants, required fields)\n2. Apply context filters (source, peso, ambiente)\n3. Execute pre-insert functions (in TB_VAR order)\n4. Validate COD_ON_OFF flags\n5. Insert into TB_ANAG_{DIM}00\n6. Insert OUTBOX event\n7. Commit transaction\n"})}),"\n",(0,s.jsx)(e.h3,{id:"function-dependencies",children:"Function Dependencies"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'// XPRD04 depends on XPRD01\n{\n  "VAR": "XPRD04",\n  "VAR_FUNCTION": "slugify",\n  "VAR_PARAMS": {\n    "source": "XPRD01"\n  },\n  "VAR_ORDER": 2  // Execute after XPRD01 functions\n}\n\n// XPRD07 depends on XPRD03\n{\n  "VAR": "XPRD07",\n  "VAR_FUNCTION": "md5",\n  "VAR_PARAMS": {\n    "source": "XPRD03"\n  },\n  "VAR_ORDER": 3  // Execute after XPRD03 functions\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"custom-function-development",children:"Custom Function Development"}),"\n",(0,s.jsx)(e.h3,{id:"create-new-function",children:"Create New Function"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"1. Define function in PreInsertFunctions class:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-php",children:"class PreInsertFunctions {\n    public function customFunction(array $params, array $record): mixed {\n        // Extract parameters\n        $param1 = $params['param1'] ?? 'default';\n        $param2 = $params['param2'] ?? null;\n\n        // Business logic\n        $result = $this->processLogic($param1, $param2, $record);\n\n        return $result;\n    }\n\n    private function processLogic($param1, $param2, $record) {\n        // Implementation\n        return 'result';\n    }\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"2. Register in function registry:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-php",children:"class FunctionRegistry {\n    private $functions = [\n        'uuid' => 'uuid',\n        'md5' => 'md5',\n        'counter' => 'counter',\n        'slugify' => 'slugify',\n        'customFunction' => 'customFunction',  // New function\n    ];\n\n    public function execute($functionName, $params, $record) {\n        if (!isset($this->functions[$functionName])) {\n            throw new \\Exception(\"Unknown function: $functionName\");\n        }\n\n        $method = $this->functions[$functionName];\n        return $this->functions->$method($params, $record);\n    }\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"3. Configure in TB_VAR:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sql",children:'INSERT INTO TB_VAR (DIM_ID, VAR, VAR_FUNCTION, VAR_PARAMS)\nVALUES (5, \'XPRD12\', \'customFunction\', \'{"param1": "value1", "param2": "value2"}\');\n'})}),"\n",(0,s.jsx)(e.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsx)(e.h3,{id:"-do",children:"\u2705 DO:"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Use appropriate functions:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'// \u2705 Good - counter for codes\n{\n  "VAR": "XPRD03",\n  "VAR_FUNCTION": "counter",\n  "VAR_PARAMS": {"prefix": "PRD", "length": 8}\n}\n\n// \u2705 Good - slugify for URLs\n{\n  "VAR": "XPRD04",\n  "VAR_FUNCTION": "slugify",\n  "VAR_PARAMS": {"source": "XPRD01"}\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Define execution order:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'// \u2705 Good - explicit order\n{\n  "VAR": "XPRD04",\n  "VAR_FUNCTION": "slugify",\n  "VAR_PARAMS": {"source": "XPRD01"},\n  "VAR_ORDER": 2\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Handle errors gracefully:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-php",children:'// \u2705 Good - error handling\npublic function customFunction($params, $record) {\n    try {\n        return $this->process($params, $record);\n    } catch (\\Exception $e) {\n        logger->error("Function error: " . $e->getMessage());\n        return null;  // or default value\n    }\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"-dont",children:"\u274c DON'T:"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Don't depend on external services:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-php",children:"// \u274c Bad - external API call\npublic function fetchFromAPI($params, $record) {\n    return file_get_contents('https://external-api.com/data');\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Don't execute expensive operations:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-php",children:"// \u274c Bad - complex computation\npublic function slowFunction($params, $record) {\n    sleep(5);  // Blocks entire insert\n    return 'result';\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Don't modify other fields:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-php",children:"// \u274c Bad - side effects\npublic function badFunction($params, $record) {\n    $record['OTHER_FIELD'] = 'value';  // Don't modify other fields\n    return 'result';\n}\n"})}),"\n",(0,s.jsx)(e.h2,{id:"summary",children:"Summary"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u2705 Custom functions enable metadata-driven field initialization"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 No application code required for common operations"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 Available functions: uuid, md5, counter, slugify, sequence, timestamp, concat, default"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 Functions configured in TB_VAR metadata"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 Executed automatically by CoreWrite during INSERT/UPDATE"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 Support for dependencies and execution order"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 Extensible - create custom functions as needed"}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Key Takeaways:"})}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"Functions centralize business logic in metadata"}),"\n",(0,s.jsx)(e.li,{children:"Counter function generates formatted sequential IDs"}),"\n",(0,s.jsx)(e.li,{children:"Slugify creates URL-safe identifiers"}),"\n",(0,s.jsx)(e.li,{children:"UUID generates unique identifiers"}),"\n",(0,s.jsx)(e.li,{children:"Functions can depend on other field values"}),"\n",(0,s.jsx)(e.li,{children:"Execution order controlled by VAR_ORDER"}),"\n",(0,s.jsx)(e.li,{children:"Functions should be fast and side-effect free"}),"\n",(0,s.jsx)(e.li,{children:"Custom functions extend built-in capabilities"}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"related-concepts",children:"Related Concepts"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/counter-management",children:"Counter Management"})," - TB_COUNTER implementation"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/reference/metadata-tables#tb_var---field-definitions",children:"TB_VAR Metadata"})," - Variable configuration"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/write-patterns/create-operations",children:"Write Operations"})," - POST/PUT/PATCH"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/advanced-topics",children:"Advanced Topics"})," - Overview"]}),"\n"]})]})}function u(n={}){const{wrapper:e}={...(0,i.M)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(d,{...n})}):d(n)}},2172:(n,e,r)=>{r.d(e,{I:()=>a,M:()=>c});var s=r(1504);const i={},t=s.createContext(i);function c(n){const e=s.useContext(t);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:c(n.components),s.createElement(t.Provider,{value:e},n.children)}}}]);