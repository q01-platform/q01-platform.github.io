"use strict";(self.webpackChunkq_01_docs=self.webpackChunkq_01_docs||[]).push([[8560],{9964:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>t,default:()=>h,frontMatter:()=>l,metadata:()=>a,toc:()=>o});var s=i(7624),r=i(2172);const l={title:"Multi-Level Permissions",sidebar_label:"6. Multi-Level Permissions",sidebar_position:7,description:"Understanding Q01's defense-in-depth permission model with multiple independent validation layers"},t="Multi-Level Permissions: Defense in Depth",a={id:"products/map.q01.io/core-api-platform-v4/core-concepts/permissions",title:"Multi-Level Permissions",description:"Understanding Q01's defense-in-depth permission model with multiple independent validation layers",source:"@site/docs/products/map.q01.io/core-api-platform-v4/01-core-concepts/permissions.md",sourceDirName:"products/map.q01.io/core-api-platform-v4/01-core-concepts",slug:"/products/map.q01.io/core-api-platform-v4/core-concepts/permissions",permalink:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/permissions",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:7,frontMatter:{title:"Multi-Level Permissions",sidebar_label:"6. Multi-Level Permissions",sidebar_position:7,description:"Understanding Q01's defense-in-depth permission model with multiple independent validation layers"},sidebar:"mapSidebar",previous:{title:"4. Field Visibility (COD_ON_OFF)",permalink:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/field-visibility"},next:{title:"7. Nested Set Model",permalink:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/nested-set-model"}},d={},o=[{value:"Overview",id:"overview",level:2},{value:"Layer 1: JWT Token Validation",id:"layer-1-jwt-token-validation",level:2},{value:"Token Structure",id:"token-structure",level:3},{value:"Validation Steps",id:"validation-steps",level:3},{value:"Layer 2: Grant Level Validation (source)",id:"layer-2-grant-level-validation-source",level:2},{value:"Grant System",id:"grant-system",level:3},{value:"Grant Checking",id:"grant-checking",level:3},{value:"Create Operation (Requires Grant 4)",id:"create-operation-requires-grant-4",level:3},{value:"Update Operation (Requires Grant 2)",id:"update-operation-requires-grant-2",level:3},{value:"Insufficient Grant",id:"insufficient-grant",level:3},{value:"Layer 3: Field-Level Access (peso)",id:"layer-3-field-level-access-peso",level:2},{value:"Field Access Control via COD_UTENTE",id:"field-access-control-via-cod_utente",level:3},{value:"Filtering Query",id:"filtering-query",level:3},{value:"Response Filtering",id:"response-filtering",level:3},{value:"Layer 4: Context Visibility (COD_ON_OFF)",id:"layer-4-context-visibility-cod_on_off",level:2},{value:"Context Filtering",id:"context-filtering",level:3},{value:"Layer 5: Data Isolation (ambiente)",id:"layer-5-data-isolation-ambiente",level:2},{value:"Ambiente in JWT",id:"ambiente-in-jwt",level:3},{value:"Ambiente in Data",id:"ambiente-in-data",level:3},{value:"Automatic Filtering",id:"automatic-filtering",level:3},{value:"Write Tagging",id:"write-tagging",level:3},{value:"How Layers Work Together",id:"how-layers-work-together",level:2},{value:"Example: Product Query",id:"example-product-query",level:3},{value:"Permission Debugging",id:"permission-debugging",level:2},{value:"Common Permission Failures",id:"common-permission-failures",level:3},{value:"1. 401 Unauthorized - Layer 1 Failure",id:"1-401-unauthorized---layer-1-failure",level:4},{value:"2. 403 Forbidden - Layer 2 Failure",id:"2-403-forbidden---layer-2-failure",level:4},{value:"3. Empty Response - Layer 3 or Layer 5 Failure",id:"3-empty-response---layer-3-or-layer-5-failure",level:4},{value:"4. Missing Fields - Layer 3 or Layer 4 Failure",id:"4-missing-fields---layer-3-or-layer-4-failure",level:4},{value:"5. Validation Error - Layer 4 Failure on Write",id:"5-validation-error---layer-4-failure-on-write",level:4},{value:"Summary",id:"summary",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.M)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"multi-level-permissions-defense-in-depth",children:"Multi-Level Permissions: Defense in Depth"}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(n.p,{children:["Q01 Core APIs implement a ",(0,s.jsx)(n.strong,{children:"multi-level permission model"})," where access is validated at ",(0,s.jsx)(n.strong,{children:"5 independent layers"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Unlike traditional systems with single-point permission checks, Q01 enforces security at multiple levels ",(0,s.jsx)(n.strong,{children:"simultaneously"}),". A request must pass ALL layers to succeed."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   MULTI-LEVEL PERMISSION MODEL          \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                          \u2502\n\u2502  Layer 1: JWT Token Validation          \u2502  \u2190 Valid signature, not expired\n\u2502           \u2193 PASS                         \u2502\n\u2502  Layer 2: Grant Level (source)          \u2502  \u2190 User has access to security area\n\u2502           \u2193 PASS                         \u2502\n\u2502  Layer 3: Field-Level Access (peso)     \u2502  \u2190 User weight allows field visibility\n\u2502           \u2193 PASS                         \u2502\n\u2502  Layer 4: Context Visibility (COD_ON_OFF)\u2502  \u2190 Field visible in current context\n\u2502           \u2193 PASS                         \u2502\n\u2502  Layer 5: Data Isolation (ambiente)     \u2502  \u2190 User can access this environment\n\u2502           \u2193 PASS                         \u2502\n\u2502                                          \u2502\n\u2502  \u2705 Request Succeeds                     \u2502\n\u2502                                          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"No single permission failure exposes data"})," - this is defense in depth."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"layer-1-jwt-token-validation",children:"Layer 1: JWT Token Validation"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"What:"})," Cryptographic verification of authentication token."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When:"})," Every request, before any other processing."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Enforced By:"})," ",(0,s.jsx)(n.code,{children:"TokenValidatorSubscriber"})," (both CoreQuery and CoreWrite)"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"How it works:"})}),"\n",(0,s.jsx)(n.h3,{id:"token-structure",children:"Token Structure"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJwcm9maWxlIjoiZGV2ZWxvcGVyIiwicGVzbyI6NTAwLCJ0ZW5hbnRJZCI6IjAwMDAwUTAxLTAwMDAtMDAwMS0wMDAwLTAwMENVU1RPTUVSIiwidXNlcklkIjoidXNlcjEyMyIsImFtYmllbnRlIjoiMSwyLDMiLCJncmFudHMiOnt9fQ.signature\n"})}),"\n",(0,s.jsx)(n.p,{children:"Decoded payload:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "profile": "developer",\n  "peso": 50,\n  "tenantId": "00000Q01-0000-0001-0000-000CUSTOMER",\n  "userId": "user123",\n  "ambiente": "1,2,3",\n  "lingua": "it",\n  "grants": {\n    "productManagement": 4,\n    "salesDashboard": 2\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"validation-steps",children:"Validation Steps"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Signature Verification:"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"use Firebase\\JWT\\JWT;\n\n$decoded = JWT::decode($token, $secretKey, ['HS256']);\n// Throws exception if signature invalid\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Expiration Check:"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:'if ($decoded->exp < time()) {\n    throw new Exception("Token expired");\n}\n'})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Required Claims:"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"$requiredClaims = ['userId', 'tenantId', 'peso', 'ambiente'];\nforeach ($requiredClaims as $claim) {\n    if (!isset($decoded->$claim)) {\n        throw new Exception(\"Missing required claim: $claim\");\n    }\n}\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"4",children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Session Population:"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// Store claims in session for later use\n$session->set('userId', $decoded->userId);\n$session->set('tenantId', $decoded->tenantId);\n$session->set('peso', $decoded->peso);\n$session->set('ambiente', $decoded->ambiente);\n$session->set('profile', $decoded->profile);\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Bypass:"})," Special profiles bypass validation:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"profile=superadmin"})," - skips ALL validation (SKIP_ROUTE_VALIDATION)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"profile=service account"})," - skips validation for service-to-service calls"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Result:"})," \u2705 Pass \u2192 Continue to Layer 2 | \u274c Fail \u2192 401 Unauthorized"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"layer-2-grant-level-validation-source",children:"Layer 2: Grant Level Validation (source)"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"What:"})," Validates user has permission to access the requested security area."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When:"})," Write operations (POST/PUT/PATCH/DELETE) and most read operations."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Enforced By:"})," ",(0,s.jsx)(n.code,{children:"RequestValidatorSubscriber"})," in CoreWrite, grant checks in CoreQuery"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"How it works:"})}),"\n",(0,s.jsx)(n.h3,{id:"grant-system",children:"Grant System"}),"\n",(0,s.jsx)(n.p,{children:"TB_MENU defines security areas with required grant levels:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT COD_MENU, DESC_MENU, LIVELLO_GRANT\nFROM TB_MENU\nWHERE COD_MENU = 'productManagement';\n\n-- Result:\n-- COD_MENU: productManagement\n-- LIVELLO_GRANT: 4  (create permission required)\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Grant Levels:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Level 2:"})," Modify permission (PUT/PATCH allowed)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Level 4:"})," Create permission (POST allowed, implies level 2)"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"grant-checking",children:"Grant Checking"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"// Extract source from request\n$source = $requestData['source'];  // e.g., \"productManagement\"\n\n// Get user's grant for this source from JWT\n$grantSession = $jwtClaims['grants'][$source] ?? 0;\n\n// Get required grant level from TB_MENU\n$requiredGrant = TB_MENU::where('COD_MENU', $source)->value('LIVELLO_GRANT');\n\n// Validate\nif ($grantSession < $requiredGrant) {\n    throw new Exception(\"Insufficient permissions. Required grant level: $requiredGrant, User has: $grantSession\");\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Examples:"})}),"\n",(0,s.jsx)(n.h3,{id:"create-operation-requires-grant-4",children:"Create Operation (Requires Grant 4)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:'POST /api/v4/core/PRD\n{\n  "source": "productManagement"\n  // ...\n}\n\nJWT grants:\n{\n  "productManagement": 4  \u2705 PASS (has level 4)\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"update-operation-requires-grant-2",children:"Update Operation (Requires Grant 2)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:'PUT /api/v4/core/PRD/1\n{\n  "source": "productManagement"\n  // ...\n}\n\nJWT grants:\n{\n  "productManagement": 2  \u2705 PASS (has level 2)\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"insufficient-grant",children:"Insufficient Grant"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:'POST /api/v4/core/PRD\n{\n  "source": "productManagement"\n  // ...\n}\n\nJWT grants:\n{\n  "productManagement": 2  \u274c FAIL (needs level 4 for create)\n}\n\nResponse:\n{\n  "status": 403,\n  "message": "Insufficient permissions. Required grant level: 4, User has: 2"\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Bypass:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"skipSourceCheck=true"})," in request (only for superadmin/service accounts)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"sysuser=true"})," in session (system user bypass)"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Result:"})," \u2705 Pass \u2192 Continue to Layer 3 | \u274c Fail \u2192 403 Forbidden"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"layer-3-field-level-access-peso",children:"Layer 3: Field-Level Access (peso)"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"What:"})," Validates user's peso (permission weight) allows access to specific fields."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When:"})," Loading field metadata, building queries, filtering responses."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Enforced By:"})," CoreQuery and CoreWrite when loading TB_COST"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"How it works:"})}),"\n",(0,s.jsx)(n.h3,{id:"field-access-control-via-cod_utente",children:"Field Access Control via COD_UTENTE"}),"\n",(0,s.jsx)(n.p,{children:"TB_COST defines minimum peso required to see each field:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT COD_COST, DESC_COST, COD_UTENTE\nFROM TB_COST\nWHERE DIM_COD = 'PRD';\n\n-- Results:\n-- COD_COST      | DESC_COST     | COD_UTENTE\n-- XPRD01        | Product Name  | *          (everyone)\n-- XPRD02        | Sale Price    | *          (everyone)\n-- XPRD_COST     | Cost Price    | 50         (peso >= 50 only)\n-- XPRD_MARGIN   | Profit Margin | 90         (peso >= 90 only)\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"COD_UTENTE Values:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"*"})," - Everyone (no peso restriction)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"10"}),", ",(0,s.jsx)(n.code,{children:"50"}),", ",(0,s.jsx)(n.code,{children:"90"}),", etc. - Minimum peso required (range 0-100)"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"filtering-query",children:"Filtering Query"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- User with peso=30 queries fields\nSELECT *\nFROM TB_COST\nWHERE DIM_COD = 'PRD'\n  AND (COD_UTENTE = '*' OR CAST(COD_UTENTE AS UNSIGNED) <= 30)\nORDER BY COD_SEQUENZA;\n\n-- Returns:\n-- XPRD01 (COD_UTENTE='*') \u2705\n-- XPRD02 (COD_UTENTE='*') \u2705\n-- XPRD_COST (COD_UTENTE='50') \u274c FILTERED OUT\n-- XPRD_MARGIN (COD_UTENTE='90') \u274c FILTERED OUT\n"})}),"\n",(0,s.jsx)(n.h3,{id:"response-filtering",children:"Response Filtering"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"User with peso=30:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:'GET /api/v4/core/PRD/1\n\nResponse:\n{\n  "data": {\n    "PRD_ID": 1,\n    "XPRD01": "Widget Pro",\n    "XPRD02": 49.99\n    // XPRD_COST hidden (requires peso >= 50)\n    // XPRD_MARGIN hidden (requires peso >= 90)\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"User with peso=90:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:'GET /api/v4/core/PRD/1\n\nResponse:\n{\n  "data": {\n    "PRD_ID": 1,\n    "XPRD01": "Widget Pro",\n    "XPRD02": 49.99,\n    "XPRD_COST": 30.00,     \u2705 Now visible\n    "XPRD_MARGIN": 19.99    \u2705 Now visible\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Write Validation:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:'// User tries to set field they don\'t have access to\nPOST /api/v4/core/PRD\n{\n  "source": "productManagement",\n  "XPRD01": "Widget",\n  "XPRD_COST": 25.00  \u274c User has peso=30, field requires 50\n}\n\n// Validation fails:\nthrow new Exception("Field XPRD_COST requires peso >= 50, user has peso 30");\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Result:"})," \u2705 Pass \u2192 Field visible/writable | \u274c Fail \u2192 Field filtered out (silently)"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"layer-4-context-visibility-cod_on_off",children:"Layer 4: Context Visibility (COD_ON_OFF)"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"What:"})," Validates field is visible in current operation context (center_dett)."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When:"})," Loading fields, validating write operations."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Enforced By:"})," CoreQuery and CoreWrite when filtering fields"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"How it works:"})}),"\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/field-visibility",children:"Field Visibility - COD_ON_OFF"})," for full details."]}),"\n",(0,s.jsx)(n.h3,{id:"context-filtering",children:"Context Filtering"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- For center_dett='visualizza' (list view)\nSELECT *\nFROM TB_COST\nWHERE DIM_COD = 'PRD'\n  AND FIND_IN_SET('L', COD_ON_OFF)  -- Must have 'L' flag\n  AND (COD_UTENTE = '*' OR CAST(COD_UTENTE AS UNSIGNED) <= :peso)  -- Layer 3\nORDER BY COD_SEQUENZA;\n\n-- For center_dett='nuovo' (create form)\nSELECT *\nFROM TB_COST\nWHERE DIM_COD = 'PRD'\n  AND FIND_IN_SET('N', COD_ON_OFF)  -- Must have 'N' flag\n  AND (COD_UTENTE = '*' OR CAST(COD_UTENTE AS UNSIGNED) <= :peso)  -- Layer 3\nORDER BY COD_SEQUENZA;\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Layering with peso:"})}),"\n",(0,s.jsxs)(n.p,{children:["Field must pass ",(0,s.jsx)(n.strong,{children:"BOTH"})," COD_ON_OFF and peso filters:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Field: XPRD_COST\n- COD_ON_OFF = 'LDM'  (list, detail, modify)\n- COD_UTENTE = '50'  (requires peso >= 50)\n\nUser A (peso=90, center_dett='visualizza'):\n\u2705 Has peso >= 50 (Layer 3 pass)\n\u2705 COD_ON_OFF has 'L' (Layer 4 pass)\n\u2192 Field VISIBLE\n\nUser B (peso=30, center_dett='visualizza'):\n\u274c Peso < 50 (Layer 3 FAIL)\n\u2192 Field HIDDEN (Layer 3 filters it before Layer 4 checks)\n\nUser C (peso=90, center_dett='nuovo'):\n\u2705 Has peso >= 50 (Layer 3 pass)\n\u274c COD_ON_OFF missing 'N' (Layer 4 FAIL)\n\u2192 Field HIDDEN (not writable on create)\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Result:"})," \u2705 Pass \u2192 Field included | \u274c Fail \u2192 Field filtered out"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"layer-5-data-isolation-ambiente",children:"Layer 5: Data Isolation (ambiente)"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"What:"})," Validates user can access data from the requested environment."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When:"})," Every data query, automatically injected into WHERE clause."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Enforced By:"})," CoreQuery and CoreWrite when building SQL"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"How it works:"})}),"\n",(0,s.jsx)(n.h3,{id:"ambiente-in-jwt",children:"Ambiente in JWT"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "ambiente": "1,2,3"  // User can access environments 1, 2, and 3\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"ambiente-in-data",children:"Ambiente in Data"}),"\n",(0,s.jsxs)(n.p,{children:["Every record stores ambiente in ",(0,s.jsx)(n.code,{children:"X{DIM}01"})," field:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT PRD_ID, XPRD01, XPRD01_AMBIENTE\nFROM TB_ANAG_PRD00;\n\n-- Results:\n-- PRD_ID | XPRD01      | XPRD01_AMBIENTE\n-- 1      | Widget Pro  | 1          (prod only)\n-- 2      | Widget Dev  | 2          (staging only)\n-- 3      | Widget Test | 1,2,3      (all environments)\n"})}),"\n",(0,s.jsx)(n.h3,{id:"automatic-filtering",children:"Automatic Filtering"}),"\n",(0,s.jsx)(n.p,{children:"CoreQuery injects ambiente filter into ALL queries:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- User request:\nGET /api/v4/core/PRD\n\n-- User's ambiente from JWT: '1,2'\n\n-- CoreQuery generates:\nSELECT PRD_ID, XPRD01, XPRD02\nFROM TB_ANAG_PRD00\nWHERE FIND_IN_SET('1', XPRD01_AMBIENTE) OR FIND_IN_SET('2', XPRD01_AMBIENTE)\n-- Filters to records accessible in environments 1 or 2\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"User sees:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "data": [\n    {"PRD_ID": 1, "XPRD01": "Widget Pro"},      // ambiente=\'1\' \u2705\n    {"PRD_ID": 3, "XPRD01": "Widget Test"}      // ambiente=\'1,2,3\' \u2705\n    // Widget Dev (ambiente=\'2\' only) \u2705 also visible\n  ]\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"User with ambiente='3' sees:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "data": [\n    {"PRD_ID": 3, "XPRD01": "Widget Test"}  // ambiente=\'1,2,3\' \u2705\n    // Widget Pro (ambiente=\'1\') \u274c HIDDEN\n    // Widget Dev (ambiente=\'2\') \u274c HIDDEN\n  ]\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"write-tagging",children:"Write Tagging"}),"\n",(0,s.jsx)(n.p,{children:"CoreWrite automatically tags new records with user's ambiente:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:'// User creates product with ambiente=\'1,2\'\nPOST /api/v4/core/PRD\n{\n  "source": "productManagement",\n  "XPRD01": "New Widget"\n}\n\n// CoreWrite generates:\nINSERT INTO TB_ANAG_PRD00 (\n  XPRD01,\n  XPRD01_AMBIENTE  -- Auto-populated\n) VALUES (\n  \'New Widget\',\n  \'1,2\'  // From JWT ambiente\n);\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Result:"})," \u2705 Pass \u2192 Data visible | \u274c Fail \u2192 Data filtered out (silently)"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"how-layers-work-together",children:"How Layers Work Together"}),"\n",(0,s.jsx)(n.h3,{id:"example-product-query",children:"Example: Product Query"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Request:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-http",children:"GET /api/v4/core/PRD/1?source=productDetail&center_dett=dettaglio\n\nAuthorization: Bearer eyJ...\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"JWT Claims:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "userId": "user123",\n  "peso": 50,\n  "ambiente": "1,2",\n  "profile": "manager",\n  "grants": {\n    "productDetail": 2\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Validation Flow:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Layer 1: JWT Validation\n\u251c\u2500 Verify signature \u2705\n\u251c\u2500 Check expiration \u2705\n\u251c\u2500 Extract claims \u2705\n\u2514\u2500 Result: PASS\n\nLayer 2: Grant Validation\n\u251c\u2500 source = 'productDetail'\n\u251c\u2500 Required grant: 2 (from TB_MENU)\n\u251c\u2500 User grant: 2 (from JWT)\n\u2514\u2500 Result: PASS (2 >= 2)\n\nLayer 3: Field-Level Access (peso=50)\n\u251c\u2500 Load TB_COST for DIM='PRD'\n\u251c\u2500 Filter: COD_UTENTE='*' OR COD_UTENTE <= 50\n\u251c\u2500 Fields visible: XPRD01(*), XPRD02(*), XPRD_COST(50)\n\u251c\u2500 Fields hidden: XPRD_MARGIN(90)\n\u2514\u2500 Result: PASS (some fields filtered)\n\nLayer 4: Context Visibility (center_dett='dettaglio')\n\u251c\u2500 Filter remaining fields by COD_ON_OFF\n\u251c\u2500 Must have 'D' or 'L' flag\n\u251c\u2500 XPRD01 (COD_ON_OFF='L,D,N,M,R') \u2705\n\u251c\u2500 XPRD02 (COD_ON_OFF='L,D,N,M,R') \u2705\n\u251c\u2500 XPRD_COST (COD_ON_OFF='LDM') \u2705\n\u2514\u2500 Result: PASS\n\nLayer 5: Data Isolation (ambiente='1,2')\n\u251c\u2500 Build WHERE clause\n\u251c\u2500 WHERE FIND_IN_SET('1', XPRD01_AMBIENTE) OR FIND_IN_SET('2', XPRD01_AMBIENTE)\n\u251c\u2500 Record 1: XPRD01_AMBIENTE='1' \u2705\n\u2514\u2500 Result: PASS\n\nFinal Query:\nSELECT PRD_ID, XPRD01, XPRD02, XPRD_COST\nFROM TB_ANAG_PRD00\nWHERE PRD_ID = 1\n  AND (FIND_IN_SET('1', XPRD01_AMBIENTE) OR FIND_IN_SET('2', XPRD01_AMBIENTE))\n\nResponse:\n{\n  \"data\": {\n    \"PRD_ID\": 1,\n    \"XPRD01\": \"Widget Pro\",\n    \"XPRD02\": 49.99,\n    \"XPRD_COST\": 30.00\n    // XPRD_MARGIN filtered by peso (Layer 3)\n  }\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"All 5 layers enforced independently"})," - failure at any layer blocks access."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"permission-debugging",children:"Permission Debugging"}),"\n",(0,s.jsx)(n.h3,{id:"common-permission-failures",children:"Common Permission Failures"}),"\n",(0,s.jsx)(n.h4,{id:"1-401-unauthorized---layer-1-failure",children:"1. 401 Unauthorized - Layer 1 Failure"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'{\n  "status": 401,\n  "message": "Invalid or expired token"\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cause:"})," JWT signature invalid, token expired, or missing required claims."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Fix:"})," Refresh JWT token, ensure all claims present."]}),"\n",(0,s.jsx)(n.h4,{id:"2-403-forbidden---layer-2-failure",children:"2. 403 Forbidden - Layer 2 Failure"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'{\n  "status": 403,\n  "message": "Insufficient permissions. Required grant level: 4, User has: 2"\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cause:"})," User's grant for source is insufficient."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Fix:"})," Ensure JWT contains correct grant level for the source, or use different source."]}),"\n",(0,s.jsx)(n.h4,{id:"3-empty-response---layer-3-or-layer-5-failure",children:"3. Empty Response - Layer 3 or Layer 5 Failure"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'{\n  "data": []\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cause:"})," All fields filtered by peso (Layer 3) or all data filtered by ambiente (Layer 5)."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Fix:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Layer 3: Increase user's peso or lower field's COD_UTENTE"}),"\n",(0,s.jsx)(n.li,{children:"Layer 5: Add user's ambiente to record's XDIM01_AMBIENTE"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"4-missing-fields---layer-3-or-layer-4-failure",children:"4. Missing Fields - Layer 3 or Layer 4 Failure"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'{\n  "data": {\n    "PRD_ID": 1,\n    "XPRD01": "Widget"\n    // XPRD_COST missing\n  }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cause:"})," Field filtered by peso or COD_ON_OFF."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Fix:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Layer 3: Increase user's peso"}),"\n",(0,s.jsx)(n.li,{children:"Layer 4: Add appropriate flag to COD_ON_OFF or use correct center_dett"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"5-validation-error---layer-4-failure-on-write",children:"5. Validation Error - Layer 4 Failure on Write"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'{\n  "status": 400,\n  "message": "Field XPRD_COST not writable on create (missing \'N\' in COD_ON_OFF)"\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cause:"})," Trying to write field not allowed in current context."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Fix:"})," Remove field from request or add appropriate COD_ON_OFF flag."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Q01's Multi-Level Permission Model:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Layer"}),(0,s.jsx)(n.th,{children:"What"}),(0,s.jsx)(n.th,{children:"Enforced By"}),(0,s.jsx)(n.th,{children:"Failure Result"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"1. JWT Validation"})}),(0,s.jsx)(n.td,{children:"Token signature, expiration"}),(0,s.jsx)(n.td,{children:"TokenValidatorSubscriber"}),(0,s.jsx)(n.td,{children:"401 Unauthorized"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"2. Grant Level"})}),(0,s.jsx)(n.td,{children:"Source permission (2 or 4)"}),(0,s.jsx)(n.td,{children:"RequestValidatorSubscriber"}),(0,s.jsx)(n.td,{children:"403 Forbidden"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"3. Field Access (peso)"})}),(0,s.jsx)(n.td,{children:"User weight vs COD_UTENTE"}),(0,s.jsx)(n.td,{children:"Field loading in Modules"}),(0,s.jsx)(n.td,{children:"Silent field filtering"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"4. Context Visibility"})}),(0,s.jsx)(n.td,{children:"COD_ON_OFF vs center_dett"}),(0,s.jsx)(n.td,{children:"Field loading in Modules"}),(0,s.jsx)(n.td,{children:"Silent field filtering"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"5. Data Isolation"})}),(0,s.jsx)(n.td,{children:"Ambiente matching"}),(0,s.jsx)(n.td,{children:"SQL WHERE clause"}),(0,s.jsx)(n.td,{children:"Silent data filtering"})]})]})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Defense in Depth:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"No single layer failure exposes unauthorized data"}),"\n",(0,s.jsx)(n.li,{children:"Each layer independently validated"}),"\n",(0,s.jsx)(n.li,{children:"Attackers must bypass ALL layers to gain access"}),"\n",(0,s.jsx)(n.li,{children:"Failures at different layers produce different errors (aids debugging)"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Best Practices:"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"\u2705 Include all required JWT claims"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Set appropriate grants in JWT for user's role"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Configure COD_UTENTE based on data sensitivity"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Use correct COD_ON_OFF flags for field visibility"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Tag data with appropriate ambiente values"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Next Concept:"})}),"\n",(0,s.jsxs)(n.p,{children:["\u2192 Continue to ",(0,s.jsx)(n.a,{href:"/docs/products/map.q01.io/core-api-platform-v4/core-concepts/entity-lifecycle",children:"Entity Lifecycle - TREC"})," to understand record state management."]})]})}function h(e={}){const{wrapper:n}={...(0,r.M)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},2172:(e,n,i)=>{i.d(n,{I:()=>a,M:()=>t});var s=i(1504);const r={},l=s.createContext(r);function t(e){const n=s.useContext(l);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);